<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>PrintFarm Mini App v2.6.7</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --pf-bg:#f1f2f6;
      --pf-card:#ffffff;
      --pf-divider:rgba(0,0,0,.08);
      --pf-text:#111827;
      --pf-sub:#6b7280;
      --pf-accent:#2f6bff;
      --pf-good:#00c853;
      --pf-warn:#ffb300;
      --pf-bad:#ff3b30;
      --pf-purple:#7c3aed;
      --pf-cyan:#06b6d4;
      --pf-shadow:0 8px 24px rgba(0,0,0,.06);
      --pf-radius:12px;
      --pf-safe-bottom: env(safe-area-inset-bottom, 0px);
      --pf-safe-top: env(safe-area-inset-top, 0px);
    }

    html, body { height: 100%; }
    body{
      background: var(--pf-bg);
      color: var(--pf-text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior: none;
    }

    /* iOS/Telegram-like blocks */
    .pf-card{
      background: var(--pf-card);
      border-radius: var(--pf-radius);
      box-shadow: var(--pf-shadow);
    }
    .pf-divider{ border-top: 1px solid var(--pf-divider); }

    /* Bottom bar */
    .pf-bottom-bar{
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      padding-bottom: calc(10px + var(--pf-safe-bottom));
      padding-top: 10px;
      background: rgba(255,255,255,.75);
      border-top: 1px solid rgba(0,0,0,.06);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      z-index: 50;
    }
    .pf-icon{
      width: 24px;
      height: 24px;
      display: inline-block;
    }

    .pf-tab-btn[aria-selected="true"] .pf-tab-label{ color: var(--pf-accent); }
    .pf-tab-btn[aria-selected="true"] svg{ color: var(--pf-accent); }
    .pf-tab-btn[aria-selected="false"] svg{ color: rgba(17,24,39,.55); }

    /* Modals */
    .pf-modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.25);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 60;
    }
    .pf-modal-backdrop[data-open="true"]{ display: flex; }
    .pf-modal{
      width: 100%;
      max-width: 720px;
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
      background: var(--pf-card);
      padding: 14px 14px calc(14px + var(--pf-safe-bottom));
      box-shadow: 0 -14px 34px rgba(0,0,0,.18);
    }

    /* Skeleton */
    .pf-skeleton{
      background: linear-gradient(90deg, rgba(0,0,0,.06), rgba(0,0,0,.03), rgba(0,0,0,.06));
      background-size: 200% 100%;
      animation: pfShimmer 1.25s infinite;
      border-radius: 10px;
    }
    @keyframes pfShimmer{ 0%{ background-position: 0% 0; } 100%{ background-position: 200% 0; } }

    /* Status pills (neon-ish) */
    .pf-pill{
      border-radius: 999px;
      padding: 4px 10px;
      font-weight: 600;
      font-size: 12px;
      letter-spacing: .2px;
    }
    .pf-pill--good{ background: rgba(0,200,83,.12); color: #067a34; border: 1px solid rgba(0,200,83,.22); }
    .pf-pill--warn{ background: rgba(255,179,0,.14); color: #8a5a00; border: 1px solid rgba(255,179,0,.22); }
    .pf-pill--bad{ background: rgba(255,59,48,.12); color: #a61a12; border: 1px solid rgba(255,59,48,.22); }
    .pf-pill--info{ background: rgba(47,107,255,.12); color: #1d46aa; border: 1px solid rgba(47,107,255,.22); }

    /* Settings icons with colored rounded background (like iOS) */
    .pf-setting-icon{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      flex: 0 0 auto;
    }

    /* Tap highlight */
    .pf-tap{ -webkit-tap-highlight-color: transparent; }

    /* Ensure content not hidden behind bottom bar */
    .pf-main{ padding-bottom: 90px; }

    /* Tiny toast */
    .pf-toast-wrap{
      position: fixed;
      left: 0; right: 0;
      top: calc(10px + var(--pf-safe-top));
      display: flex;
      justify-content: center;
      pointer-events: none;
      z-index: 70;
    }
    .pf-toast{
      pointer-events: auto;
      background: rgba(17,24,39,.92);
      color: white;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      max-width: min(680px, calc(100% - 24px));
      font-size: 13px;
      line-height: 1.3;
      display: none;
    }
    .pf-toast[data-open="true"]{ display: block; }

    /* Small badge */
    .pf-badge{
      font-size: 11px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(124,58,237,.12);
      border: 1px solid rgba(124,58,237,.22);
      color: #5b21b6;
    }
  </style>
</head>
<body class="pf-tap">
  <div class="pf-toast-wrap">
    <div id="toast" class="pf-toast" role="status" aria-live="polite"></div>
  </div>

  <div class="max-w-3xl mx-auto px-3">
    <!-- Header -->
    <header class="pt-4" style="padding-top: calc(16px + var(--pf-safe-top));">
      <div class="flex items-center justify-between">
        <div class="min-w-0">
          <div class="text-[15px] font-semibold tracking-tight">PrintFarm</div>
          <div id="subtitle" class="text-xs text-gray-500 truncate">Экосистема управления 3D‑фермой</div>
        </div>
        <div class="flex items-center gap-2">
          <button id="filterBtn" class="pf-card px-3 py-2 flex items-center gap-2" title="Сортировка и фильтры">
            <span class="text-sm font-semibold">Фильтр</span>
            <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 6h16M7 12h10M10 18h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <button id="refreshBtn" class="pf-card px-3 py-2 flex items-center gap-2" title="Обновить">
            <span class="text-sm font-semibold">Обновить</span>
            <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M20 12a8 8 0 1 1-2.34-5.66" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M20 4v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="mt-3 pf-card px-3 py-2 flex items-center gap-2">
        <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M10.5 17a6.5 6.5 0 1 1 0-13 6.5 6.5 0 0 1 0 13Z" stroke="currentColor" stroke-width="2"/>
          <path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <input id="searchInput" class="w-full bg-transparent outline-none text-sm" placeholder="Поиск: принтер, заказ, модель…" autocomplete="off" />
        <button id="clearSearch" class="text-sm text-gray-500 px-2 py-1 rounded-lg hover:bg-black/5" title="Очистить">Сброс</button>
      </div>

      <div id="banner" class="mt-3 hidden">
        <div class="pf-card px-3 py-2 flex items-start gap-2">
          <div class="mt-[2px]">
            <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 9v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
              <path d="M10.29 3.86 2.82 17.18A2 2 0 0 0 4.55 20h14.9a2 2 0 0 0 1.73-2.82L13.71 3.86a2 2 0 0 0-3.42 0Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="min-w-0">
            <div class="text-sm font-semibold">API недоступно</div>
            <div class="text-xs text-gray-500">Показаны демо‑данные. Для реальных данных требуется backend и эндпоинт <code class="px-1 py-[1px] rounded bg-black/5">POST /api/bootstrap</code>.</div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="pf-main mt-4" id="main">
      <!-- Tabs -->
      <section id="tab-printers" class="tab-pane"></section>
      <section id="tab-work" class="tab-pane hidden"></section>
      <section id="tab-profile" class="tab-pane hidden"></section>

      <!-- Initial loading skeleton -->
      <section id="loading" class="space-y-3">
        <div class="pf-card p-4">
          <div class="h-4 w-48 pf-skeleton"></div>
          <div class="mt-3 h-3 w-64 pf-skeleton"></div>
          <div class="mt-2 h-3 w-52 pf-skeleton"></div>
        </div>
        <div class="pf-card p-4">
          <div class="h-4 w-40 pf-skeleton"></div>
          <div class="mt-3 grid grid-cols-2 gap-3">
            <div class="h-16 pf-skeleton"></div>
            <div class="h-16 pf-skeleton"></div>
          </div>
        </div>
        <div class="pf-card p-4">
          <div class="h-4 w-56 pf-skeleton"></div>
          <div class="mt-3 h-20 pf-skeleton"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- Bottom bar -->
  <nav class="pf-bottom-bar">
    <div class="max-w-3xl mx-auto px-6">
      <div class="grid grid-cols-3 gap-2">
        <button class="pf-tab-btn flex flex-col items-center justify-center gap-1" data-tab="printers" aria-selected="true">
          <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 7V4a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v3" stroke="currentColor" stroke-width="2"/>
            <path d="M7 17h10v5H7v-5Z" stroke="currentColor" stroke-width="2"/>
            <path d="M6 7h12a4 4 0 0 1 4 4v4a2 2 0 0 1-2 2h-3v-4H7v4H4a2 2 0 0 1-2-2v-4a4 4 0 0 1 4-4Z" stroke="currentColor" stroke-width="2"/>
          </svg>
          <div class="pf-tab-label text-[11px] font-semibold text-gray-500">Принтеры</div>
        </button>
        <button class="pf-tab-btn flex flex-col items-center justify-center gap-1" data-tab="work" aria-selected="false">
          <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M9 7h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M9 11h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M7 3h10a2 2 0 0 1 2 2v16l-7-3-7 3V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
          <div class="pf-tab-label text-[11px] font-semibold text-gray-500">Заказы</div>
        </button>
        <button class="pf-tab-btn flex flex-col items-center justify-center gap-1" data-tab="profile" aria-selected="false">
          <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M20 21a8 8 0 1 0-16 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="2"/>
          </svg>
          <div class="pf-tab-label text-[11px] font-semibold text-gray-500">Профиль</div>
        </button>
      </div>
    </div>
  </nav>

  <!-- Filter modal -->
  <div id="filterModal" class="pf-modal-backdrop" role="dialog" aria-modal="true" aria-label="Сортировка и фильтры">
    <div class="pf-modal">
      <div class="flex items-center justify-between">
        <div class="text-base font-semibold">Сортировка и фильтры</div>
        <button id="closeFilter" class="px-3 py-2 rounded-xl hover:bg-black/5">Закрыть</button>
      </div>

      <div class="mt-3 pf-divider"></div>

      <div class="mt-3 grid gap-3">
        <div>
          <div class="text-sm font-semibold">Принтеры</div>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <button class="pf-card px-3 py-2 text-left" data-filter="printer_size" data-value="all">
              <div class="text-sm font-semibold">Все</div>
              <div class="text-xs text-gray-500">Без ограничения по столу</div>
            </button>
            <button class="pf-card px-3 py-2 text-left" data-filter="printer_size" data-value="small">
              <div class="text-sm font-semibold">Маленькие</div>
              <div class="text-xs text-gray-500">Меньшая площадь стола</div>
            </button>
            <button class="pf-card px-3 py-2 text-left" data-filter="printer_size" data-value="big">
              <div class="text-sm font-semibold">Большие</div>
              <div class="text-xs text-gray-500">Большая площадь стола</div>
            </button>
            <button class="pf-card px-3 py-2 text-left" data-filter="printer_size" data-value="xl">
              <div class="text-sm font-semibold">XL</div>
              <div class="text-xs text-gray-500">Максимальная площадь стола</div>
            </button>
          </div>
        </div>

        <div>
          <div class="text-sm font-semibold">Модели</div>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <button class="pf-card px-3 py-2 text-left" data-filter="model_sort" data-value="volume_desc">
              <div class="text-sm font-semibold">По объёму</div>
              <div class="text-xs text-gray-500">Сначала самые объёмные</div>
            </button>
            <button class="pf-card px-3 py-2 text-left" data-filter="model_sort" data-value="volume_asc">
              <div class="text-sm font-semibold">По объёму (↑)</div>
              <div class="text-xs text-gray-500">Сначала компактные</div>
            </button>
          </div>
        </div>

        <div>
          <div class="text-sm font-semibold">Приоритет</div>
          <div class="mt-2 pf-card px-3 py-3">
            <label class="flex items-center justify-between gap-3">
              <div class="min-w-0">
                <div class="text-sm font-semibold">Заказы приоритетнее моделей</div>
                <div class="text-xs text-gray-500">Отображать заказы первыми (логика v2.6.7)</div>
              </div>
              <input id="ordersFirst" type="checkbox" class="h-5 w-5" checked />
            </label>
          </div>
        </div>

        <div class="flex gap-2">
          <button id="applyFilters" class="flex-1 pf-card px-3 py-3 font-semibold" style="border: 1px solid rgba(47,107,255,.22); background: rgba(47,107,255,.08); color: #1d46aa;">Применить</button>
          <button id="resetFilters" class="pf-card px-3 py-3 font-semibold">Сбросить</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    'use strict';

    /**
     * PrintFarm Mini App (демо-фронтенд)
     * 
     * Важное:
     * 1) USE_MOCK = false — данные запрашиваются с backend через POST /api/bootstrap
     * 2) При недоступности API включается безопасный fallback на демо-датасет, чтобы UI оставался работоспособным.
     * 
     * В реальном проекте сюда подключаются:
     * - FastAPI backend, который возвращает актуальные данные по принтерам/заказам/моделям/подписке
     * - Авторизация через Telegram initData
     */

    const APP_VERSION = '2.6.7';
    const DEV_HANDLE = '@ТвойНик';
    const DONATE_URL = 'https://example.com/donate';

    // Требование: USE_MOCK = false.
    const USE_MOCK = false;
    const API_BASE = '';

    const state = {
      bootstrapped: false,
      isDemo: false,
      isAdmin: false,
      user: {
        id: null,
        first_name: 'Пользователь',
        last_name: '',
        username: '',
        photo_url: ''
      },
      subscription: { plan: 'FREE', limit_printers: 1, expires_at: null },
      printers: [],
      models: [],
      orders: [],
      ui: {
        activeTab: 'printers',
        search: '',
        filters: {
          printer_size: 'all',
          model_sort: 'volume_desc',
          ordersFirst: true,
        }
      }
    };

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function safeText(v){
      if (v === null || v === undefined) return '';
      return String(v);
    }

    function toast(message, opts={}){
      const el = $('#toast');
      if (!el) return;
      const ms = typeof opts.ms === 'number' ? opts.ms : 2600;
      el.textContent = safeText(message);
      el.dataset.open = 'true';
      window.clearTimeout(toast._t);
      toast._t = window.setTimeout(() => { el.dataset.open = 'false'; }, ms);
    }

    function fmtMm(v){
      const n = Number(v);
      if (!Number.isFinite(n)) return '—';
      return `${Math.round(n*10)/10} мм`;
    }

    function fmtCm3(v){
      const n = Number(v);
      if (!Number.isFinite(n)) return '—';
      return `${Math.round(n*10)/10} см³`;
    }

    function fmtHours(seconds){
      const s = Number(seconds);
      if (!Number.isFinite(s) || s < 0) return '—';
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      return `${h} ч ${String(m).padStart(2,'0')} мин`;
    }

    function fmtDateTime(iso){
      if (!iso) return '—';
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return '—';
      return d.toLocaleString('ru-RU', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    }

    function getTelegramUser(){
      try{
        const tg = window.Telegram?.WebApp;
        const user = tg?.initDataUnsafe?.user;
        if (!user) return null;
        return {
          id: user.id ?? null,
          first_name: user.first_name ?? 'Пользователь',
          last_name: user.last_name ?? '',
          username: user.username ?? '',
          photo_url: user.photo_url ?? ''
        };
      } catch {
        return null;
      }
    }

    function applyTelegramChrome(){
      const tg = window.Telegram?.WebApp;
      try{
        tg?.ready?.();
        tg?.expand?.();
        // Нативное ощущение: отключаем свайп-бэк внутри WebView
        tg?.disableVerticalSwipes?.();
      } catch {
        // игнорируем: в браузере API нет
      }

      try{
        const theme = tg?.themeParams;
        // Если тема тёмная — слегка адаптируем, но сохраняем Telegram Native 2024 стилистику.
        if (tg?.colorScheme === 'dark'){
          document.documentElement.style.setProperty('--pf-bg', '#0f1115');
          document.documentElement.style.setProperty('--pf-card', '#161a22');
          document.documentElement.style.setProperty('--pf-divider', 'rgba(255,255,255,.08)');
          document.documentElement.style.setProperty('--pf-text', '#e5e7eb');
          document.documentElement.style.setProperty('--pf-sub', '#9ca3af');
          document.querySelector('.pf-bottom-bar')?.style?.setProperty('background', 'rgba(22,26,34,.72)');
        }

        // Акцент можно подхватить из темы Telegram (если задан), но не навязчиво.
        const link = theme?.link_color;
        if (link && typeof link === 'string'){
          document.documentElement.style.setProperty('--pf-accent', link);
        }
      } catch {
        // ignore
      }
    }

    function demoData(){
      return {
        version: APP_VERSION,
        server_time: new Date().toISOString(),
        is_admin: true,
        subscription: { plan: 'PRO', limit_printers: 5, expires_at: null },
        printers: [
          {
            id: 'p1',
            name: 'Bambu Lab X1C',
            model: 'Bambu X1 Carbon',
            bed_x: 256, bed_y: 256, bed_z: 256,
            nozzle: 0.4,
            status: 'printing',
            status_label: 'Печатает',
            current_job: { title: 'Заказ #1042 — Крепёж', eta_sec: 2*3600 + 15*60, progress: 0.62 },
            updated_at: new Date(Date.now()-2*60*1000).toISOString(),
          },
          {
            id: 'p2',
            name: 'Prusa MK4',
            model: 'Original Prusa MK4',
            bed_x: 250, bed_y: 210, bed_z: 220,
            nozzle: 0.4,
            status: 'idle',
            status_label: 'Свободен',
            current_job: null,
            updated_at: new Date(Date.now()-25*60*1000).toISOString(),
          },
          {
            id: 'p3',
            name: 'Voron 2.4 (350)',
            model: 'Voron 2.4',
            bed_x: 350, bed_y: 350, bed_z: 350,
            nozzle: 0.6,
            status: 'error',
            status_label: 'Ошибка',
            current_job: { title: 'Модель: Корпус', eta_sec: null, progress: 0.18 },
            updated_at: new Date(Date.now()-5*60*1000).toISOString(),
          }
        ],
        orders: [
          {
            id: 'o1042',
            title: 'Заказ #1042',
            customer: 'ООО «ТехПром»',
            priority: 10,
            remaining_qty: 7,
            model_ref: 'm2',
            notes: 'Срочно. Пластик PETG. Цвет — чёрный.',
            created_at: new Date(Date.now()-2*24*3600*1000).toISOString(),
          },
          {
            id: 'o1041',
            title: 'Заказ #1041',
            customer: 'Частный клиент',
            priority: 5,
            remaining_qty: 1,
            model_ref: 'm1',
            notes: 'Серый. Без постобработки.',
            created_at: new Date(Date.now()-4*24*3600*1000).toISOString(),
          }
        ],
        models: [
          {
            id: 'm1',
            title: 'Кронштейн усиленный',
            kind: 'stl',
            volume_cm3: 24.1,
            bbox_mm: { x: 118.2, y: 36.4, z: 42.0 },
            est_time_sec: 1*3600 + 10*60,
            est_weight_g: 31,
            created_at: new Date(Date.now()-10*24*3600*1000).toISOString(),
          },
          {
            id: 'm2',
            title: 'Крепёжная клипса (партия)',
            kind: 'gcode',
            volume_cm3: 3.8,
            bbox_mm: { x: 28.0, y: 18.0, z: 8.0 },
            est_time_sec: 22*60,
            est_weight_g: 6,
            created_at: new Date(Date.now()-3*24*3600*1000).toISOString(),
          },
          {
            id: 'm3',
            title: 'Корпус электроники',
            kind: 'stl',
            volume_cm3: 312.6,
            bbox_mm: { x: 240.0, y: 190.0, z: 120.0 },
            est_time_sec: 13*3600 + 40*60,
            est_weight_g: 420,
            created_at: new Date(Date.now()-1*24*3600*1000).toISOString(),
          }
        ]
      };
    }

    async function postJSON(url, body, timeoutMs=12000){
      const ctrl = new AbortController();
      const t = window.setTimeout(() => ctrl.abort(), timeoutMs);
      try{
        const r = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body ?? {}),
          signal: ctrl.signal,
        });
        const ct = r.headers.get('content-type') || '';
        const isJson = ct.includes('application/json');
        const data = isJson ? await r.json() : await r.text();
        return { ok: r.ok, status: r.status, data };
      } finally {
        window.clearTimeout(t);
      }
    }

    function normalizeBootstrap(payload){
      const out = {
        version: safeText(payload?.version || APP_VERSION),
        server_time: payload?.server_time || new Date().toISOString(),
        is_admin: Boolean(payload?.is_admin),
        subscription: payload?.subscription || { plan: 'FREE', limit_printers: 1, expires_at: null },
        printers: Array.isArray(payload?.printers) ? payload.printers : [],
        models: Array.isArray(payload?.models) ? payload.models : [],
        orders: Array.isArray(payload?.orders) ? payload.orders : [],
      };
      // Мягкие нормализации, чтобы UI не падал от грязных данных.
      out.printers = out.printers.map(p => ({
        id: safeText(p?.id || crypto.randomUUID()),
        name: safeText(p?.name || 'Принтер'),
        model: safeText(p?.model || 'Неизвестная модель'),
        bed_x: Number(p?.bed_x ?? 0),
        bed_y: Number(p?.bed_y ?? 0),
        bed_z: Number(p?.bed_z ?? 0),
        nozzle: Number(p?.nozzle ?? 0.4),
        status: safeText(p?.status || 'idle'),
        status_label: safeText(p?.status_label || 'Статус'),
        current_job: p?.current_job ? {
          title: safeText(p.current_job.title || 'Задание'),
          eta_sec: p.current_job.eta_sec === null || p.current_job.eta_sec === undefined ? null : Number(p.current_job.eta_sec),
          progress: Number(p.current_job.progress ?? 0),
        } : null,
        updated_at: p?.updated_at || null,
      }));

      out.models = out.models.map(m => ({
        id: safeText(m?.id || crypto.randomUUID()),
        title: safeText(m?.title || 'Модель'),
        kind: safeText(m?.kind || 'stl'),
        volume_cm3: Number(m?.volume_cm3 ?? NaN),
        bbox_mm: {
          x: Number(m?.bbox_mm?.x ?? NaN),
          y: Number(m?.bbox_mm?.y ?? NaN),
          z: Number(m?.bbox_mm?.z ?? NaN),
        },
        est_time_sec: Number(m?.est_time_sec ?? NaN),
        est_weight_g: Number(m?.est_weight_g ?? NaN),
        created_at: m?.created_at || null,
      }));

      out.orders = out.orders.map(o => ({
        id: safeText(o?.id || crypto.randomUUID()),
        title: safeText(o?.title || 'Заказ'),
        customer: safeText(o?.customer || ''),
        priority: Number(o?.priority ?? 0),
        remaining_qty: Number(o?.remaining_qty ?? 0),
        model_ref: safeText(o?.model_ref || ''),
        notes: safeText(o?.notes || ''),
        created_at: o?.created_at || null,
      }));

      return out;
    }

    async function bootstrap(){
      // Пользователь Telegram (если доступно)
      const tgUser = getTelegramUser();
      if (tgUser){
        state.user = { ...state.user, ...tgUser };
      }

      const request = {
        // В реальном backend: initData используется для проверки подписи.
        initData: safeText(window.Telegram?.WebApp?.initData || ''),
        client: {
          version: APP_VERSION,
          tz: Intl.DateTimeFormat().resolvedOptions().timeZone || null,
          locale: navigator.language || 'ru-RU',
          userAgent: navigator.userAgent,
        }
      };

      if (!USE_MOCK){
        try{
          const res = await postJSON(`${API_BASE}/api/bootstrap`, request);
          if (res.ok && res.data && typeof res.data === 'object'){
            const norm = normalizeBootstrap(res.data);
            state.isDemo = false;
            state.isAdmin = Boolean(norm.is_admin);
            state.subscription = norm.subscription;
            state.printers = norm.printers;
            state.models = norm.models;
            state.orders = norm.orders;
            state.bootstrapped = true;
            $('#banner')?.classList.add('hidden');
            return;
          }
          // Если backend ответил ошибкой/не JSON — включаем безопасный fallback.
          console.warn('Bootstrap failed:', res.status, res.data);
        } catch (e){
          console.warn('Bootstrap exception:', e);
        }
      }

      const demo = normalizeBootstrap(demoData());
      state.isDemo = true;
      state.isAdmin = Boolean(demo.is_admin);
      state.subscription = demo.subscription;
      state.printers = demo.printers;
      state.models = demo.models;
      state.orders = demo.orders;
      state.bootstrapped = true;
      $('#banner')?.classList.remove('hidden');
    }

    function bedArea(p){
      const x = Number(p?.bed_x);
      const y = Number(p?.bed_y);
      if (!Number.isFinite(x) || !Number.isFinite(y)) return NaN;
      return x * y;
    }

    function matchesSearch(text, q){
      if (!q) return true;
      const t = safeText(text).toLowerCase();
      const qq = safeText(q).trim().toLowerCase();
      if (!qq) return true;
      return t.includes(qq);
    }

    function filterPrinters(list){
      const q = state.ui.search;
      const size = state.ui.filters.printer_size;

      let out = list.filter(p => {
        const blob = `${p.name} ${p.model} ${p.status_label}`;
        return matchesSearch(blob, q);
      });

      // Размер по площади стола.
      if (size !== 'all'){
        out = out.filter(p => {
          const a = bedArea(p);
          if (!Number.isFinite(a)) return false;
          // Эвристика: small <= 52k, big 52k-100k, xl > 100k
          if (size === 'small') return a <= 52000;
          if (size === 'big') return a > 52000 && a <= 100000;
          if (size === 'xl') return a > 100000;
          return true;
        });
      }

      // Стабильная сортировка: печатающие выше, затем свободные, затем ошибки.
      const rank = (s) => {
        if (s === 'printing') return 0;
        if (s === 'idle') return 1;
        if (s === 'paused') return 2;
        if (s === 'error') return 3;
        return 9;
      };
      out = out.slice().sort((a,b) => {
        const ra = rank(a.status);
        const rb = rank(b.status);
        if (ra !== rb) return ra - rb;
        return safeText(a.name).localeCompare(safeText(b.name), 'ru');
      });

      return out;
    }

    function sortModels(list){
      const q = state.ui.search;
      const sort = state.ui.filters.model_sort;

      let out = list.filter(m => {
        const blob = `${m.title} ${m.kind}`;
        return matchesSearch(blob, q);
      });

      out = out.slice().sort((a,b) => {
        const av = Number(a.volume_cm3);
        const bv = Number(b.volume_cm3);
        const aOk = Number.isFinite(av);
        const bOk = Number.isFinite(bv);
        if (aOk !== bOk) return aOk ? -1 : 1; // известные объёмы выше
        if (!aOk && !bOk) return safeText(a.title).localeCompare(safeText(b.title), 'ru');
        if (sort === 'volume_asc') return av - bv;
        return bv - av;
      });

      return out;
    }

    function filterOrders(list){
      const q = state.ui.search;
      let out = list.filter(o => {
        const blob = `${o.title} ${o.customer} ${o.notes}`;
        return matchesSearch(blob, q);
      });
      // Приоритет выше — раньше. Если одинаково, свежие выше.
      out = out.slice().sort((a,b) => {
        const ap = Number(a.priority);
        const bp = Number(b.priority);
        if (ap !== bp) return bp - ap;
        const at = new Date(a.created_at || 0).getTime();
        const bt = new Date(b.created_at || 0).getTime();
        return bt - at;
      });
      return out;
    }

    function statusPill(status){
      const s = safeText(status);
      if (s === 'printing') return 'pf-pill pf-pill--info';
      if (s === 'idle') return 'pf-pill pf-pill--good';
      if (s === 'paused') return 'pf-pill pf-pill--warn';
      if (s === 'error') return 'pf-pill pf-pill--bad';
      return 'pf-pill pf-pill--info';
    }

    function escapeHtml(str){
      return safeText(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'", '&#039;');
    }

    function renderPrinters(){
      const root = $('#tab-printers');
      const printers = filterPrinters(state.printers);

      const sub = state.subscription || { plan: 'FREE' };
      const limit = sub.limit_printers;
      const limLabel = limit === Infinity ? '∞' : safeText(limit);
      const plan = safeText(sub.plan || 'FREE');

      let header = `
        <div class="pf-card p-4">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="text-base font-semibold">Принтеры</div>
              <div class="text-xs" style="color: var(--pf-sub);">План: <span class="font-semibold">${escapeHtml(plan)}</span> · Лимит: <span class="font-semibold">${escapeHtml(limLabel)}</span> · Сервер: <span class="font-semibold">${escapeHtml(fmtDateTime(state.server_time || null))}</span></div>
            </div>
            <div class="flex items-center gap-2">
              ${state.isDemo ? `<span class="pf-badge">ДЕМО</span>` : ''}
              <button class="px-3 py-2 rounded-xl" style="background: rgba(0,0,0,.04);" id="addPrinterBtn" title="Добавить принтер">+ Добавить</button>
            </div>
          </div>
        </div>
      `;

      let body = '';
      if (printers.length === 0){
        body = `
          <div class="pf-card p-4">
            <div class="text-sm font-semibold">Ничего не найдено</div>
            <div class="text-xs text-gray-500 mt-1">Проверьте фильтры и строку поиска.</div>
          </div>
        `;
      } else {
        body = printers.map(p => {
          const area = bedArea(p);
          const areaText = Number.isFinite(area) ? `${Math.round(area)} мм²` : '—';
          const job = p.current_job;
          const progress = job && Number.isFinite(job.progress) ? Math.max(0, Math.min(1, job.progress)) : null;
          const progressPct = progress === null ? null : Math.round(progress*100);

          return `
            <article class="pf-card p-4" data-printer-id="${escapeHtml(p.id)}">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="flex items-center gap-2">
                    <div class="text-base font-semibold truncate">${escapeHtml(p.name)}</div>
                    <span class="${statusPill(p.status)}">${escapeHtml(p.status_label)}</span>
                  </div>
                  <div class="text-xs mt-1" style="color: var(--pf-sub);">
                    ${escapeHtml(p.model)} · Сопло: <span class="font-semibold">${escapeHtml(p.nozzle)}</span> · Стол: <span class="font-semibold">${escapeHtml(fmtMm(p.bed_x))}</span> × <span class="font-semibold">${escapeHtml(fmtMm(p.bed_y))}</span> · Z: <span class="font-semibold">${escapeHtml(fmtMm(p.bed_z))}</span>
                  </div>
                </div>
                <button class="px-3 py-2 rounded-xl hover:bg-black/5" data-action="printer_menu">Меню</button>
              </div>

              ${job ? `
                <div class="mt-3 pf-divider"></div>
                <div class="mt-3">
                  <div class="text-sm font-semibold truncate">${escapeHtml(job.title)}</div>
                  <div class="mt-1 text-xs" style="color: var(--pf-sub);">Осталось: <span class="font-semibold">${escapeHtml(job.eta_sec === null ? '—' : fmtHours(job.eta_sec))}</span> · Прогресс: <span class="font-semibold">${escapeHtml(progressPct === null ? '—' : progressPct + '%')}</span> · Обновлено: <span class="font-semibold">${escapeHtml(fmtDateTime(p.updated_at))}</span></div>
                  <div class="mt-2 h-2 rounded-full" style="background: rgba(0,0,0,.06);">
                    <div class="h-2 rounded-full" style="width: ${progressPct ?? 0}%; background: linear-gradient(90deg, rgba(47,107,255,.85), rgba(6,182,212,.85));"></div>
                  </div>
                </div>
              ` : `
                <div class="mt-3 flex items-center justify-between">
                  <div class="text-xs" style="color: var(--pf-sub);">Площадь стола: <span class="font-semibold">${escapeHtml(areaText)}</span> · Обновлено: <span class="font-semibold">${escapeHtml(fmtDateTime(p.updated_at))}</span></div>
                  <button class="px-3 py-2 rounded-xl" style="background: rgba(47,107,255,.08); border: 1px solid rgba(47,107,255,.22); color: #1d46aa;" data-action="start_job">Печать</button>
                </div>
              `}
            </article>
          `;
        }).join('');
      }

      root.innerHTML = `
        <div class="space-y-3">
          ${header}
          ${body}
        </div>
      `;

      // Actions
      $('#addPrinterBtn')?.addEventListener('click', () => {
        const plan = safeText(state.subscription?.plan || 'FREE');
        toast(`Добавление принтера: в демо-режиме недоступно. План: ${plan}.`);
      });

      $$('[data-action="printer_menu"]', root).forEach(btn => {
        btn.addEventListener('click', (e) => {
          const card = e.target.closest('[data-printer-id]');
          const id = card?.getAttribute('data-printer-id');
          const printer = state.printers.find(p => p.id === id);
          if (!printer){ toast('Не удалось определить принтер.'); return; }
          toast(`Меню принтера: ${printer.name}. (В реальном проекте: карточка/команды/премиум-рендер.)`);
        });
      });

      $$('[data-action="start_job"]', root).forEach(btn => {
        btn.addEventListener('click', (e) => {
          const card = e.target.closest('[data-printer-id]');
          const id = card?.getAttribute('data-printer-id');
          const printer = state.printers.find(p => p.id === id);
          if (!printer){ toast('Не удалось определить принтер.'); return; }
          toast(`Печать: в демо UI показан запуск задания для «${printer.name}».`);
        });
      });
    }

    function renderWork(){
      const root = $('#tab-work');
      const orders = filterOrders(state.orders);
      const models = sortModels(state.models);
      const ordersFirst = Boolean(state.ui.filters.ordersFirst);

      const orderCards = orders.map(o => {
        const model = state.models.find(m => m.id === o.model_ref);
        const modelTitle = model ? model.title : (o.model_ref ? `Модель: ${o.model_ref}` : 'Модель не указана');
        const rem = Number.isFinite(o.remaining_qty) ? o.remaining_qty : 0;
        const urgent = o.priority >= 8;

        return `
          <article class="pf-card p-4" data-order-id="${escapeHtml(o.id)}">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <div class="text-base font-semibold truncate">${escapeHtml(o.title)}</div>
                  ${urgent ? `<span class="pf-pill pf-pill--bad">СРОЧНО</span>` : `<span class="pf-pill pf-pill--info">Приоритет ${escapeHtml(o.priority)}</span>`}
                </div>
                <div class="text-xs mt-1" style="color: var(--pf-sub);">
                  Клиент: <span class="font-semibold">${escapeHtml(o.customer || '—')}</span> · Остаток: <span class="font-semibold">${escapeHtml(rem)}</span> · Создан: <span class="font-semibold">${escapeHtml(fmtDateTime(o.created_at))}</span>
                </div>
              </div>
              <button class="px-3 py-2 rounded-xl hover:bg-black/5" data-action="order_menu">Меню</button>
            </div>

            <div class="mt-3 pf-divider"></div>
            <div class="mt-3">
              <div class="text-sm font-semibold">${escapeHtml(modelTitle)}</div>
              ${o.notes ? `<div class="mt-1 text-xs" style="color: var(--pf-sub);">Примечание: ${escapeHtml(o.notes)}</div>` : `<div class="mt-1 text-xs" style="color: var(--pf-sub);">Без примечаний.</div>`}
              <div class="mt-3 flex gap-2">
                <button class="flex-1 px-3 py-2 rounded-xl" style="background: rgba(47,107,255,.08); border: 1px solid rgba(47,107,255,.22); color: #1d46aa;" data-action="order_start">Запустить печать</button>
                <button class="px-3 py-2 rounded-xl" style="background: rgba(0,0,0,.04);" data-action="order_decrement">−1 остаток</button>
              </div>
              <div class="mt-2 text-[11px]" style="color: var(--pf-sub);">Логика v2.6.7: при финише печати остаток должен декрементироваться автоматически.</div>
            </div>
          </article>
        `;
      }).join('');

      const modelCards = models.map(m => {
        const bbox = m.bbox_mm || {};
        return `
          <article class="pf-card p-4" data-model-id="${escapeHtml(m.id)}">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <div class="text-base font-semibold truncate">${escapeHtml(m.title)}</div>
                  <span class="pf-pill pf-pill--info">${escapeHtml((m.kind || 'stl').toUpperCase())}</span>
                </div>
                <div class="text-xs mt-1" style="color: var(--pf-sub);">
                  Объём: <span class="font-semibold">${escapeHtml(fmtCm3(m.volume_cm3))}</span> · Габариты: <span class="font-semibold">${escapeHtml(fmtMm(bbox.x))}</span> × <span class="font-semibold">${escapeHtml(fmtMm(bbox.y))}</span> × <span class="font-semibold">${escapeHtml(fmtMm(bbox.z))}</span>
                </div>
              </div>
              <button class="px-3 py-2 rounded-xl hover:bg-black/5" data-action="model_menu">Меню</button>
            </div>

            <div class="mt-3 pf-divider"></div>
            <div class="mt-3 flex items-center justify-between gap-3">
              <div class="text-xs" style="color: var(--pf-sub);">
                Время: <span class="font-semibold">${escapeHtml(fmtHours(m.est_time_sec))}</span> · Вес: <span class="font-semibold">${escapeHtml(Number.isFinite(m.est_weight_g) ? m.est_weight_g + ' г' : '—')}</span>
              </div>
              <button class="px-3 py-2 rounded-xl" style="background: rgba(0,0,0,.04);" data-action="anti_vermicelli">Анти‑Вермишель</button>
            </div>
          </article>
        `;
      }).join('');

      const block = (title, content, hint) => `
        <div class="pf-card p-4">
          <div class="flex items-center justify-between">
            <div class="text-base font-semibold">${escapeHtml(title)}</div>
            ${hint ? `<div class="text-xs" style="color: var(--pf-sub);">${escapeHtml(hint)}</div>` : ''}
          </div>
        </div>
        <div class="space-y-3">${content || `
          <div class="pf-card p-4">
            <div class="text-sm font-semibold">Пусто</div>
            <div class="text-xs text-gray-500 mt-1">Данных пока нет.</div>
          </div>
        `}</div>
      `;

      const combined = ordersFirst
        ? `${block('Заказы', orderCards, 'Заказы всегда выше моделей')}${block('Модели', modelCards, 'Сортировка по объёму')}`
        : `${block('Модели', modelCards, 'Сортировка по объёму')}${block('Заказы', orderCards, 'Заказы могут быть ниже моделей')}`;

      root.innerHTML = `
        <div class="space-y-3">${combined}</div>
      `;

      // Actions
      $$('[data-action="order_menu"]', root).forEach(btn => {
        btn.addEventListener('click', (e) => {
          const card = e.target.closest('[data-order-id]');
          const id = card?.getAttribute('data-order-id');
          const order = state.orders.find(o => o.id === id);
          if (!order){ toast('Не удалось определить заказ.'); return; }
          toast(`Меню заказа: ${order.title}. (В реальном проекте: редактирование/привязка к моделям/планирование.)`);
        });
      });

      $$('[data-action="order_decrement"]', root).forEach(btn => {
        btn.addEventListener('click', (e) => {
          const card = e.target.closest('[data-order-id]');
          const id = card?.getAttribute('data-order-id');
          const order = state.orders.find(o => o.id === id);
          if (!order){ toast('Не удалось определить заказ.'); return; }
          if (!Number.isFinite(order.remaining_qty)) order.remaining_qty = 0;
          if (order.remaining_qty <= 0){ toast('Остаток уже равен 0.'); return; }
          order.remaining_qty -= 1;
          toast(`Остаток «${order.title}»: теперь ${order.remaining_qty}.`);
          renderWork();
        });
      });

      $$('[data-action="order_start"]', root).forEach(btn => {
        btn.addEventListener('click', (e) => {
          const card = e.target.closest('[data-order-id]');
          const id = card?.getAttribute('data-order-id');
          const order = state.orders.find(o => o.id === id);
          if (!order){ toast('Не удалось определить заказ.'); return; }
          toast(`Запуск печати заказа «${order.title}»: в демо UI это действие не отправляет команду на backend.`);
        });
      });

      $$('[data-action="model_menu"]', root).forEach(btn => {
        btn.addEventListener('click', (e) => {
          const card = e.target.closest('[data-model-id]');
          const id = card?.getAttribute('data-model-id');
          const model = state.models.find(m => m.id === id);
          if (!model){ toast('Не удалось определить модель.'); return; }
          toast(`Меню модели: ${model.title}. (В реальном проекте: загрузчик G-code+STL, метрики слайсера, предпросмотр.)`);
        });
      });

      $$('[data-action="anti_vermicelli"]', root).forEach(btn => {
        btn.addEventListener('click', (e) => {
          const card = e.target.closest('[data-model-id]');
          const id = card?.getAttribute('data-model-id');
          const model = state.models.find(m => m.id === id);
          if (!model){ toast('Не удалось определить модель.'); return; }

          // Анти-Вермишель: проверка на влезание в самый маленький принтер из списка.
          // В реальной системе выбор принтера задаётся явно.
          const printers = state.printers.slice().sort((a,b) => bedArea(a) - bedArea(b));
          const p = printers[0];
          if (!p){ toast('Нет принтеров для проверки.'); return; }

          const bx = Number(model.bbox_mm?.x);
          const by = Number(model.bbox_mm?.y);
          const bz = Number(model.bbox_mm?.z);
          if (![bx,by,bz].every(Number.isFinite)){
            toast('Недостаточно данных для проверки габаритов модели.');
            return;
          }

          const ex = bx - Number(p.bed_x);
          const ey = by - Number(p.bed_y);
          const ez = bz - Number(p.bed_z);

          if (ex <= 0 && ey <= 0 && ez <= 0){
            toast(`Анти‑Вермишель: модель «${model.title}» помещается на «${p.name}».`);
            return;
          }

          const parts = [];
          if (ex > 0) parts.push(`X превышение на ${Math.round(ex*10)/10} мм`);
          if (ey > 0) parts.push(`Y превышение на ${Math.round(ey*10)/10} мм`);
          if (ez > 0) parts.push(`Z превышение на ${Math.round(ez*10)/10} мм`);
          toast(`Анти‑Вермишель: модель не помещается на «${p.name}»: ${parts.join('; ')}.` , { ms: 5200 });
        });
      });
    }

    function settingRow({title, subtitle, iconSvg, bg}){
      const bgStyle = `background: ${bg};`;
      return `
        <button class="w-full pf-card px-3 py-3 flex items-center gap-3 text-left hover:bg-black/5" style="box-shadow:none; background: transparent;" data-action="setting">
          <div class="pf-setting-icon" style="${bgStyle}">${iconSvg}</div>
          <div class="min-w-0 flex-1">
            <div class="text-sm font-semibold truncate">${escapeHtml(title)}</div>
            ${subtitle ? `<div class="text-xs" style="color: var(--pf-sub);">${escapeHtml(subtitle)}</div>` : ''}
          </div>
          <div class="text-gray-400">
            <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M9 18 15 12 9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </button>
      `;
    }

    function renderProfile(){
      const root = $('#tab-profile');
      const u = state.user;
      const fullName = `${safeText(u.first_name)} ${safeText(u.last_name)}`.trim() || 'Пользователь';
      const username = u.username ? '@' + u.username : '—';

      const avatar = u.photo_url
        ? `<img src="${escapeHtml(u.photo_url)}" alt="Аватар" class="h-16 w-16 rounded-full object-cover" />`
        : `<div class="h-16 w-16 rounded-full" style="background: linear-gradient(135deg, rgba(47,107,255,.25), rgba(124,58,237,.25)); display:grid; place-items:center;">
             <div class="text-xl font-bold" style="color: rgba(17,24,39,.7);">${escapeHtml(fullName.slice(0,1).toUpperCase())}</div>
           </div>`;

      const plan = safeText(state.subscription?.plan || 'FREE');
      const lim = state.subscription?.limit_printers;
      const limLabel = lim === Infinity ? '∞' : safeText(lim);

      const commonSettings = [
        {
          title: 'Подписка',
          subtitle: `Ваш план: ${plan} · лимит принтеров: ${limLabel}`,
          bg: 'linear-gradient(135deg, rgba(47,107,255,.18), rgba(6,182,212,.16))',
          iconSvg: `
            <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="color:#1d46aa">
              <path d="M12 2 20 6v6c0 5-3.5 9.4-8 10-4.5-.6-8-5-8-10V6l8-4Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M9 12l2 2 4-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          `
        },
        {
          title: 'Загрузчик STL / G-code',
          subtitle: 'Единый загрузчик: время/вес из комментариев слайсера',
          bg: 'linear-gradient(135deg, rgba(124,58,237,.18), rgba(47,107,255,.14))',
          iconSvg: `
            <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="color:#5b21b6">
              <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 9l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          `
        },
        {
          title: 'Анти‑Вермишель',
          subtitle: 'Проверка влезания модели в bed X/Y/Z с детальным отчётом',
          bg: 'linear-gradient(135deg, rgba(255,179,0,.18), rgba(255,59,48,.10))',
          iconSvg: `
            <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="color:#8a5a00">
              <path d="M12 2a10 10 0 1 0 10 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 7v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M21 2v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          `
        },
        {
          title: 'Уведомления',
          subtitle: 'Безопасные ответы и редактирование сообщений (safe_* helpers)',
          bg: 'linear-gradient(135deg, rgba(0,200,83,.16), rgba(6,182,212,.12))',
          iconSvg: `
            <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="color:#067a34">
              <path d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          `
        },
      ];

      const adminSettings = [
        {
          title: 'Админ‑панель',
          subtitle: 'Пользователи, подписки, промокоды, база моделей принтеров',
          bg: 'linear-gradient(135deg, rgba(255,59,48,.16), rgba(124,58,237,.12))',
          iconSvg: `
            <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="color:#a61a12">
              <path d="M12 1 3 5v6c0 5.5 3.8 10.3 9 12 5.2-1.7 9-6.5 9-12V5l-9-4Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M12 10a2 2 0 0 1 2 2v3H10v-3a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2"/>
              <path d="M10.5 10V8.75a1.5 1.5 0 1 1 3 0V10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          `
        },
      ];

      const settingsHtml = commonSettings.map(settingRow).join('');
      const adminHtml = state.isAdmin
        ? `
          <div class="mt-3 pf-card p-4">
            <div class="flex items-center justify-between">
              <div class="text-base font-semibold">Админ‑панель</div>
              <span class="pf-badge">ADMIN</span>
            </div>
            <div class="text-xs mt-1" style="color: var(--pf-sub);">Раздел виден только администраторам.</div>
          </div>
          <div class="pf-card p-2" style="box-shadow: var(--pf-shadow);">
            ${adminSettings.map(settingRow).join('')}
          </div>
        `
        : '';

      root.innerHTML = `
        <div class="space-y-3">
          <div class="pf-card p-4">
            <div class="flex items-center gap-3">
              ${avatar}
              <div class="min-w-0">
                <div class="text-base font-semibold truncate">${escapeHtml(fullName)}</div>
                <div class="text-xs" style="color: var(--pf-sub);">${escapeHtml(username)} · ID: <span class="font-semibold">${escapeHtml(u.id ?? '—')}</span></div>
                <div class="mt-2 flex items-center gap-2">
                  <span class="pf-pill pf-pill--info">План: ${escapeHtml(plan)}</span>
                  ${state.isDemo ? `<span class="pf-badge">ДЕМО</span>` : ''}
                </div>
              </div>
            </div>
          </div>

          <div class="pf-card p-4">
            <div class="text-base font-semibold">Настройки и функции</div>
            <div class="text-xs mt-1" style="color: var(--pf-sub);">Интерфейс в стиле Telegram Native 2024: белые блоки, radius 12px, разделители.</div>
          </div>

          <div class="pf-card p-2" style="box-shadow: var(--pf-shadow);">
            ${settingsHtml}
          </div>

          ${adminHtml}

          <div class="pf-card p-4">
            <div class="flex flex-col gap-2">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">О проекте</div>
                <div class="text-xs" style="color: var(--pf-sub);">v${escapeHtml(APP_VERSION)}</div>
              </div>
              <div class="text-xs" style="color: var(--pf-sub);">Разработчик: <a class="font-semibold" href="https://t.me/${encodeURIComponent(DEV_HANDLE.replace('@',''))}" target="_blank" rel="noreferrer">${escapeHtml(DEV_HANDLE)}</a></div>
              <div class="text-xs" style="color: var(--pf-sub);">Поддержать: <a class="font-semibold" href="${escapeHtml(DONATE_URL)}" target="_blank" rel="noreferrer">Донат</a></div>
              <div class="mt-2 flex gap-2">
                <button id="copyDebug" class="px-3 py-2 rounded-xl" style="background: rgba(0,0,0,.04);">Скопировать диагностику</button>
                <button id="openDonate" class="px-3 py-2 rounded-xl" style="background: rgba(47,107,255,.08); border: 1px solid rgba(47,107,255,.22); color: #1d46aa;">Поддержать</button>
              </div>
            </div>
          </div>
        </div>
      `;

      // Actions
      $$('#tab-profile [data-action="setting"]').forEach(btn => {
        btn.addEventListener('click', () => {
          toast('Этот экран — демонстрация UI. В реальном проекте здесь открываются соответствующие модули.');
        });
      });

      $('#openDonate')?.addEventListener('click', () => {
        window.open(DONATE_URL, '_blank', 'noopener,noreferrer');
      });

      $('#copyDebug')?.addEventListener('click', async () => {
        const dbg = {
          version: APP_VERSION,
          use_mock: USE_MOCK,
          is_demo: state.isDemo,
          is_admin: state.isAdmin,
          user: state.user,
          subscription: state.subscription,
          counts: { printers: state.printers.length, orders: state.orders.length, models: state.models.length },
          ua: navigator.userAgent,
          tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
          tg: {
            hasWebApp: Boolean(window.Telegram?.WebApp),
            platform: safeText(window.Telegram?.WebApp?.platform || ''),
            colorScheme: safeText(window.Telegram?.WebApp?.colorScheme || ''),
          }
        };
        try{
          await navigator.clipboard.writeText(JSON.stringify(dbg, null, 2));
          toast('Диагностика скопирована в буфер обмена.');
        } catch {
          toast('Не удалось скопировать (ограничения браузера).');
        }
      });
    }

    function renderAll(){
      $('#loading')?.classList.add('hidden');
      $('#tab-printers')?.classList.toggle('hidden', state.ui.activeTab !== 'printers');
      $('#tab-work')?.classList.toggle('hidden', state.ui.activeTab !== 'work');
      $('#tab-profile')?.classList.toggle('hidden', state.ui.activeTab !== 'profile');

      if (state.ui.activeTab === 'printers') renderPrinters();
      if (state.ui.activeTab === 'work') renderWork();
      if (state.ui.activeTab === 'profile') renderProfile();

      // Sub-title
      const sub = state.isDemo
        ? 'Демо режим: backend недоступен'
        : `Данные синхронизированы · План: ${safeText(state.subscription?.plan || 'FREE')}`;
      const subtitle = $('#subtitle');
      if (subtitle) subtitle.textContent = sub;
    }

    function setTab(tab){
      state.ui.activeTab = tab;
      $$('.pf-tab-btn').forEach(b => {
        const is = b.getAttribute('data-tab') === tab;
        b.setAttribute('aria-selected', is ? 'true' : 'false');
      });
      renderAll();
    }

    function openFilter(open){
      const m = $('#filterModal');
      if (!m) return;
      m.dataset.open = open ? 'true' : 'false';
      if (open){
        // sync UI
        $('#ordersFirst').checked = Boolean(state.ui.filters.ordersFirst);
      }
    }

    function bindUI(){
      // Tabs
      $$('.pf-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => setTab(btn.getAttribute('data-tab')));
      });

      // Search
      const si = $('#searchInput');
      if (si){
        si.addEventListener('input', () => {
          state.ui.search = safeText(si.value);
          renderAll();
        });
      }
      $('#clearSearch')?.addEventListener('click', () => {
        state.ui.search = '';
        if (si) si.value = '';
        renderAll();
      });

      // Refresh
      $('#refreshBtn')?.addEventListener('click', async () => {
        toast('Обновляю данные…');
        $('#loading')?.classList.remove('hidden');
        try{
          await bootstrap();
        } finally {
          renderAll();
          toast(state.isDemo ? 'Показаны демо‑данные.' : 'Данные обновлены.');
        }
      });

      // Filter modal
      $('#filterBtn')?.addEventListener('click', () => openFilter(true));
      $('#closeFilter')?.addEventListener('click', () => openFilter(false));
      $('#filterModal')?.addEventListener('click', (e) => {
        if (e.target && e.target.id === 'filterModal') openFilter(false);
      });

      // Filter selection buttons (delegation)
      $('#filterModal')?.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-filter]');
        if (!btn) return;
        const filter = btn.getAttribute('data-filter');
        const value = btn.getAttribute('data-value');
        if (!filter) return;
        if (filter === 'printer_size') state.ui.filters.printer_size = value;
        if (filter === 'model_sort') state.ui.filters.model_sort = value;
        toast('Фильтр выбран. Нажмите «Применить».', { ms: 1400 });
      });

      $('#applyFilters')?.addEventListener('click', () => {
        state.ui.filters.ordersFirst = Boolean($('#ordersFirst')?.checked);
        openFilter(false);
        renderAll();
        toast('Фильтры применены.');
      });

      $('#resetFilters')?.addEventListener('click', () => {
        state.ui.filters = { printer_size: 'all', model_sort: 'volume_desc', ordersFirst: true };
        if ($('#ordersFirst')) $('#ordersFirst').checked = true;
        openFilter(false);
        renderAll();
        toast('Фильтры сброшены.');
      });

      // Keyboard escape closes modal
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') openFilter(false);
      });
    }

    async function init(){
      applyTelegramChrome();
      bindUI();

      // Small UX: show version in title
      document.title = `PrintFarm v${APP_VERSION}`;

      await bootstrap();
      renderAll();

      // If run in Telegram: set main button hints / haptic optionally
      try{
        const tg = window.Telegram?.WebApp;
        if (tg){
          tg.setHeaderColor?.(tg.colorScheme === 'dark' ? '#0f1115' : '#f1f2f6');
          tg.setBackgroundColor?.(tg.colorScheme === 'dark' ? '#0f1115' : '#f1f2f6');
        }
      } catch {
        // ignore
      }

      toast(state.isDemo ? 'Демо режим: backend недоступен.' : 'Подключение к серверу установлено.');
    }

    init();
  </script>
</body>
</html>
