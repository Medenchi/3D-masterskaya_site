<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>PrintFarm Mini App v2.6.8</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --pf-bg:#f1f2f6;
      --pf-card:#ffffff;
      --pf-divider:rgba(0,0,0,.08);
      --pf-text:#111827;
      --pf-sub:#6b7280;
      --pf-accent:#2f6bff;
      --pf-good:#00c853;
      --pf-warn:#ffb300;
      --pf-bad:#ff3b30;
      --pf-purple:#7c3aed;
      --pf-cyan:#06b6d4;
      --pf-shadow:0 8px 24px rgba(0,0,0,.06);
      --pf-radius:12px;
      --pf-safe-bottom: env(safe-area-inset-bottom, 0px);
      --pf-safe-top: env(safe-area-inset-top, 0px);
    }

    html, body { height: 100%; }
    body{
      background: var(--pf-bg);
      color: var(--pf-text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior: none;
    }

    .pf-card{ background: var(--pf-card); border-radius: var(--pf-radius); box-shadow: var(--pf-shadow); }
    .pf-divider{ border-top: 1px solid var(--pf-divider); }

    .pf-bottom-bar{
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      padding-bottom: calc(10px + var(--pf-safe-bottom));
      padding-top: 10px;
      background: rgba(255,255,255,.75);
      border-top: 1px solid rgba(0,0,0,.06);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      z-index: 50;
    }
    .pf-icon{ width: 24px; height: 24px; display: inline-block; }

    .pf-tab-btn[aria-selected="true"] .pf-tab-label{ color: var(--pf-accent); }
    .pf-tab-btn[aria-selected="true"] svg{ color: var(--pf-accent); }
    .pf-tab-btn[aria-selected="false"] svg{ color: rgba(17,24,39,.55); }

    .pf-modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.25);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 60;
    }
    .pf-modal-backdrop[data-open="true"]{ display: flex; }
    .pf-modal{
      width: 100%;
      max-width: 720px;
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
      background: var(--pf-card);
      padding: 14px 14px calc(14px + var(--pf-safe-bottom));
      box-shadow: 0 -14px 34px rgba(0,0,0,.18);
    }

    .pf-skeleton{
      background: linear-gradient(90deg, rgba(0,0,0,.06), rgba(0,0,0,.03), rgba(0,0,0,.06));
      background-size: 200% 100%;
      animation: pfShimmer 1.25s infinite;
      border-radius: 10px;
    }
    @keyframes pfShimmer{ 0%{ background-position: 0% 0; } 100%{ background-position: 200% 0; } }

    .pf-pill{ border-radius: 999px; padding: 4px 10px; font-weight: 600; font-size: 12px; letter-spacing: .2px; }
    .pf-pill--good{ background: rgba(0,200,83,.12); color: #067a34; border: 1px solid rgba(0,200,83,.22); }
    .pf-pill--warn{ background: rgba(255,179,0,.14); color: #8a5a00; border: 1px solid rgba(255,179,0,.22); }
    .pf-pill--bad{ background: rgba(255,59,48,.12); color: #a61a12; border: 1px solid rgba(255,59,48,.22); }
    .pf-pill--info{ background: rgba(47,107,255,.12); color: #1d46aa; border: 1px solid rgba(47,107,255,.22); }

    .pf-setting-icon{ width: 34px; height: 34px; border-radius: 10px; display: grid; place-items: center; flex: 0 0 auto; }

    .pf-tap{ -webkit-tap-highlight-color: transparent; }

    .pf-main{ padding-bottom: 90px; }

    .pf-toast-wrap{ position: fixed; left: 0; right: 0; top: calc(10px + var(--pf-safe-top)); display: flex; justify-content: center; pointer-events: none; z-index: 70; }
    .pf-toast{ pointer-events: auto; background: rgba(17,24,39,.92); color: white; padding: 10px 12px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.25); max-width: min(680px, calc(100% - 24px)); font-size: 13px; line-height: 1.3; display: none; }
    .pf-toast[data-open="true"]{ display: block; }

    .pf-badge{ font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 999px; background: rgba(124,58,237,.12); border: 1px solid rgba(124,58,237,.22); color: #5b21b6; }
  </style>
</head>
<body class="pf-tap">
  <div class="pf-toast-wrap"><div id="toast" class="pf-toast" role="status" aria-live="polite"></div></div>

  <div class="max-w-3xl mx-auto px-3">
    <header class="pt-4" style="padding-top: calc(16px + var(--pf-safe-top));">
      <div class="flex items-center justify-between">
        <div class="min-w-0">
          <div class="text-[15px] font-semibold tracking-tight">PrintFarm</div>
          <div id="subtitle" class="text-xs text-gray-500 truncate">Экосистема управления 3D‑фермой</div>
        </div>
        <div class="flex items-center gap-2">
          <button id="filterBtn" class="pf-card px-3 py-2 flex items-center gap-2" title="Сортировка и фильтры">
            <span class="text-sm font-semibold">Фильтр</span>
            <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 6h16M7 12h10M10 18h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <button id="refreshBtn" class="pf-card px-3 py-2 flex items-center gap-2" title="Обновить">
            <span class="text-sm font-semibold">Обновить</span>
            <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M20 12a8 8 0 1 1-2.34-5.66" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M20 4v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </div>
      </div>

      <div class="mt-3 pf-card px-3 py-2 flex items-center gap-2">
        <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M10.5 17a6.5 6.5 0 1 1 0-13 6.5 6.5 0 0 1 0 13Z" stroke="currentColor" stroke-width="2"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="searchInput" class="w-full bg-transparent outline-none text-sm" placeholder="Поиск: принтер, заказ, модель…" autocomplete="off" />
        <button id="clearSearch" class="text-sm text-gray-500 px-2 py-1 rounded-lg hover:bg-black/5" title="Очистить">Сброс</button>
      </div>

      <div id="banner" class="mt-3 hidden">
        <div class="pf-card px-3 py-2 flex items-start gap-2">
          <div class="mt-[2px]"><svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 9v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M12 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/><path d="M10.29 3.86 2.82 17.18A2 2 0 0 0 4.55 20h14.9a2 2 0 0 0 1.73-2.82L13.71 3.86a2 2 0 0 0-3.42 0Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg></div>
          <div class="min-w-0">
            <div class="text-sm font-semibold">API недоступно</div>
            <div class="text-xs text-gray-500">Проверьте backend: нужен <code class="px-1 py-[1px] rounded bg-black/5">GET /api/bootstrap</code> и заголовок <code class="px-1 py-[1px] rounded bg-black/5">X-Telegram-InitData</code>.</div>
          </div>
        </div>
      </div>
    </header>

    <main class="pf-main mt-4" id="main">
      <section id="tab-printers" class="tab-pane"></section>
      <section id="tab-work" class="tab-pane hidden"></section>
      <section id="tab-profile" class="tab-pane hidden"></section>

      <section id="loading" class="space-y-3">
        <div class="pf-card p-4"><div class="h-4 w-48 pf-skeleton"></div><div class="mt-3 h-3 w-64 pf-skeleton"></div><div class="mt-2 h-3 w-52 pf-skeleton"></div></div>
        <div class="pf-card p-4"><div class="h-4 w-40 pf-skeleton"></div><div class="mt-3 grid grid-cols-2 gap-3"><div class="h-16 pf-skeleton"></div><div class="h-16 pf-skeleton"></div></div></div>
        <div class="pf-card p-4"><div class="h-4 w-56 pf-skeleton"></div><div class="mt-3 h-20 pf-skeleton"></div></div>
      </section>
    </main>
  </div>

  <nav class="pf-bottom-bar">
    <div class="max-w-3xl mx-auto px-6">
      <div class="grid grid-cols-3 gap-2">
        <button class="pf-tab-btn flex flex-col items-center justify-center gap-1" data-tab="printers" aria-selected="true">
          <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 7V4a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v3" stroke="currentColor" stroke-width="2"/><path d="M7 17h10v5H7v-5Z" stroke="currentColor" stroke-width="2"/><path d="M6 7h12a4 4 0 0 1 4 4v4a2 2 0 0 1-2 2h-3v-4H7v4H4a2 2 0 0 1-2-2v-4a4 4 0 0 1 4-4Z" stroke="currentColor" stroke-width="2"/></svg>
          <div class="pf-tab-label text-[11px] font-semibold text-gray-500">Принтеры</div>
        </button>
        <button class="pf-tab-btn flex flex-col items-center justify-center gap-1" data-tab="work" aria-selected="false">
          <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 7h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M9 11h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M7 3h10a2 2 0 0 1 2 2v16l-7-3-7 3V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
          <div class="pf-tab-label text-[11px] font-semibold text-gray-500">Заказы</div>
        </button>
        <button class="pf-tab-btn flex flex-col items-center justify-center gap-1" data-tab="profile" aria-selected="false">
          <svg class="pf-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M20 21a8 8 0 1 0-16 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="2"/></svg>
          <div class="pf-tab-label text-[11px] font-semibold text-gray-500">Профиль</div>
        </button>
      </div>
    </div>
  </nav>

  <div id="filterModal" class="pf-modal-backdrop" role="dialog" aria-modal="true" aria-label="Сортировка и фильтры">
    <div class="pf-modal">
      <div class="flex items-center justify-between">
        <div class="text-base font-semibold">Сортировка и фильтры</div>
        <button id="closeFilter" class="px-3 py-2 rounded-xl hover:bg-black/5">Закрыть</button>
      </div>
      <div class="mt-3 pf-divider"></div>

      <div class="mt-3 grid gap-3">
        <div>
          <div class="text-sm font-semibold">Принтеры</div>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <button class="pf-card px-3 py-2 text-left" data-filter="printer_state" data-value="all"><div class="text-sm font-semibold">Все</div><div class="text-xs text-gray-500">Без ограничения</div></button>
            <button class="pf-card px-3 py-2 text-left" data-filter="printer_state" data-value="printing"><div class="text-sm font-semibold">Печатают</div><div class="text-xs text-gray-500">Только активные</div></button>
            <button class="pf-card px-3 py-2 text-left" data-filter="printer_state" data-value="idle"><div class="text-sm font-semibold">Свободны</div><div class="text-xs text-gray-500">Готовы к печати</div></button>
            <button class="pf-card px-3 py-2 text-left" data-filter="printer_state" data-value="problem"><div class="text-sm font-semibold">Проблемы</div><div class="text-xs text-gray-500">Пауза/ошибка/ремонт</div></button>
          </div>
        </div>

        <div>
          <div class="text-sm font-semibold">Модели</div>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <button class="pf-card px-3 py-2 text-left" data-filter="model_sort" data-value="new"><div class="text-sm font-semibold">Новые</div><div class="text-xs text-gray-500">Сначала свежие</div></button>
            <button class="pf-card px-3 py-2 text-left" data-filter="model_sort" data-value="volume_desc"><div class="text-sm font-semibold">Объём</div><div class="text-xs text-gray-500">Сначала большие</div></button>
          </div>
        </div>

        <div>
          <div class="text-sm font-semibold">Приоритет</div>
          <div class="mt-2 pf-card px-3 py-3">
            <label class="flex items-center justify-between gap-3">
              <div class="min-w-0">
                <div class="text-sm font-semibold">Заказы приоритетнее моделей</div>
                <div class="text-xs text-gray-500">Вкладка «Заказы»: сверху заказы, ниже модели</div>
              </div>
              <input id="ordersFirst" type="checkbox" class="h-5 w-5" checked />
            </label>
          </div>
        </div>

        <div class="flex gap-2">
          <button id="applyFilters" class="flex-1 pf-card px-3 py-3 font-semibold" style="border: 1px solid rgba(47,107,255,.22); background: rgba(47,107,255,.08); color: #1d46aa;">Применить</button>
          <button id="resetFilters" class="pf-card px-3 py-3 font-semibold">Сбросить</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    'use strict';

    const APP_VERSION = '2.6.8';
    const API_BASE = '';

    const state = {
      apiOk: false,
      server_time: null,
      user: { id: null, first_name: 'Пользователь', photo_url: '', plan: 'FREE', limit_printers: 1, is_admin: false, is_banned: false },
      printers: [],
      models: [],
      orders: [],
      admin: { lastResult: null },
      ui: { activeTab: 'printers', search: '', filters: { printer_state: 'all', model_sort: 'new', ordersFirst: true } },
      debug: { lastError: null }
    };

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function safeText(v){ return (v === null || v === undefined) ? '' : String(v); }
    function escapeHtml(str){
      return safeText(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'", '&#039;');
    }

    function toast(message, opts={}){
      const el = $('#toast');
      if (!el) return;
      const ms = typeof opts.ms === 'number' ? opts.ms : 2600;
      el.textContent = safeText(message);
      el.dataset.open = 'true';
      window.clearTimeout(toast._t);
      toast._t = window.setTimeout(() => { el.dataset.open = 'false'; }, ms);
    }

    function fmtDateTime(iso){
      if (!iso) return '—';
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return '—';
      return d.toLocaleString('ru-RU', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    }

    function fmtSeconds(sec){
      sec = Math.max(0, Math.floor(Number(sec || 0)));
      const h = Math.floor(sec/3600);
      const m = Math.floor((sec%3600)/60);
      const s = sec%60;
      if (h>0) return `${h} ч ${String(m).padStart(2,'0')} мин`;
      if (m>0) return `${m} мин ${String(s).padStart(2,'0')} с`;
      return `${s} с`;
    }

    function getTgInitData(){
      try{
        const tg = window.Telegram?.WebApp;
        if (tg?.initData && tg.initData.length > 0) return tg.initData;
      } catch {}
      return '';
    }

    function getTelegramUserUnsafe(){
      try{
        const user = window.Telegram?.WebApp?.initDataUnsafe?.user;
        if (!user) return null;
        return { id: user.id ?? null, first_name: user.first_name ?? 'Пользователь', photo_url: user.photo_url ?? '' };
      } catch { return null; }
    }

    function applyTelegramChrome(){
      const tg = window.Telegram?.WebApp;
      try{ tg?.ready?.(); tg?.expand?.(); tg?.disableVerticalSwipes?.(); } catch {}

      try{
        if (tg?.colorScheme === 'dark'){
          document.documentElement.style.setProperty('--pf-bg', '#0f1115');
          document.documentElement.style.setProperty('--pf-card', '#161a22');
          document.documentElement.style.setProperty('--pf-divider', 'rgba(255,255,255,.08)');
          document.documentElement.style.setProperty('--pf-text', '#e5e7eb');
          document.documentElement.style.setProperty('--pf-sub', '#9ca3af');
          document.querySelector('.pf-bottom-bar')?.style?.setProperty('background', 'rgba(22,26,34,.72)');
        }
        const link = tg?.themeParams?.link_color;
        if (link && typeof link === 'string') document.documentElement.style.setProperty('--pf-accent', link);
      } catch {}
    }

    async function apiBootstrap(initData){
      const r = await fetch(`${API_BASE}/api/bootstrap`, {
        method: 'GET',
        headers: initData ? { 'X-Telegram-InitData': initData } : {},
      });
      const txt = await r.text();
      let data;
      try{ data = JSON.parse(txt); } catch { data = { error: txt }; }
      if (!r.ok) throw new Error(data?.detail || data?.error || `HTTP ${r.status}`);
      return data;
    }

    async function apiAdmin(path, body, initData){
      const r = await fetch(`${API_BASE}${path}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(initData ? { 'X-Telegram-InitData': initData } : {})
        },
        body: JSON.stringify(body || {})
      });
      const txt = await r.text();
      let data;
      try{ data = JSON.parse(txt); } catch { data = { error: txt }; }
      if (!r.ok) throw new Error(data?.detail || data?.error || `HTTP ${r.status}`);
      return data;
    }

    function normalizeFromBackend(payload){
      const u = payload?.user_data || payload?.user || {};
      const printers = payload?.printers_list || payload?.printers || [];
      const models = payload?.models_list || payload?.models || [];
      const orders = payload?.orders_list || payload?.orders || [];

      state.server_time = payload?.server_time || payload?.time || payload?.now || null;

      state.user = {
        id: u?.id ?? null,
        first_name: safeText(u?.first_name || 'Пользователь'),
        photo_url: safeText(u?.avatar_url || u?.photo_url || ''),
        plan: safeText(u?.plan || 'FREE'),
        limit_printers: Number(u?.limit_printers ?? payload?.subscription?.limit_printers ?? 1),
        is_admin: Boolean(u?.is_admin),
        is_banned: Boolean(u?.is_banned)
      };

      state.printers = Array.isArray(printers) ? printers : [];
      state.models = Array.isArray(models) ? models : [];
      state.orders = Array.isArray(orders) ? orders : [];
    }

    function matchesSearch(text, q){
      const qq = safeText(q).trim().toLowerCase();
      if (!qq) return true;
      return safeText(text).toLowerCase().includes(qq);
    }

    function statusPill(status){
      const s = safeText(status).toLowerCase();
      if (s === 'printing') return `<span class="pf-pill pf-pill--info">Печатает</span>`;
      if (s === 'idle') return `<span class="pf-pill pf-pill--good">Свободен</span>`;
      if (s === 'paused') return `<span class="pf-pill pf-pill--warn">Пауза</span>`;
      if (s === 'repair') return `<span class="pf-pill pf-pill--warn">Ремонт</span>`;
      if (s === 'error') return `<span class="pf-pill pf-pill--bad">Ошибка</span>`;
      return `<span class="pf-pill pf-pill--info">${escapeHtml(status || 'status')}</span>`;
    }

    function filterPrinters(list){
      const q = state.ui.search;
      const f = state.ui.filters.printer_state;
      return list
        .filter(p => matchesSearch(`${p.name} ${p.model_name} ${p.status}`, q))
        .filter(p => {
          if (f === 'all') return true;
          if (f === 'printing') return safeText(p.status).toLowerCase() === 'printing';
          if (f === 'idle') return safeText(p.status).toLowerCase() === 'idle';
          if (f === 'problem') {
            const st = safeText(p.status).toLowerCase();
            return st === 'paused' || st === 'error' || st === 'repair';
          }
          return true;
        })
        .slice()
        .sort((a,b) => safeText(a.name).localeCompare(safeText(b.name), 'ru'));
    }

    function sortModels(list){
      const q = state.ui.search;
      const sort = state.ui.filters.model_sort;
      let out = list.filter(m => matchesSearch(`${m.filename} ${m.kind}`, q));
      out = out.slice().sort((a,b) => {
        if (sort === 'volume_desc') return Number(b.volume_cm3||0) - Number(a.volume_cm3||0);
        return new Date(b.created_at||0).getTime() - new Date(a.created_at||0).getTime();
      });
      return out;
    }

    function filterOrders(list){
      const q = state.ui.search;
      return list
        .filter(o => matchesSearch(`${o.id} ${o.status} ${o.title} ${o.note} ${o.catalog_title}`, q))
        .slice()
        .sort((a,b) => new Date(b.created_at||0).getTime() - new Date(a.created_at||0).getTime());
    }

    function renderPrinters(){
      const root = $('#tab-printers');
      const u = state.user;
      const printers = filterPrinters(state.printers);

      const header = `
        <div class="pf-card p-4">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="text-base font-semibold">Принтеры</div>
              <div class="text-xs" style="color: var(--pf-sub);">Пользователь: <span class="font-semibold">${escapeHtml(u.first_name || '—')}</span> · План: <span class="font-semibold">${escapeHtml(u.plan || 'FREE')}</span></div>
              <div class="text-[11px] mt-1" style="color: var(--pf-sub);">Сервер: <span class="font-semibold">${escapeHtml(fmtDateTime(state.server_time))}</span></div>
            </div>
            <div class="flex items-center gap-2">
              <span class="pf-badge">${state.apiOk ? 'API OK' : 'API OFF'}</span>
              ${u.is_admin ? '<span class="pf-badge" style="background: rgba(255,59,48,.12); border-color: rgba(255,59,48,.22); color:#a61a12;">ADMIN</span>' : ''}
            </div>
          </div>
        </div>
      `;

      const cards = printers.length ? printers.map(p => {
        const cur = p.current || null;
        const title = cur?.title || cur?.catalog_title || (cur?.catalog_id ? ('#'+cur.catalog_id) : '—');
        const dur = cur?.duration_sec || cur?.estimated_sec || null;
        const st = safeText(p.status).toLowerCase();
        let progressPct = null;
        if (st === 'printing' && cur?.last_start && dur){
          const t0 = new Date(cur.last_start.replace(' ', 'T')).getTime();
          const now = Date.now();
          if (!Number.isNaN(t0)){
            const elapsed = Math.max(0, (now - t0)/1000);
            progressPct = Math.max(0, Math.min(100, Math.round((elapsed / Number(dur)) * 100)));
          }
        }
        return `
          <article class="pf-card p-4">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <div class="font-semibold truncate">${escapeHtml(p.name || 'Принтер')}</div>
                <div class="text-xs mt-1" style="color: var(--pf-sub);">Модель: ${escapeHtml(p.model_name || '—')} · Стол: <span class="font-semibold">${escapeHtml(p.bed_x||0)}×${escapeHtml(p.bed_y||0)}×${escapeHtml(p.bed_z||0)}</span> мм</div>
              </div>
              ${statusPill(p.status)}
            </div>

            ${cur ? `
              <div class="mt-3 pf-divider"></div>
              <div class="mt-3">
                <div class="text-sm font-semibold truncate">${escapeHtml(title)}</div>
                <div class="mt-1 text-xs" style="color: var(--pf-sub);">Длительность: <span class="font-semibold">${escapeHtml(dur ? fmtSeconds(dur) : '—')}</span> · Старт: <span class="font-semibold">${escapeHtml(cur.last_start || '—')}</span></div>
                ${progressPct !== null ? `
                  <div class="mt-2 h-2 rounded-full" style="background: rgba(0,0,0,.06);">
                    <div class="h-2 rounded-full" style="width:${progressPct}%; background: linear-gradient(90deg, rgba(47,107,255,.85), rgba(6,182,212,.85));"></div>
                  </div>
                  <div class="mt-1 text-[11px]" style="color: var(--pf-sub);">Прогресс: <span class="font-semibold">${progressPct}%</span></div>
                ` : ''}
              </div>
            ` : `
              <div class="mt-3 text-xs" style="color: var(--pf-sub);">Сейчас ничего не печатается.</div>
            `}
          </article>
        `;
      }).join('') : `
        <div class="pf-card p-4">
          <div class="text-sm font-semibold">Нет принтеров</div>
          <div class="text-xs text-gray-500 mt-1">Если это неожиданно — проверьте данные в /api/bootstrap.</div>
        </div>
      `;

      root.innerHTML = `<div class="space-y-3">${header}${cards}</div>`;
    }

    function renderWork(){
      const root = $('#tab-work');
      const orders = filterOrders(state.orders);
      const models = sortModels(state.models);
      const ordersFirst = Boolean(state.ui.filters.ordersFirst);

      const ordersHtml = orders.length ? orders.map(o => {
        const st = safeText(o.status || 'open').toLowerCase();
        const badge = st === 'done' ? 'pf-pill--good' : 'pf-pill--info';
        return `
          <article class="pf-card p-4">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <div class="font-semibold">Заказ #${escapeHtml(o.id)}</div>
                <div class="text-xs mt-1" style="color: var(--pf-sub);">Модель: <span class="font-semibold">${escapeHtml(o.catalog_title || o.title || '—')}</span></div>
              </div>
              <span class="pf-pill ${badge}">${escapeHtml(st.toUpperCase())}</span>
            </div>
            <div class="mt-2 text-xs" style="color: var(--pf-sub);">
              <div class="flex items-center justify-between"><span>Создан</span><span class="font-semibold">${escapeHtml(fmtDateTime(o.created_at))}</span></div>
              <div class="flex items-center justify-between"><span>Готово</span><span class="font-semibold">${escapeHtml(o.done_qty ?? '—')}/${escapeHtml(o.total_qty ?? '—')}</span></div>
            </div>
          </article>
        `;
      }).join('') : `<div class="pf-card p-4"><div class="text-sm text-gray-500">Пока нет заказов.</div></div>`;

      const modelsHtml = models.length ? models.map(m => {
        return `
          <article class="pf-card p-4">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <div class="font-semibold truncate">${escapeHtml(m.filename || ('Модель #'+m.id))}</div>
                <div class="text-xs mt-1" style="color: var(--pf-sub);">Тип: ${escapeHtml(String(m.kind||'').toUpperCase())} · Размер: <span class="font-semibold">${escapeHtml(m.size_x||0)}×${escapeHtml(m.size_y||0)}×${escapeHtml(m.size_z||0)}</span> мм</div>
              </div>
              <span class="pf-pill pf-pill--info">${escapeHtml(String(m.kind||'file').toUpperCase())}</span>
            </div>
            <div class="mt-2 text-xs" style="color: var(--pf-sub);">
              <div class="flex items-center justify-between"><span>Объём</span><span class="font-semibold">${escapeHtml(m.volume_cm3 ?? '—')} см³</span></div>
              <div class="flex items-center justify-between"><span>Время</span><span class="font-semibold">${escapeHtml(m.estimated_sec ? fmtSeconds(m.estimated_sec) : '—')}</span></div>
              <div class="flex items-center justify-between"><span>Филамент</span><span class="font-semibold">${escapeHtml(m.filament_mm ?? '—')} мм</span></div>
            </div>
          </article>
        `;
      }).join('') : `<div class="pf-card p-4"><div class="text-sm text-gray-500">Нет загруженных моделей.</div></div>`;

      const block = (title, hint, content) => `
        <div class="pf-card p-4">
          <div class="flex items-center justify-between">
            <div class="text-base font-semibold">${escapeHtml(title)}</div>
            <div class="text-xs" style="color: var(--pf-sub);">${escapeHtml(hint||'')}</div>
          </div>
        </div>
        <div class="space-y-3">${content}</div>
      `;

      root.innerHTML = `<div class="space-y-3">${ordersFirst ? (block('Заказы','Новая таблица orders',ordersHtml)+block('Модели','STL / G‑CODE',modelsHtml)) : (block('Модели','STL / G‑CODE',modelsHtml)+block('Заказы','Новая таблица orders',ordersHtml))}</div>`;
    }

    function renderProfile(){
      const root = $('#tab-profile');
      const u = state.user;
      const initData = getTgInitData();

      const avatar = u.photo_url
        ? `<img src="${escapeHtml(u.photo_url)}" alt="Аватар" class="h-16 w-16 rounded-full object-cover" />`
        : `<div class="h-16 w-16 rounded-full" style="background: linear-gradient(135deg, rgba(47,107,255,.25), rgba(124,58,237,.25)); display:grid; place-items:center;"><div class="text-xl font-bold" style="color: rgba(17,24,39,.7);">PF</div></div>`;

      const printersUsed = state.printers.length;
      const printersLimit = Math.max(1, Number(u.limit_printers || 1));
      const printersPct = Math.max(0, Math.min(100, Math.round((printersUsed / printersLimit) * 100)));

      const modelsUsed = state.models.length;
      const modelsLimit = Math.max(modelsUsed, Number(u.limit_models || 0) || 0) || modelsUsed || 1;
      const modelsPct = modelsLimit ? Math.max(0, Math.min(100, Math.round((modelsUsed / modelsLimit) * 100))) : 0;

      const quotaBar = (label, used, limit, pct, tone='info') => {
        const fill = tone === 'good'
          ? 'linear-gradient(90deg, rgba(0,200,83,.85), rgba(6,182,212,.65))'
          : 'linear-gradient(90deg, rgba(47,107,255,.85), rgba(6,182,212,.75))';
        return `
          <div class="pf-card p-3" style="box-shadow:none; border: 1px solid rgba(0,0,0,.06); background: rgba(0,0,0,.02);">
            <div class="flex items-center justify-between">
              <div class="text-xs font-semibold" style="color: var(--pf-sub);">${escapeHtml(label)}</div>
              <div class="text-xs font-semibold">${escapeHtml(used)}/${escapeHtml(limit)}</div>
            </div>
            <div class="mt-2 h-2 rounded-full" style="background: rgba(0,0,0,.06);">
              <div class="h-2 rounded-full" style="width:${pct}%; background: ${fill};"></div>
            </div>
          </div>
        `;
      };

      const adminPanel = u.is_admin ? `
        <div class="pf-card p-4">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">Админ‑панель</div>
            <span class="pf-badge" style="background: rgba(255,59,48,.12); border-color: rgba(255,59,48,.22); color:#a61a12;">ADMIN</span>
          </div>
          <div class="mt-2 text-xs" style="color: var(--pf-sub);">Создание промокодов, выдача/снятие подписок, бан/разбан пользователей.</div>

          <div class="mt-3 grid gap-3">
            <div class="pf-card p-3" style="box-shadow:none; border: 1px solid rgba(0,0,0,.06);">
              <div class="text-xs font-semibold" style="color: var(--pf-sub);">Промокоды</div>
              <div class="mt-2 grid grid-cols-2 gap-2">
                <input id="adminPromoCode" class="rounded-xl bg-black/5 border border-black/10 px-3 py-2 text-xs" placeholder="Код (например PRINTFARM-2026)" />
                <select id="adminPromoPlan" class="rounded-xl bg-black/5 border border-black/10 px-3 py-2 text-xs">
                  <option value="FREE">FREE</option>
                  <option value="PRO">PRO</option>
                  <option value="STUDIO">STUDIO</option>
                </select>
                <input id="adminPromoLimit" class="rounded-xl bg-black/5 border border-black/10 px-3 py-2 text-xs" placeholder="Лимит принтеров" value="1" />
                <input id="adminPromoDays" class="rounded-xl bg-black/5 border border-black/10 px-3 py-2 text-xs" placeholder="Дней (пусто = бессрочно)" />
              </div>
              <div class="mt-2 flex items-center justify-between gap-2">
                <label class="text-xs" style="color: var(--pf-sub);">
                  <input id="adminPromoSingle" type="checkbox" class="align-middle mr-2" checked />
                  Одноразовый
                </label>
                <button id="adminCreatePromo" class="px-3 py-2 rounded-xl text-xs font-semibold" style="border: 1px solid rgba(47,107,255,.22); background: rgba(47,107,255,.08); color: #1d46aa;">Создать</button>
              </div>
            </div>

            <div class="pf-card p-3" style="box-shadow:none; border: 1px solid rgba(0,0,0,.06);">
              <div class="text-xs font-semibold" style="color: var(--pf-sub);">Пользователь</div>
              <div class="mt-2 grid grid-cols-2 gap-2">
                <input id="adminUserId" class="rounded-xl bg-black/5 border border-black/10 px-3 py-2 text-xs" placeholder="User ID" />
                <select id="adminUserPlan" class="rounded-xl bg-black/5 border border-black/10 px-3 py-2 text-xs">
                  <option value="FREE">FREE</option>
                  <option value="PRO">PRO</option>
                  <option value="STUDIO">STUDIO</option>
                </select>
                <input id="adminUserLimit" class="rounded-xl bg-black/5 border border-black/10 px-3 py-2 text-xs" placeholder="Лимит принтеров" value="1" />
                <input id="adminUserDays" class="rounded-xl bg-black/5 border border-black/10 px-3 py-2 text-xs" placeholder="Дней (пусто = снять дату)" />
              </div>
              <div class="mt-2 flex flex-wrap gap-2">
                <button id="adminSetSub" class="flex-1 px-3 py-2 rounded-xl text-xs font-semibold" style="border: 1px solid rgba(47,107,255,.22); background: rgba(47,107,255,.08); color: #1d46aa;">Выдать/обновить подписку</button>
                <button id="adminBan" class="px-3 py-2 rounded-xl text-xs font-semibold" style="border: 1px solid rgba(255,59,48,.22); background: rgba(255,59,48,.10); color:#a61a12;">Бан</button>
                <button id="adminUnban" class="px-3 py-2 rounded-xl text-xs font-semibold" style="border: 1px solid rgba(0,200,83,.22); background: rgba(0,200,83,.10); color:#067a34;">Разбан</button>
              </div>
              <div class="mt-2 text-[11px]" style="color: var(--pf-sub);">Требуются backend‑эндпоинты: <code class="px-1 py-[1px] rounded bg-black/5">POST /api/admin/promo/create</code>, <code class="px-1 py-[1px] rounded bg-black/5">POST /api/admin/user/subscription</code>, <code class="px-1 py-[1px] rounded bg-black/5">POST /api/admin/user/ban</code>.</div>
            </div>

            <div class="pf-card p-3" style="box-shadow:none; border: 1px solid rgba(0,0,0,.06);">
              <div class="text-xs font-semibold" style="color: var(--pf-sub);">Последний результат</div>
              <div class="mt-2 text-xs" style="color: var(--pf-sub);">${escapeHtml(state.admin.lastResult || '—')}</div>
            </div>
          </div>
        </div>
      ` : '';

      root.innerHTML = `
        <div class="space-y-3">
          <div class="pf-card p-4">
            <div class="flex items-center gap-3">
              ${avatar}
              <div class="min-w-0">
                <div class="text-base font-semibold truncate">${escapeHtml(u.first_name || 'Пользователь')}</div>
                <div class="text-xs" style="color: var(--pf-sub);">ID: <span class="font-semibold">${escapeHtml(u.id ?? '—')}</span>${u.is_admin ? ' · <span class="font-semibold" style="color:#a61a12">Администратор</span>' : ''}${u.is_banned ? ' · <span class="font-semibold" style="color:#a61a12">BAN</span>' : ''}</div>
                <div class="mt-2 flex items-center gap-2">
                  <span class="pf-pill pf-pill--info">План: ${escapeHtml(u.plan || 'FREE')}</span>
                  <span class="pf-badge">${state.apiOk ? 'API OK' : 'API OFF'}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="pf-card p-4">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">Тарификация</div>
              <span class="pf-pill pf-pill--info">Лимит принтеров: ${escapeHtml(printersLimit)}</span>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2">
              ${quotaBar('Принтеры', printersUsed, printersLimit, printersPct, printersUsed <= printersLimit ? 'good' : 'warn')}
              ${quotaBar('Модели', modelsUsed, modelsLimit, modelsPct, 'info')}
            </div>
          </div>

          ${adminPanel}

          <div class="pf-card p-4">
            <div class="text-sm font-semibold">initData (для отладки)</div>
            <div class="mt-2 flex items-center gap-2">
              <input id="initDataInput" class="w-full rounded-xl bg-black/5 border border-black/10 px-3 py-2 text-xs" placeholder="Подставится автоматически из Telegram WebApp" value="${escapeHtml(initData)}" />
              <button id="applyInitData" class="rounded-xl px-3 py-2 text-xs" style="background: rgba(0,0,0,.04);">Применить</button>
            </div>
            <div class="mt-2 text-[11px]" style="color: var(--pf-sub);">Если мини‑апп открыт в Telegram — initData будет считано автоматически. Иначе вставьте вручную и нажмите «Применить».</div>
          </div>

          <div class="pf-card p-4">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">Диагностика</div>
              <span class="pf-pill ${state.apiOk ? 'pf-pill--good' : 'pf-pill--bad'}">${state.apiOk ? 'OK' : 'ERROR'}</span>
            </div>
            <div class="mt-2 text-xs" style="color: var(--pf-sub);">
              <div class="flex items-center justify-between"><span>Серверное время</span><span class="font-semibold">${escapeHtml(fmtDateTime(state.server_time))}</span></div>
              <div class="flex items-center justify-between"><span>Последняя ошибка</span><span class="font-semibold truncate max-w-[12rem]">${escapeHtml(state.debug.lastError || '—')}</span></div>
              <div class="flex items-center justify-between"><span>Telegram WebApp</span><span class="font-semibold">${escapeHtml(window.Telegram?.WebApp ? 'Да' : 'Нет')}</span></div>
            </div>
          </div>
        </div>
      `;

      $('#applyInitData')?.addEventListener('click', async () => {
        const v = $('#initDataInput')?.value?.trim() || '';
        await load(v);
        renderAll();
        toast('initData применён.');
      });

      if (u.is_admin){
        $('#adminCreatePromo')?.addEventListener('click', async () => {
          const code = ($('#adminPromoCode')?.value || '').trim();
          const plan = ($('#adminPromoPlan')?.value || 'FREE').trim();
          const limit = Number(($('#adminPromoLimit')?.value || '1').trim());
          const daysRaw = ($('#adminPromoDays')?.value || '').trim();
          const days = daysRaw ? Number(daysRaw) : null;
          const single = Boolean($('#adminPromoSingle')?.checked);
          if (!code){ toast('Введите код промокода.'); return; }
          try{
            const res = await apiAdmin('/api/admin/promo/create', { code, plan, limit_printers: limit, expires_days: days, is_single_use: single }, $('#initDataInput')?.value?.trim() || initData);
            state.admin.lastResult = `Промокод создан: ${safeText(res?.code || code)}`;
            toast('Промокод создан.');
            renderAll();
          } catch (e){
            state.admin.lastResult = safeText(e?.message || e);
            toast(`Ошибка: ${state.admin.lastResult}`, { ms: 4200 });
            renderAll();
          }
        });

        $('#adminSetSub')?.addEventListener('click', async () => {
          const user_id = Number(($('#adminUserId')?.value || '').trim());
          const plan = ($('#adminUserPlan')?.value || 'FREE').trim();
          const limit = Number(($('#adminUserLimit')?.value || '1').trim());
          const daysRaw = ($('#adminUserDays')?.value || '').trim();
          const days = daysRaw ? Number(daysRaw) : null;
          if (!Number.isFinite(user_id) || user_id <= 0){ toast('Введите корректный User ID.'); return; }
          try{
            const res = await apiAdmin('/api/admin/user/subscription', { user_id, plan, limit_printers: limit, expires_days: days }, $('#initDataInput')?.value?.trim() || initData);
            state.admin.lastResult = `Подписка обновлена для ${user_id}: ${safeText(res?.plan || plan)}`;
            toast('Подписка обновлена.');
            renderAll();
          } catch (e){
            state.admin.lastResult = safeText(e?.message || e);
            toast(`Ошибка: ${state.admin.lastResult}`, { ms: 4200 });
            renderAll();
          }
        });

        const banCommon = async (banned) => {
          const user_id = Number(($('#adminUserId')?.value || '').trim());
          if (!Number.isFinite(user_id) || user_id <= 0){ toast('Введите корректный User ID.'); return; }
          try{
            await apiAdmin('/api/admin/user/ban', { user_id, banned }, $('#initDataInput')?.value?.trim() || initData);
            state.admin.lastResult = banned ? `Пользователь ${user_id} забанен.` : `Пользователь ${user_id} разбанен.`;
            toast(banned ? 'Бан применён.' : 'Разбан применён.');
            renderAll();
          } catch (e){
            state.admin.lastResult = safeText(e?.message || e);
            toast(`Ошибка: ${state.admin.lastResult}`, { ms: 4200 });
            renderAll();
          }
        };

        $('#adminBan')?.addEventListener('click', () => banCommon(true));
        $('#adminUnban')?.addEventListener('click', () => banCommon(false));
      }
    }

    function renderAll(){
      $('#loading')?.classList.add('hidden');
      $('#tab-printers')?.classList.toggle('hidden', state.ui.activeTab !== 'printers');
      $('#tab-work')?.classList.toggle('hidden', state.ui.activeTab !== 'work');
      $('#tab-profile')?.classList.toggle('hidden', state.ui.activeTab !== 'profile');

      if (state.ui.activeTab === 'printers') renderPrinters();
      if (state.ui.activeTab === 'work') renderWork();
      if (state.ui.activeTab === 'profile') renderProfile();

      const sub = state.apiOk
        ? `Данные синхронизированы · План: ${safeText(state.user.plan || 'FREE')}`
        : 'Нет связи с сервером';
      $('#subtitle').textContent = sub;
    }

    function setTab(tab){
      state.ui.activeTab = tab;
      $$('.pf-tab-btn').forEach(b => {
        const is = b.getAttribute('data-tab') === tab;
        b.setAttribute('aria-selected', is ? 'true' : 'false');
      });
      renderAll();
    }

    function openFilter(open){
      const m = $('#filterModal');
      if (!m) return;
      m.dataset.open = open ? 'true' : 'false';
      if (open) $('#ordersFirst').checked = Boolean(state.ui.filters.ordersFirst);
    }

    function bindUI(){
      $$('.pf-tab-btn').forEach(btn => btn.addEventListener('click', () => setTab(btn.getAttribute('data-tab'))));

      const si = $('#searchInput');
      si?.addEventListener('input', () => { state.ui.search = safeText(si.value); renderAll(); });
      $('#clearSearch')?.addEventListener('click', () => { state.ui.search=''; if (si) si.value=''; renderAll(); });

      $('#refreshBtn')?.addEventListener('click', async () => {
        toast('Обновляю…');
        $('#loading')?.classList.remove('hidden');
        try { await load(getTgInitData()); }
        finally { renderAll(); }
      });

      $('#filterBtn')?.addEventListener('click', () => openFilter(true));
      $('#closeFilter')?.addEventListener('click', () => openFilter(false));
      $('#filterModal')?.addEventListener('click', (e) => { if (e.target?.id === 'filterModal') openFilter(false); });

      $('#filterModal')?.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-filter]');
        if (!btn) return;
        const filter = btn.getAttribute('data-filter');
        const value = btn.getAttribute('data-value');
        if (filter === 'printer_state') state.ui.filters.printer_state = value;
        if (filter === 'model_sort') state.ui.filters.model_sort = value;
        toast('Фильтр выбран. Нажмите «Применить».', { ms: 1400 });
      });

      $('#applyFilters')?.addEventListener('click', () => {
        state.ui.filters.ordersFirst = Boolean($('#ordersFirst')?.checked);
        openFilter(false);
        renderAll();
        toast('Фильтры применены.');
      });

      $('#resetFilters')?.addEventListener('click', () => {
        state.ui.filters = { printer_state: 'all', model_sort: 'new', ordersFirst: true };
        if ($('#ordersFirst')) $('#ordersFirst').checked = true;
        openFilter(false);
        renderAll();
        toast('Фильтры сброшены.');
      });

      window.addEventListener('keydown', (e) => { if (e.key === 'Escape') openFilter(false); });
    }

    async function load(initData){
      state.debug.lastError = null;
      try{
        const payload = await apiBootstrap(initData);
        state.apiOk = true;
        $('#banner')?.classList.add('hidden');
        normalizeFromBackend(payload);
      } catch (e){
        state.apiOk = false;
        state.debug.lastError = safeText(e?.message || e);
        $('#banner')?.classList.remove('hidden');
        const u = getTelegramUserUnsafe();
        if (u && !state.user.id){ state.user.id = u.id; state.user.first_name = u.first_name; state.user.photo_url = u.photo_url || state.user.photo_url; }
      }
    }

    async function init(){
      applyTelegramChrome();
      bindUI();
      document.title = `PrintFarm v${APP_VERSION}`;

      $('#loading')?.classList.remove('hidden');
      await load(getTgInitData());
      renderAll();
      toast(state.apiOk ? 'Подключение к серверу установлено.' : 'Не удалось подключиться к API.', { ms: 2800 });
    }

    init();
  </script>
</body>
</html>
