<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Print Farm</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ═══════════════════════════════════════════════════════════════════════
           CSS VARIABLES & RESET
        ═══════════════════════════════════════════════════════════════════════ */
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #242424;
            --bg-card: #1e1e1e;
            --bg-card-hover: #2a2a2a;
            --bg-input: #1a1a1a;
            --border-color: #333;
            --border-light: #444;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-tertiary: #808080;
            --text-muted: #606060;
            --accent-primary: #6c5ce7;
            --accent-primary-hover: #7d6ff0;
            --accent-primary-dim: rgba(108, 92, 231, 0.15);
            --accent-success: #00b894;
            --accent-success-dim: rgba(0, 184, 148, 0.15);
            --accent-warning: #fdcb6e;
            --accent-warning-dim: rgba(253, 203, 110, 0.15);
            --accent-error: #e17055;
            --accent-error-dim: rgba(225, 112, 85, 0.15);
            --accent-info: #74b9ff;
            --accent-info-dim: rgba(116, 185, 255, 0.15);
            --status-idle: #00b894;
            --status-printing: #0984e3;
            --status-paused: #fdcb6e;
            --status-error: #d63031;
            --status-finished: #6c5ce7;
            --status-repair: #e84393;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.5);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --header-height: 60px;
            --nav-height: 65px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.5;
        }

        body {
            padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 10px);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: var(--radius-full); }

        /* ═══════════════════════════════════════════════════════════════════════
           ICONS
        ═══════════════════════════════════════════════════════════════════════ */
        .icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .icon svg {
            width: 100%;
            height: 100%;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .icon-xs { width: 14px; height: 14px; }
        .icon-sm { width: 18px; height: 18px; }
        .icon-md { width: 22px; height: 22px; }
        .icon-lg { width: 26px; height: 26px; }
        .icon-xl { width: 32px; height: 32px; }
        .icon-2xl { width: 48px; height: 48px; }

        /* Flag icons - цветные SVG */
        .flag-icon {
            width: 24px;
            height: 18px;
            border-radius: 3px;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .flag-icon svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           HEADER
        ═══════════════════════════════════════════════════════════════════════ */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 100;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary), #a29bfe);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, #b0b0b0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
        }

        .user-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-role {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            letter-spacing: 0.5px;
        }

        .user-role.owner {
            background: var(--accent-primary-dim);
            color: var(--accent-primary);
        }

        .user-role.worker {
            background: var(--accent-success-dim);
            color: var(--accent-success);
        }

        /* ═══════════════════════════════════════════════════════════════════════
           MAIN CONTENT
        ═══════════════════════════════════════════════════════════════════════ */
        .main-content {
            padding-top: var(--header-height);
            min-height: 100vh;
        }

        .page {
            display: none;
            padding: 16px;
            animation: pageIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes pageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header {
            margin-bottom: 20px;
        }

        .page-title {
            font-size: 26px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-tertiary);
        }

        /* ═══════════════════════════════════════════════════════════════════════
           STATS GRID
        ═══════════════════════════════════════════════════════════════════════ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 400px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 14px 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--stat-color, var(--border-color));
        }

        .stat-card.primary { --stat-color: var(--accent-primary); }
        .stat-card.success { --stat-color: var(--accent-success); }
        .stat-card.warning { --stat-color: var(--accent-warning); }
        .stat-card.error { --stat-color: var(--accent-error); }
        .stat-card.info { --stat-color: var(--accent-info); }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1.1;
        }

        .stat-card.primary .stat-value { color: var(--accent-primary); }
        .stat-card.success .stat-value { color: var(--accent-success); }
        .stat-card.warning .stat-value { color: var(--accent-warning); }
        .stat-card.error .stat-value { color: var(--accent-error); }
        .stat-card.info .stat-value { color: var(--accent-info); }

        .stat-label {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           ACTIONS BAR
        ═══════════════════════════════════════════════════════════════════════ */
        .actions-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .actions-bar .btn {
            flex: 1;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           BUTTONS
        ═══════════════════════════════════════════════════════════════════════ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), #5f50e0);
            color: white;
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            box-shadow: 0 6px 16px rgba(108, 92, 231, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-card-hover);
            border-color: var(--border-light);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-success), #00a085);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--accent-warning), #f0b84d);
            color: #333;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-error), #d45a4a);
            color: white;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }

        .btn-ghost:hover:not(:disabled) {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 13px;
        }

        .btn-lg {
            padding: 16px 28px;
            font-size: 16px;
        }

        .btn-block {
            width: 100%;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
        }

        .btn-icon.sm {
            width: 32px;
            height: 32px;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           CARDS
        ═══════════════════════════════════════════════════════════════════════ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px;
            transition: all var(--transition-fast);
        }

        .card:hover {
            border-color: var(--border-light);
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }

        .card-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           PRINTER CARDS
        ═══════════════════════════════════════════════════════════════════════ */
        .printer-card {
            position: relative;
            overflow: hidden;
        }

        .printer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--printer-status-color, var(--border-color));
        }

        .printer-card[data-status="idle"]::before { --printer-status-color: var(--status-idle); }
        .printer-card[data-status="printing"]::before { --printer-status-color: var(--status-printing); }
        .printer-card[data-status="paused"]::before { --printer-status-color: var(--status-paused); }
        .printer-card[data-status="error"]::before { --printer-status-color: var(--status-error); }
        .printer-card[data-status="finished"]::before { --printer-status-color: var(--status-finished); }
        .printer-card[data-status="repair"]::before { --printer-status-color: var(--status-repair); }

        .printer-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 12px;
        }

        .printer-icon-wrap {
            width: 48px;
            height: 48px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
        }

        .printer-icon-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-md);
        }

        .printer-info {
            flex: 1;
            min-width: 0;
        }

        .printer-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .printer-model {
            font-size: 12px;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .printer-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .printer-status[data-status="idle"] {
            background: var(--accent-success-dim);
            color: var(--accent-success);
        }

        .printer-status[data-status="printing"] {
            background: var(--accent-info-dim);
            color: var(--accent-info);
        }

        .printer-status[data-status="paused"] {
            background: var(--accent-warning-dim);
            color: var(--accent-warning);
        }

        .printer-status[data-status="error"] {
            background: var(--accent-error-dim);
            color: var(--accent-error);
        }

        .printer-status[data-status="finished"] {
            background: var(--accent-primary-dim);
            color: var(--accent-primary);
        }

        .printer-status[data-status="repair"] {
            background: rgba(232, 67, 147, 0.15);
            color: #e84393;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-dot.pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .printer-task {
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--accent-info);
        }

        .printer-task-label {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-bottom: 4px;
        }

        .printer-task-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .printer-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .printer-actions .btn {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           TASK CARDS
        ═══════════════════════════════════════════════════════════════════════ */
        .task-card {
            position: relative;
            border-left: 4px solid var(--task-status-color, var(--border-color));
        }

        .task-card[data-status="pending"] { --task-status-color: var(--accent-warning); }
        .task-card[data-status="in_progress"] { --task-status-color: var(--accent-info); background: rgba(116, 185, 255, 0.03); }
        .task-card[data-status="done"] { --task-status-color: var(--accent-success); opacity: 0.7; }
        .task-card[data-status="skipped"], .task-card[data-status="canceled"] { --task-status-color: var(--text-muted); opacity: 0.5; }

        .task-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 12px;
        }

        .task-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .task-slot {
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .task-slot[data-slot="day"] {
            background: var(--accent-warning-dim);
            color: var(--accent-warning);
        }

        .task-slot[data-slot="night"] {
            background: var(--accent-primary-dim);
            color: var(--accent-primary);
        }

        .task-product {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-status-badge {
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .task-card[data-status="pending"] .task-status-badge {
            background: var(--accent-warning-dim);
            color: var(--accent-warning);
        }

        .task-card[data-status="in_progress"] .task-status-badge {
            background: var(--accent-info-dim);
            color: var(--accent-info);
        }

        .task-card[data-status="done"] .task-status-badge {
            background: var(--accent-success-dim);
            color: var(--accent-success);
        }

        .task-meta {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .task-meta-item {
            text-align: center;
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
        }

        .task-meta-label {
            font-size: 10px;
            color: var(--text-tertiary);
            margin-bottom: 2px;
            text-transform: uppercase;
        }

        .task-meta-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .task-time {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
        }

        .task-time-icon {
            color: var(--text-tertiary);
        }

        .task-time-text {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .task-time-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .task-actions .btn {
            flex: 1;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           PRODUCT CARDS
        ═══════════════════════════════════════════════════════════════════════ */
        .product-card {
            position: relative;
        }

        .product-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }

        .product-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .product-description {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-bottom: 12px;
        }

        .variants-count {
            font-size: 12px;
            color: var(--text-muted);
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
        }

        .variant-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .variant-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--accent-primary);
        }

        .variant-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .variant-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .variant-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .product-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .product-actions .btn {
            flex: 1;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           FILTER BAR
        ═══════════════════════════════════════════════════════════════════════ */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
        }

        .filter-bar::-webkit-scrollbar {
            display: none;
        }

        .filter-btn {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-fast);
        }

        .filter-btn:hover {
            border-color: var(--border-light);
            color: var(--text-primary);
        }

        .filter-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           SETTINGS
        ═══════════════════════════════════════════════════════════════════════ */
        .settings-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .settings-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        .settings-section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-section-icon {
            width: 40px;
            height: 40px;
            background: var(--accent-primary-dim);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-primary);
        }

        .settings-section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .settings-section-subtitle {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .settings-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        @media (max-width: 400px) {
            .settings-row { grid-template-columns: 1fr; }
        }

        .settings-item {
            margin-bottom: 16px;
        }

        .settings-item:last-child {
            margin-bottom: 0;
        }

        .settings-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .settings-input {
            width: 100%;
            padding: 12px 14px;
            font-size: 14px;
            color: var(--text-primary);
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            outline: none;
            transition: all var(--transition-fast);
        }

        .settings-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-primary-dim);
        }

        .settings-input::placeholder {
            color: var(--text-muted);
        }

        .settings-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .settings-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            cursor: pointer;
        }

        .settings-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent-primary);
            cursor: pointer;
        }

        .settings-checkbox-label {
            font-size: 14px;
            color: var(--text-primary);
        }

        .settings-checkbox-hint {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* ═══════════════════════════════════════════════════════════════════════
           LANGUAGE SELECTOR
        ═══════════════════════════════════════════════════════════════════════ */
        .language-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .language-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .language-option:hover {
            border-color: var(--border-light);
            background: var(--bg-card-hover);
        }

        .language-option.active {
            border-color: var(--accent-primary);
            background: var(--accent-primary-dim);
        }

        .language-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .language-native {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* ═══════════════════════════════════════════════════════════════════════
           TEAM CODE
        ═══════════════════════════════════════════════════════════════════════ */
        .team-code-box {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
        }

        .team-code-value {
            flex: 1;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-primary);
            letter-spacing: 3px;
            text-align: center;
        }

        .team-code-value.empty {
            font-size: 14px;
            color: var(--text-muted);
            letter-spacing: normal;
        }

        .team-code-actions {
            display: flex;
            gap: 8px;
        }

        .team-members-list {
            margin-top: 16px;
        }

        .team-member {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
        }

        .team-member:last-child {
            margin-bottom: 0;
        }

        .team-member-avatar {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--accent-primary), #a29bfe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
        }

        .team-member-info {
            flex: 1;
            min-width: 0;
        }

        .team-member-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .team-member-username {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .team-member-date {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ═══════════════════════════════════════════════════════════════════════
           FAQ & HELP
        ═══════════════════════════════════════════════════════════════════════ */
        .faq-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .faq-item {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .faq-question {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .faq-question:hover {
            background: var(--bg-card-hover);
        }

        .faq-question-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .faq-toggle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
            transition: transform var(--transition-fast);
        }

        .faq-item.open .faq-toggle {
            transform: rotate(180deg);
        }

        .faq-answer {
            display: none;
            padding: 0 16px 16px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .faq-item.open .faq-answer {
            display: block;
        }

        .guide-section {
            margin-bottom: 24px;
        }

        .guide-section:last-child {
            margin-bottom: 0;
        }

        .guide-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .guide-title-icon {
            width: 28px;
            height: 28px;
            background: var(--accent-primary-dim);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-primary);
        }

        .guide-content {
            font-size: 13px;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        .guide-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .guide-content li {
            margin-bottom: 6px;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           TABS (внутри настроек)
        ═══════════════════════════════════════════════════════════════════════ */
        .tabs-header {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-tertiary);
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .tab-btn:hover {
            color: var(--text-secondary);
        }

        .tab-btn.active {
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ═══════════════════════════════════════════════════════════════════════
           BOTTOM NAVIGATION
        ═══════════════════════════════════════════════════════════════════════ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(var(--nav-height) + var(--safe-bottom));
            padding-bottom: var(--safe-bottom);
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: stretch;
            z-index: 100;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: var(--text-muted);
            text-decoration: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
        }

        .nav-item:hover {
            color: var(--text-secondary);
        }

        .nav-item.active {
            color: var(--accent-primary);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: var(--accent-primary);
            border-radius: 0 0 3px 3px;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        .nav-badge {
            position: absolute;
            top: 6px;
            right: calc(50% - 22px);
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: var(--accent-error);
            color: white;
            font-size: 10px;
            font-weight: 700;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           MODALS
        ═══════════════════════════════════════════════════════════════════════ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            background: var(--bg-secondary);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            overflow: hidden;
            transform: translateY(100%);
            transition: transform var(--transition-normal);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        @media (min-width: 640px) {
            .modal-overlay {
                align-items: center;
                padding: 20px;
            }

            .modal {
                border-radius: var(--radius-xl);
                max-height: 85vh;
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .modal-footer .btn {
            flex: 1;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           FORMS
        ═══════════════════════════════════════════════════════════════════════ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-label.required::after {
            content: ' *';
            color: var(--accent-error);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 14px 16px;
            font-size: 15px;
            color: var(--text-primary);
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            outline: none;
            transition: all var(--transition-fast);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-primary-dim);
        }

        .form-input::placeholder,
        .form-textarea::placeholder {
            color: var(--text-muted);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23808080' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 44px;
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .form-error {
            font-size: 12px;
            color: var(--accent-error);
            margin-top: 6px;
        }

        /* Variants Editor */
        .variants-editor {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            background: var(--bg-tertiary);
        }

        .variants-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 12px;
        }

        .variant-row {
            display: grid;
            grid-template-columns: 1fr 80px 80px 36px;
            gap: 8px;
            align-items: center;
        }

        .variant-row input {
            padding: 10px 12px;
            font-size: 13px;
        }

        .variant-remove {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            background: var(--accent-error-dim);
            border: none;
            color: var(--accent-error);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .variant-remove:hover {
            background: var(--accent-error);
            color: white;
        }

        .add-variant-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-tertiary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .add-variant-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: var(--accent-primary-dim);
        }

        /* ═══════════════════════════════════════════════════════════════════════
           TOAST NOTIFICATIONS
        ═══════════════════════════════════════════════════════════════════════ */
        .toast-container {
            position: fixed;
            top: calc(var(--header-height) + 10px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 300;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: calc(100% - 32px);
            max-width: 400px;
            pointer-events: none;
        }

        .toast {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            pointer-events: auto;
            animation: toastIn 0.3s ease;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .toast.hiding {
            animation: toastOut 0.3s ease forwards;
        }

        @keyframes toastOut {
            from {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .toast.success { border-left: 4px solid var(--accent-success); }
        .toast.success .toast-icon { color: var(--accent-success); }

        .toast.error { border-left: 4px solid var(--accent-error); }
        .toast.error .toast-icon { color: var(--accent-error); }

        .toast.warning { border-left: 4px solid var(--accent-warning); }
        .toast.warning .toast-icon { color: var(--accent-warning); }

        .toast.info { border-left: 4px solid var(--accent-info); }
        .toast.info .toast-icon { color: var(--accent-info); }

        .toast-content {
            flex: 1;
            min-width: 0;
        }

        .toast-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .toast-close {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .toast-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* ═══════════════════════════════════════════════════════════════════════
           LOADING OVERLAY
        ═══════════════════════════════════════════════════════════════════════ */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 15, 15, 0.9);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            z-index: 400;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-fast);
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ═══════════════════════════════════════════════════════════════════════
           EMPTY STATE
        ═══════════════════════════════════════════════════════════════════════ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            text-align: center;
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            color: var(--text-muted);
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
            color: var(--text-tertiary);
            max-width: 280px;
            margin-bottom: 24px;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           SUMMARY PANEL
        ═══════════════════════════════════════════════════════════════════════ */
        .summary-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
        }

        .summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .summary-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
        }

        .summary-item-label {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .summary-item-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-warnings {
            margin-top: 12px;
            padding: 12px;
            background: var(--accent-warning-dim);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--accent-warning);
        }

        .summary-warning {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--accent-warning);
        }

        /* ═══════════════════════════════════════════════════════════════════════
           UTILITIES
        ═══════════════════════════════════════════════════════════════════════ */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 4px; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .gap-4 { gap: 16px; }
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 12px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .text-center { text-align: center; }
        .text-sm { font-size: 13px; }
        .text-xs { font-size: 11px; }
        .text-muted { color: var(--text-tertiary); }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .w-full { width: 100%; }

        /* ═══════════════════════════════════════════════════════════════════════
           RESPONSIVE
        ═══════════════════════════════════════════════════════════════════════ */
        @media (min-width: 768px) {
            .card-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .bottom-nav {
                max-width: 500px;
                left: 50%;
                transform: translateX(-50%);
                border-radius: var(--radius-xl) var(--radius-xl) 0 0;
                border-left: 1px solid var(--border-color);
                border-right: 1px solid var(--border-color);
            }
        }

        @media (min-width: 1024px) {
            .card-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- ═══════════════════════════════════════════════════════════════════════
         HEADER
    ═══════════════════════════════════════════════════════════════════════ -->
    <header class="header">
        <div class="header-left">
            <div class="header-logo">
                <span class="icon icon-lg">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                </span>
            </div>
            <span class="header-title">Print Farm</span>
        </div>
        <div class="header-right">
            <div class="user-info">
                <span class="user-name" id="userName">...</span>
                <span class="user-role owner" id="userRole">owner</span>
            </div>
        </div>
    </header>

    <!-- ═══════════════════════════════════════════════════════════════════════
         TOAST CONTAINER
    ═══════════════════════════════════════════════════════════════════════ -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ═══════════════════════════════════════════════════════════════════════
         LOADING OVERLAY
    ═══════════════════════════════════════════════════════════════════════ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText" data-i18n="loading">Загрузка...</div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════════
         MAIN CONTENT
    ═══════════════════════════════════════════════════════════════════════ -->
    <main class="main-content">
        <!-- ═══════════════════════════════════════════════════════════════════
             PRINTERS PAGE
        ═══════════════════════════════════════════════════════════════════ -->
        <section class="page active" id="pagePrinters" data-page="printers">
            <div class="page-header">
                <h1 class="page-title" data-i18n="printers_title">Принтеры</h1>
                <p class="page-subtitle" data-i18n="printers_subtitle">Управление 3D-принтерами</p>
            </div>

            <div class="stats-grid" id="printerStats">
                <div class="stat-card">
                    <div class="stat-value" id="statTotalPrinters">0</div>
                    <div class="stat-label" data-i18n="stat_total">Всего</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="statIdlePrinters">0</div>
                    <div class="stat-label" data-i18n="stat_idle">Свободно</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value" id="statPrintingPrinters">0</div>
                    <div class="stat-label" data-i18n="stat_printing">Печатает</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="statOtherPrinters">0</div>
                    <div class="stat-label" data-i18n="stat_other">Другое</div>
                </div>
            </div>

            <div class="actions-bar" id="printerActionsBar">
                <button class="btn btn-primary" onclick="openAddPrinterModal()">
                    <span class="icon icon-sm">
                        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </span>
                    <span data-i18n="btn_add_printer">Добавить принтер</span>
                </button>
            </div>

            <div class="card-grid" id="printersGrid"></div>

            <div class="empty-state hidden" id="printersEmpty">
                <div class="empty-state-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="4" y="4" width="16" height="16" rx="2"/>
                        <rect x="8" y="8" width="8" height="8"/>
                        <path d="M4 12H2M22 12h-2M12 4V2M12 22v-2"/>
                    </svg>
                </div>
                <h3 class="empty-state-title" data-i18n="empty_printers_title">Нет принтеров</h3>
                <p class="empty-state-text" data-i18n="empty_printers_text">Добавьте первый 3D-принтер для начала работы</p>
                <button class="btn btn-primary" onclick="openAddPrinterModal()">
                    <span class="icon icon-sm">
                        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </span>
                    <span data-i18n="btn_add_printer">Добавить принтер</span>
                </button>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             TASKS PAGE
        ═══════════════════════════════════════════════════════════════════ -->
        <section class="page" id="pageTasks" data-page="tasks">
            <div class="page-header">
                <h1 class="page-title" data-i18n="tasks_title">Задачи</h1>
                <p class="page-subtitle" data-i18n="tasks_subtitle">Очередь печати и расписание</p>
            </div>

            <div class="stats-grid" id="taskStats">
                <div class="stat-card warning">
                    <div class="stat-value" id="statPendingTasks">0</div>
                    <div class="stat-label" data-i18n="stat_pending">Ожидает</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value" id="statInProgressTasks">0</div>
                    <div class="stat-label" data-i18n="stat_in_progress">В работе</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="statDoneTasks">0</div>
                    <div class="stat-label" data-i18n="stat_done">Готово</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statTotalTasks">0</div>
                    <div class="stat-label" data-i18n="stat_total">Всего</div>
                </div>
            </div>

            <div class="actions-bar" id="taskActionsBar">
                <button class="btn btn-secondary" onclick="importOrders()">
                    <span class="icon icon-sm">
                        <svg viewBox="0 0 24 24">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </span>
                    <span data-i18n="btn_import">Импорт</span>
                </button>
                <button class="btn btn-primary" onclick="generateTasks()">
                    <span class="icon icon-sm">
                        <svg viewBox="0 0 24 24">
                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                        </svg>
                    </span>
                    <span data-i18n="btn_generate">Генерация</span>
                </button>
            </div>

            <div class="filter-bar" id="taskFilters">
                <button class="filter-btn active" data-filter="all" data-i18n="filter_all">Все</button>
                <button class="filter-btn" data-filter="pending" data-i18n="filter_pending">Ожидает</button>
                <button class="filter-btn" data-filter="in_progress" data-i18n="filter_in_progress">В работе</button>
                <button class="filter-btn" data-filter="done" data-i18n="filter_done">Готово</button>
                <button class="filter-btn" data-filter="day" data-i18n="filter_day">День</button>
                <button class="filter-btn" data-filter="night" data-i18n="filter_night">Ночь</button>
            </div>

            <div class="summary-panel hidden" id="algorithmSummary">
                <div class="summary-header">
                    <span class="summary-title" data-i18n="summary_title">Результат генерации</span>
                    <button class="btn btn-ghost btn-icon sm" onclick="hideSummary()">
                        <span class="icon icon-sm">
                            <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </span>
                    </button>
                </div>
                <div class="summary-grid" id="summaryGrid"></div>
                <div class="summary-warnings hidden" id="summaryWarnings"></div>
            </div>

            <div class="card-list" id="tasksList"></div>

            <div class="empty-state hidden" id="tasksEmpty">
                <div class="empty-state-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
                        <rect x="9" y="3" width="6" height="4" rx="1"/>
                        <path d="M9 14l2 2 4-4"/>
                    </svg>
                </div>
                <h3 class="empty-state-title" data-i18n="empty_tasks_title">Нет задач</h3>
                <p class="empty-state-text" data-i18n="empty_tasks_text">Импортируйте заказы и сгенерируйте задачи автоматически</p>
                <button class="btn btn-primary" onclick="importOrders()">
                    <span class="icon icon-sm">
                        <svg viewBox="0 0 24 24">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </span>
                    <span data-i18n="btn_import_orders">Импортировать заказы</span>
                </button>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             PRODUCTS PAGE
        ═══════════════════════════════════════════════════════════════════ -->
        <section class="page" id="pageProducts" data-page="products">
            <div class="page-header">
                <h1 class="page-title" data-i18n="products_title">Изделия</h1>
                <p class="page-subtitle" data-i18n="products_subtitle">Каталог продукции с вариантами печати</p>
            </div>

            <div class="actions-bar" id="productActionsBar">
                <button class="btn btn-primary" onclick="openAddProductModal()">
                    <span class="icon icon-sm">
                        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </span>
                    <span data-i18n="btn_add_product">Добавить изделие</span>
                </button>
            </div>

            <div class="card-grid" id="productsGrid"></div>

            <div class="empty-state hidden" id="productsEmpty">
                <div class="empty-state-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                </div>
                <h3 class="empty-state-title" data-i18n="empty_products_title">Нет изделий</h3>
                <p class="empty-state-text" data-i18n="empty_products_text">Добавьте изделия с вариантами печати для автоматического планирования</p>
                <button class="btn btn-primary" onclick="openAddProductModal()">
                    <span class="icon icon-sm">
                        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </span>
                    <span data-i18n="btn_add_product">Добавить изделие</span>
                </button>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════
             SETTINGS PAGE
        ═══════════════════════════════════════════════════════════════════ -->
        <section class="page" id="pageSettings" data-page="settings">
            <div class="page-header">
                <h1 class="page-title" data-i18n="settings_title">Настройки</h1>
                <p class="page-subtitle" data-i18n="settings_subtitle">Конфигурация фермы</p>
            </div>

            <!-- Settings Tabs -->
            <div class="tabs-header" id="settingsTabs">
                <button class="tab-btn active" data-tab="general" data-i18n="tab_general">Основные</button>
                <button class="tab-btn" data-tab="team" data-i18n="tab_team">Команда</button>
                <button class="tab-btn" data-tab="help" data-i18n="tab_help">Справка</button>
            </div>

            <div class="settings-container">
                <!-- General Tab -->
                <div class="tab-content active" id="tabGeneral">
                    <!-- Language Settings -->
                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <span class="icon">
                                    <svg viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10"/>
                                        <line x1="2" y1="12" x2="22" y2="12"/>
                                        <path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/>
                                    </svg>
                                </span>
                            </div>
                            <div>
                                <div class="settings-section-title" data-i18n="settings_language">Язык интерфейса</div>
                                <div class="settings-section-subtitle" data-i18n="settings_language_hint">Выберите предпочитаемый язык</div>
                            </div>
                        </div>
                        <div class="language-grid" id="languageGrid">
                            <!-- Language options will be rendered here -->
                        </div>
                    </div>

                    <!-- Work Schedule -->
                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <span class="icon">
                                    <svg viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polyline points="12 6 12 12 16 14"/>
                                    </svg>
                                </span>
                            </div>
                            <div>
                                <div class="settings-section-title" data-i18n="settings_schedule">Рабочий график</div>
                                <div class="settings-section-subtitle" data-i18n="settings_schedule_hint">Настройки рабочего времени</div>
                            </div>
                        </div>

                        <div class="settings-row">
                            <div class="settings-item">
                                <label class="settings-label" data-i18n="label_work_start">Начало работы</label>
                                <input type="number" class="settings-input" id="settingWorkStart" min="0" max="23" value="9">
                            </div>
                            <div class="settings-item">
                                <label class="settings-label" data-i18n="label_work_end">Конец работы</label>
                                <input type="number" class="settings-input" id="settingWorkEnd" min="0" max="23" value="18">
                            </div>
                        </div>

                        <div class="settings-row">
                            <div class="settings-item">
                                <label class="settings-label" data-i18n="label_deadline">Дедлайн (ночь)</label>
                                <input type="number" class="settings-input" id="settingDeadline" min="0" max="23" value="20">
                                <p class="settings-hint" data-i18n="hint_deadline">Начало ночной смены</p>
                            </div>
                            <div class="settings-item">
                                <label class="settings-label" data-i18n="label_changeover">Переналадка (мин)</label>
                                <input type="number" class="settings-input" id="settingChangeover" min="0" value="15">
                                <p class="settings-hint" data-i18n="hint_changeover">Время между печатями</p>
                            </div>
                        </div>

                        <div class="settings-item">
                            <label class="settings-checkbox">
                                <input type="checkbox" id="settingUseNight" checked>
                                <div>
                                    <div class="settings-checkbox-label" data-i18n="label_use_night">Использовать ночную смену</div>
                                    <div class="settings-checkbox-hint" data-i18n="hint_use_night">Запускать печать на ночь</div>
                                </div>
                            </label>
                        </div>

                        <div class="settings-item">
                            <label class="settings-checkbox">
                                <input type="checkbox" id="settingMinimize">
                                <div>
                                    <div class="settings-checkbox-label" data-i18n="label_minimize">Минимизировать принтеры</div>
                                    <div class="settings-checkbox-hint" data-i18n="hint_minimize">Использовать меньше принтеров</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Google Sheets -->
                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <span class="icon">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                        <polyline points="10 9 9 9 8 9"/>
                                    </svg>
                                </span>
                            </div>
                            <div>
                                <div class="settings-section-title">Google Sheets</div>
                                <div class="settings-section-subtitle" data-i18n="settings_sheets_hint">Импорт заказов из таблицы</div>
                            </div>
                        </div>

                        <div class="settings-item">
                            <label class="settings-label">Sheet ID</label>
                            <input type="text" class="settings-input" id="settingSheetId" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms">
                            <p class="settings-hint" data-i18n="hint_sheet_id">ID из URL таблицы Google Sheets</p>
                        </div>

                        <div class="settings-row">
                            <div class="settings-item">
                                <label class="settings-label" data-i18n="label_sheet_name">Лист</label>
                                <input type="text" class="settings-input" id="settingSheetName" value="Sheet1">
                            </div>
                        </div>

                        <div class="settings-row">
                            <div class="settings-item">
                                <label class="settings-label" data-i18n="label_name_col">Колонка названия</label>
                                <input type="text" class="settings-input" id="settingNameCol" value="A" maxlength="2">
                            </div>
                            <div class="settings-item">
                                <label class="settings-label" data-i18n="label_qty_col">Колонка количества</label>
                                <input type="text" class="settings-input" id="settingQtyCol" value="B" maxlength="2">
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-lg btn-block mt-4" onclick="saveSettings()">
                        <span class="icon icon-sm">
                            <svg viewBox="0 0 24 24">
                                <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                                <polyline points="17 21 17 13 7 13 7 21"/>
                                <polyline points="7 3 7 8 15 8"/>
                            </svg>
                        </span>
                        <span data-i18n="btn_save_settings">Сохранить настройки</span>
                    </button>

                    <!-- Danger Zone -->
                    <div class="settings-section mt-4" style="border-color: var(--accent-error);">
                        <div class="settings-section-header" style="border-bottom-color: var(--accent-error-dim);">
                            <div class="settings-section-icon" style="background: var(--accent-error-dim); color: var(--accent-error);">
                                <span class="icon">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                                        <line x1="12" y1="9" x2="12" y2="13"/>
                                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                                    </svg>
                                </span>
                            </div>
                            <div>
                                <div class="settings-section-title" style="color: var(--accent-error);" data-i18n="danger_zone">Опасная зона</div>
                                <div class="settings-section-subtitle" data-i18n="danger_zone_hint">Необратимые действия</div>
                            </div>
                        </div>

                        <button class="btn btn-danger btn-block" onclick="clearAllTasks()">
                            <span class="icon icon-sm">
                                <svg viewBox="0 0 24 24">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                    <line x1="10" y1="11" x2="10" y2="17"/>
                                    <line x1="14" y1="11" x2="14" y2="17"/>
                                </svg>
                            </span>
                            <span data-i18n="btn_clear_tasks">Удалить все задачи</span>
                        </button>
                    </div>
                </div>

                <!-- Team Tab -->
                <div class="tab-content" id="tabTeam">
                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <span class="icon">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                                        <path d="M16 3.13a4 4 0 010 7.75"/>
                                    </svg>
                                </span>
                            </div>
                            <div>
                                <div class="settings-section-title" data-i18n="team_code_title">Код приглашения</div>
                                <div class="settings-section-subtitle" data-i18n="team_code_hint">Поделитесь кодом с сотрудниками</div>
                            </div>
                        </div>

                        <div class="team-code-box">
                            <div class="team-code-value" id="teamCodeValue">—</div>
                            <div class="team-code-actions">
                                <button class="btn btn-secondary btn-icon" onclick="copyTeamCode()" title="Copy">
                                    <span class="icon icon-sm">
                                        <svg viewBox="0 0 24 24">
                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                            <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                                        </svg>
                                    </span>
                                </button>
                            </div>
                        </div>

                        <button class="btn btn-primary btn-block mt-3" onclick="generateTeamCode()">
                            <span class="icon icon-sm">
                                <svg viewBox="0 0 24 24">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/>
                                </svg>
                            </span>
                            <span data-i18n="btn_generate_code">Сгенерировать новый код</span>
                        </button>

                        <p class="settings-hint mt-2 text-center" data-i18n="team_invite_hint">
                            Сотрудник должен отправить боту команду /start с этим кодом
                        </p>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <span class="icon">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <line x1="19" y1="8" x2="19" y2="14"/>
                                        <line x1="22" y1="11" x2="16" y2="11"/>
                                    </svg>
                                </span>
                            </div>
                            <div>
                                <div class="settings-section-title" data-i18n="team_members_title">Участники команды</div>
                                <div class="settings-section-subtitle" data-i18n="team_members_hint">Сотрудники вашей фермы</div>
                            </div>
                        </div>

                        <div class="team-members-list" id="teamMembersList"></div>

                        <div class="empty-state hidden" id="teamEmpty" style="padding: 32px 16px;">
                            <div class="empty-state-icon" style="width: 48px; height: 48px; margin-bottom: 12px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <line x1="19" y1="8" x2="19" y2="14"/>
                                    <line x1="22" y1="11" x2="16" y2="11"/>
                                </svg>
                            </div>
                            <p class="text-muted text-sm" data-i18n="team_empty">Пока нет сотрудников</p>
                        </div>
                    </div>
                </div>

                <!-- Help Tab -->
                <div class="tab-content" id="tabHelp">
                    <!-- Guide Section -->
                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <span class="icon">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M4 19.5A2.5 2.5 0 016.5 17H20"/>
                                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/>
                                    </svg>
                                </span>
                            </div>
                            <div>
                                <div class="settings-section-title" data-i18n="guide_title">Руководство</div>
                                <div class="settings-section-subtitle" data-i18n="guide_hint">Как пользоваться системой</div>
                            </div>
                        </div>

                        <div id="guideContent">
                            <!-- Guide content will be rendered based on language and role -->
                        </div>
                    </div>

                    <!-- FAQ Section -->
                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <span class="icon">
                                    <svg viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
                                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                                    </svg>
                                </span>
                            </div>
                            <div>
                                <div class="settings-section-title" data-i18n="faq_title">Частые вопросы</div>
                                <div class="settings-section-subtitle" data-i18n="faq_hint">FAQ</div>
                            </div>
                        </div>

                        <div class="faq-list" id="faqList">
                            <!-- FAQ items will be rendered based on language -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- ═══════════════════════════════════════════════════════════════════════
         BOTTOM NAVIGATION
    ═══════════════════════════════════════════════════════════════════════ -->
    <nav class="bottom-nav">
        <div class="nav-item active" data-tab="printers">
            <span class="nav-icon icon icon-md">
                <svg viewBox="0 0 24 24">
                    <rect x="4" y="4" width="16" height="16" rx="2"/>
                    <rect x="8" y="8" width="8" height="8"/>
                    <line x1="4" y1="12" x2="2" y2="12"/>
                    <line x1="22" y1="12" x2="20" y2="12"/>
                    <line x1="12" y1="4" x2="12" y2="2"/>
                    <line x1="12" y1="22" x2="12" y2="20"/>
                </svg>
            </span>
            <span class="nav-label" data-i18n="nav_printers">Принтеры</span>
        </div>
        <div class="nav-item" data-tab="tasks">
            <span class="nav-icon icon icon-md">
                <svg viewBox="0 0 24 24">
                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
                    <rect x="9" y="3" width="6" height="4" rx="1"/>
                    <path d="M9 14l2 2 4-4"/>
                </svg>
            </span>
            <span class="nav-label" data-i18n="nav_tasks">Задачи</span>
            <span class="nav-badge hidden" id="tasksBadge">0</span>
        </div>
        <div class="nav-item" data-tab="products">
            <span class="nav-icon icon icon-md">
                <svg viewBox="0 0 24 24">
                    <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                    <line x1="12" y1="22.08" x2="12" y2="12"/>
                </svg>
            </span>
            <span id="navProductsText">Изделия</span>
        </div>
        <div class="nav-item" data-tab="settings">
            <span class="nav-icon icon icon-lg">
                <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
            </span>
            <span id="navSettingsText">Настройки</span>
        </div>
    </nav>

    <!-- Modal: Add Printer -->
    <div class="modal-overlay" id="addPrinterModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="addPrinterTitle">Добавить принтер</h3>
                <button class="modal-close" onclick="closeModal('addPrinterModal')">
                    <span class="icon">
                        <svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editPrinterId">
                <div class="form-group">
                    <label class="form-label" id="printerNameLabel">Название принтера *</label>
                    <input type="text" class="form-input" id="printerName" placeholder="Принтер 1">
                </div>
                <div class="form-group">
                    <label class="form-label" id="printerModelLabel">Модель</label>
                    <input type="text" class="form-input" id="printerModel" placeholder="Bambu Lab P1S">
                </div>
                <div class="form-group">
                    <label class="form-label" id="printerImageLabel">URL изображения</label>
                    <input type="text" class="form-input" id="printerImage" placeholder="https://...">
                </div>
                <div class="form-group hidden" id="printerStatusGroup">
                    <label class="form-label" id="printerStatusLabel">Статус</label>
                    <select class="form-select" id="printerStatus">
                        <option value="idle">Свободен</option>
                        <option value="printing">Печатает</option>
                        <option value="paused">Пауза</option>
                        <option value="finished">Завершил</option>
                        <option value="error">Ошибка</option>
                        <option value="repair">Ремонт</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addPrinterModal')" id="cancelPrinterBtn">Отмена</button>
                <button class="btn btn-primary" onclick="savePrinter()" id="savePrinterBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Product -->
    <div class="modal-overlay" id="addProductModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="addProductTitle">Добавить изделие</h3>
                <button class="modal-close" onclick="closeModal('addProductModal')">
                    <span class="icon">
                        <svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editProductId">
                <div class="form-group">
                    <label class="form-label" id="productNameLabel">Название изделия *</label>
                    <input type="text" class="form-input" id="productName" placeholder="Чехол для телефона">
                </div>
                <div class="form-group">
                    <label class="form-label" id="productDescLabel">Описание</label>
                    <textarea class="form-textarea" id="productDescription" placeholder="Описание изделия..."></textarea>
                </div>
                <div class="variants-editor">
                    <label class="form-label" id="variantsLabel">Варианты печати</label>
                    <div class="variants-list" id="variantsList"></div>
                    <button class="add-variant-btn" onclick="addVariantRow()">
                        <span class="icon icon-sm">
                            <svg viewBox="0 0 24 24">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                        </span>
                        <span id="addVariantText">Добавить вариант</span>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addProductModal')" id="cancelProductBtn">Отмена</button>
                <button class="btn btn-primary" onclick="saveProduct()" id="saveProductBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Modal: Import Orders -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="importTitle">Импорт заказов</h3>
                <button class="modal-close" onclick="closeModal('importModal')">
                    <span class="icon">
                        <svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </span>
                </button>
            </div>
            <div class="modal-body">
                <div id="importLoading" class="import-loading">
                    <div class="loading-spinner"></div>
                    <p id="importLoadingText">Загрузка данных из Google Sheets...</p>
                </div>
                <div id="importResults" class="hidden">
                    <p class="import-count"><span id="importCountText">Найдено заказов:</span> <strong id="importCount">0</strong></p>
                    <div class="orders-preview" id="ordersPreview"></div>
                </div>
                <div id="importError" class="hidden">
                    <div class="error-message">
                        <span class="icon icon-lg" style="color: #f44336;">
                            <svg viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>
                        </span>
                        <p id="importErrorText">Ошибка загрузки</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('importModal')" id="closeImportBtn">Закрыть</button>
                <button class="btn btn-primary" onclick="confirmImport()" id="generateFromImportBtn" disabled>
                    <span class="icon icon-sm">
                        <svg viewBox="0 0 24 24">
                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                        </svg>
                    </span>
                    <span id="generateTasksText">Сгенерировать задачи</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Generation Summary -->
    <div class="modal-overlay" id="summaryModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="summaryTitle">Результат генерации</h3>
                <button class="modal-close" onclick="closeModal('summaryModal')">
                    <span class="icon">
                        <svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </span>
                </button>
            </div>
            <div class="modal-body">
                <div class="summary-grid" id="summaryGrid"></div>
                <div class="summary-warnings hidden" id="summaryWarnings"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-block" onclick="closeModal('summaryModal')" id="closeSummaryBtn">Отлично!</button>
            </div>
        </div>
    </div>

    <!-- Modal: Confirm Delete -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmTitle">Подтверждение</h3>
                <button class="modal-close" onclick="closeModal('confirmModal')">
                    <span class="icon">
                        <svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </span>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmText" class="confirm-text">Вы уверены?</p>
                <input type="hidden" id="confirmItemId">
                <input type="hidden" id="confirmItemType">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('confirmModal')" id="confirmCancelBtn">Отмена</button>
                <button class="btn btn-danger" onclick="executeConfirm()" id="confirmDeleteBtn">Удалить</button>
            </div>
        </div>
    </div>

    <!-- Modal: Help & FAQ -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title" id="helpTitle">Справка</h3>
                <button class="modal-close" onclick="closeModal('helpModal')">
                    <span class="icon">
                        <svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </span>
                </button>
            </div>
            <div class="modal-body">
                <div class="help-tabs">
                    <button class="help-tab active" data-help="guide" id="helpTabGuide">
                        <span class="icon icon-sm">
                            <svg viewBox="0 0 24 24">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                            </svg>
                        </span>
                        Руководство
                    </button>
                    <button class="help-tab" data-help="faq" id="helpTabFaq">
                        <span class="icon icon-sm">
                            <svg viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                        </span>
                        FAQ
                    </button>
                </div>
                <div class="help-content" id="helpContent"></div>
            </div>
        </div>
    </div>

    <!-- Modal: Language Selector -->
    <div class="modal-overlay" id="languageModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="languageTitle">Выберите язык</h3>
                <button class="modal-close" onclick="closeModal('languageModal')">
                    <span class="icon">
                        <svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </span>
                </button>
            </div>
            <div class="modal-body">
                <div class="language-list">
                    <!-- Русский -->
                    <button class="language-option" data-lang="ru">
                        <span class="flag-icon">
                            <svg viewBox="0 0 640 480">
                                <rect width="640" height="160" fill="#fff"/>
                                <rect y="160" width="640" height="160" fill="#0039a6"/>
                                <rect y="320" width="640" height="160" fill="#d52b1e"/>
                            </svg>
                        </span>
                        <span class="language-name">Русский</span>
                        <span class="language-check hidden">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </span>
                    </button>
                    
                    <!-- Українська -->
                    <button class="language-option" data-lang="uk">
                        <span class="flag-icon">
                            <svg viewBox="0 0 640 480">
                                <rect width="640" height="240" fill="#005bbb"/>
                                <rect y="240" width="640" height="240" fill="#ffd500"/>
                            </svg>
                        </span>
                        <span class="language-name">Українська</span>
                        <span class="language-check hidden">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </span>
                    </button>
                    
                    <!-- English -->
                    <button class="language-option" data-lang="en">
                        <span class="flag-icon">
                            <svg viewBox="0 0 640 480">
                                <rect width="640" height="480" fill="#012169"/>
                                <path d="M0 0l640 480M640 0L0 480" stroke="#fff" stroke-width="60"/>
                                <path d="M0 0l640 480M640 0L0 480" stroke="#c8102e" stroke-width="40"/>
                                <path d="M320 0v480M0 240h640" stroke="#fff" stroke-width="100"/>
                                <path d="M320 0v480M0 240h640" stroke="#c8102e" stroke-width="60"/>
                            </svg>
                        </span>
                        <span class="language-name">English</span>
                        <span class="language-check hidden">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </span>
                    </button>
                    
                    <!-- Қазақша -->
                    <button class="language-option" data-lang="kk">
                        <span class="flag-icon">
                            <svg viewBox="0 0 640 480">
                                <rect width="640" height="480" fill="#00afca"/>
                                <circle cx="320" cy="200" r="80" fill="#fec50c"/>
                                <path d="M320 280c-44.2 0-80-35.8-80-80s35.8-80 80-80" fill="#00afca"/>
                                <g fill="#fec50c">
                                    <path d="M280 340h80v20h-80z"/>
                                    <path d="M260 370h120v10h-120z"/>
                                    <path d="M240 390h160v10h-160z"/>
                                </g>
                            </svg>
                        </span>
                        <span class="language-name">Қазақша</span>
                        <span class="language-check hidden">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </span>
                    </button>
                    
                    <!-- Oʻzbekcha -->
                    <button class="language-option" data-lang="uz">
                        <span class="flag-icon">
                            <svg viewBox="0 0 640 480">
                                <rect width="640" height="160" fill="#1eb53a"/>
                                <rect y="160" width="640" height="40" fill="#ce1126"/>
                                <rect y="200" width="640" height="160" fill="#fff"/>
                                <rect y="360" width="640" height="40" fill="#ce1126"/>
                                <rect y="400" width="640" height="80" fill="#0099b5"/>
                                <circle cx="140" cy="80" r="50" fill="#fff"/>
                                <circle cx="160" cy="80" r="45" fill="#1eb53a"/>
                                <g fill="#fff">
                                    <circle cx="220" cy="50" r="8"/>
                                    <circle cx="250" cy="50" r="8"/>
                                    <circle cx="280" cy="50" r="8"/>
                                    <circle cx="235" cy="75" r="8"/>
                                    <circle cx="265" cy="75" r="8"/>
                                </g>
                            </svg>
                        </span>
                        <span class="language-name">Oʻzbekcha</span>
                        <span class="language-check hidden">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </span>
                    </button>
                    
                    <!-- Беларуская -->
                    <button class="language-option" data-lang="be">
                        <span class="flag-icon">
                            <svg viewBox="0 0 640 480">
                                <rect width="640" height="320" fill="#c8313e"/>
                                <rect y="320" width="640" height="160" fill="#4aa657"/>
                                <rect width="80" height="480" fill="#fff"/>
                                <g fill="#c8313e">
                                    <path d="M0 40h80v40H0zM0 120h80v40H0zM0 200h80v40H0zM0 280h80v40H0zM0 360h80v40H0zM0 440h80v40H0z"/>
                                </g>
                            </svg>
                        </span>
                        <span class="language-name">Беларуская</span>
                        <span class="language-check hidden">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </span>
                    </button>
                    
                    <!-- Azərbaycan -->
                    <button class="language-option" data-lang="az">
                        <span class="flag-icon">
                            <svg viewBox="0 0 640 480">
                                <rect width="640" height="160" fill="#0092bc"/>
                                <rect y="160" width="640" height="160" fill="#e4002b"/>
                                <rect y="320" width="640" height="160" fill="#00af66"/>
                                <circle cx="320" cy="240" r="60" fill="#fff"/>
                                <circle cx="340" cy="240" r="50" fill="#e4002b"/>
                                <polygon points="380,220 400,240 380,260 390,240" fill="#fff"/>
                            </svg>
                        </span>
                        <span class="language-name">Azərbaycan</span>
                        <span class="language-check hidden">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </span>
                    </button>
                    
                    <!-- ქართული -->
                    <button class="language-option" data-lang="ka">
                        <span class="flag-icon">
                            <svg viewBox="0 0 640 480">
                                <rect width="640" height="480" fill="#fff"/>
                                <path d="M272 0h96v480h-96zM0 192h640v96H0z" fill="#ff0000"/>
                                <g fill="#ff0000">
                                    <path d="M120 60h40v40h-40zM120 100h40v40h-40zM80 100h40v40H80zM160 100h40v40h-40z"/>
                                    <path d="M480 60h40v40h-40zM480 100h40v40h-40zM440 100h40v40h-40zM520 100h40v40h-40z"/>
                                    <path d="M120 340h40v40h-40zM120 380h40v40h-40zM80 380h40v40H80zM160 380h40v40h-40z"/>
                                    <path d="M480 340h40v40h-40zM480 380h40v40h-40zM440 380h40v40h-40zM520 380h40v40h-40z"/>
                                </g>
                            </svg>
                        </span>
                        <span class="language-name">ქართული</span>
                        <span class="language-check hidden">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/data.js"></script>
    <script>
        // ─────────────────────────────────────────────────────────────────────
        // Мультиязычность - Тексты интерфейса
        // ─────────────────────────────────────────────────────────────────────
        const TRANSLATIONS = {
            // ═══════════════════════════════════════════════════════════════
            // РУССКИЙ
            // ═══════════════════════════════════════════════════════════════
            ru: {
                // Header
                appTitle: "3D Ферма",
                
                // Roles
                roleOwner: "Владелец",
                roleWorker: "Сотрудник",
                
                // Navigation
                navPrinters: "Принтеры",
                navTasks: "Задачи",
                navProducts: "Изделия",
                navSettings: "Настройки",
                
                // Stats
                statTotal: "Всего",
                statIdle: "Свободно",
                statPrinting: "Печатают",
                statOther: "Другое",
                statPending: "Ожидают",
                statInProgress: "В работе",
                statDone: "Готово",
                
                // Buttons
                btnAddPrinter: "Добавить принтер",
                btnAddProduct: "Добавить изделие",
                btnImport: "Импорт",
                btnGenerate: "Генерация",
                btnSave: "Сохранить",
                btnCancel: "Отмена",
                btnDelete: "Удалить",
                btnEdit: "Редактировать",
                btnStart: "Начать",
                btnComplete: "Завершить",
                btnClose: "Закрыть",
                btnOk: "Отлично!",
                btnCopy: "Копировать",
                btnGenerateCode: "Сгенерировать новый код",
                btnClearTasks: "Очистить все задачи",
                btnHelp: "Справка",
                
                // Filters
                filterAll: "Все",
                filterPending: "Ожидают",
                filterInProgress: "В работе",
                filterDone: "Готово",
                filterDay: "День",
                filterNight: "Ночь",
                
                // Printers
                printerName: "Название принтера",
                printerModel: "Модель",
                printerImage: "URL изображения",
                printerStatus: "Статус",
                statusIdle: "Свободен",
                statusPrinting: "Печатает",
                statusPaused: "Пауза",
                statusFinished: "Завершил",
                statusError: "Ошибка",
                statusRepair: "Ремонт",
                currentTask: "Текущая задача",
                noPrinters: "Нет принтеров",
                noPrintersDesc: "Добавьте первый принтер для начала работы",
                addPrinterTitle: "Добавить принтер",
                editPrinterTitle: "Редактировать принтер",
                
                // Products
                productName: "Название изделия",
                productDesc: "Описание",
                variants: "Варианты печати",
                addVariant: "Добавить вариант",
                variantName: "Название",
                variantQty: "Кол-во",
                variantTime: "Время (мин)",
                noProducts: "Нет изделий",
                noProductsDesc: "Добавьте изделия с вариантами печати",
                addProductTitle: "Добавить изделие",
                editProductTitle: "Редактировать изделие",
                
                // Tasks
                taskQty: "Количество",
                taskPrinter: "Принтер",
                taskSlotDay: "День",
                taskSlotNight: "Ночь",
                taskStatusPending: "Ожидает",
                taskStatusInProgress: "В работе",
                taskStatusDone: "Готово",
                noTasks: "Нет задач",
                noTasksDesc: "Импортируйте заказы и сгенерируйте задачи",
                
                // Import
                importTitle: "Импорт заказов",
                importLoading: "Загрузка данных из Google Sheets...",
                importFound: "Найдено заказов:",
                importError: "Ошибка загрузки",
                generateTasks: "Сгенерировать задачи",
                
                // Summary
                summaryTitle: "Результат генерации",
                summaryCreated: "Создано задач",
                summaryPrinters: "Принтеров занято",
                summaryOrdered: "Заказано",
                summaryPlanned: "Запланировано",
                summarySurplus: "Излишек",
                warningNoPrinters: "Нет доступных принтеров",
                warningNotEnough: "Недостаточно принтеров",
                warningUnfulfilled: "Не выполнено",
                warningProductNotFound: "Изделие не найдено",
                
                // Settings
                settingsSchedule: "Расписание работы",
                settingsWorkStart: "Начало работы",
                settingsWorkEnd: "Конец работы",
                settingsDeadline: "Дедлайн (начало ночной смены)",
                settingsChangeover: "Время переналадки (мин)",
                settingsUseNight: "Использовать ночную смену",
                settingsMinimize: "Минимизировать кол-во принтеров",
                settingsGoogleSheets: "Google Sheets",
                settingsSheetId: "ID таблицы",
                settingsSheetIdHint: "Из URL: docs.google.com/spreadsheets/d/ID/...",
                settingsSheetName: "Название листа",
                settingsNameColumn: "Колонка названия",
                settingsQtyColumn: "Колонка количества",
                settingsTeam: "Команда",
                settingsTeamCode: "Код приглашения",
                settingsTeamCodeHint: "Отправьте этот код сотруднику для присоединения",
                settingsNoCode: "Код не сгенерирован",
                settingsTeamMembers: "Участники команды",
                settingsNoMembers: "Нет участников",
                settingsLanguage: "Язык интерфейса",
                settingsDanger: "Опасная зона",
                settingsSaved: "Настройки сохранены",
                
                // Confirm
                confirmTitle: "Подтверждение",
                confirmDeletePrinter: "Удалить принтер \"{name}\"?",
                confirmDeleteProduct: "Удалить изделие \"{name}\"?",
                confirmDeleteTask: "Удалить задачу?",
                confirmClearTasks: "Удалить ВСЕ задачи? Это действие нельзя отменить.",
                confirmRemoveMember: "Удалить участника \"{name}\" из команды?",
                
                // Help
                helpTitle: "Справка",
                helpGuide: "Руководство",
                helpFaq: "FAQ",
                
                helpGuideOwner: `
                    <h4>👑 Руководство владельца</h4>
                    
                    <h5>🖨️ Принтеры</h5>
                    <p>Добавляйте 3D-принтеры с названием и моделью. Отслеживайте их статус в реальном времени.</p>
                    <ul>
                        <li><strong>Свободен</strong> — принтер готов к работе</li>
                        <li><strong>Печатает</strong> — идёт печать</li>
                        <li><strong>Завершил</strong> — печать завершена, нужно забрать</li>
                        <li><strong>Ошибка</strong> — возникла проблема</li>
                    </ul>
                    
                    <h5>📦 Изделия</h5>
                    <p>Создайте каталог изделий. Для каждого изделия настройте варианты печати:</p>
                    <ul>
                        <li><strong>Количество</strong> — сколько штук за одну печать</li>
                        <li><strong>Время</strong> — продолжительность печати в минутах</li>
                    </ul>
                    
                    <h5>📋 Задачи</h5>
                    <ol>
                        <li>Настройте Google Sheets в настройках</li>
                        <li>Нажмите «Импорт» для загрузки заказов</li>
                        <li>Нажмите «Генерация» для создания задач</li>
                        <li>Система автоматически распределит работу</li>
                    </ol>
                    
                    <h5>👥 Команда</h5>
                    <p>Сгенерируйте код команды в настройках и отправьте его сотрудникам. Они смогут отмечать выполнение задач.</p>
                `,
                
                helpGuideWorker: `
                    <h4>👷 Руководство сотрудника</h4>
                    
                    <h5>📋 Работа с задачами</h5>
                    <ol>
                        <li>Откройте вкладку «Задачи»</li>
                        <li>Найдите задачу со статусом «Ожидает»</li>
                        <li>Нажмите «Начать» когда запускаете печать</li>
                        <li>Нажмите «Завершить» когда печать готова</li>
                    </ol>
                    
                    <h5>🖨️ Статусы принтеров</h5>
                    <p>На вкладке «Принтеры» вы видите состояние всех принтеров фермы.</p>
                    
                    <h5>💡 Советы</h5>
                    <ul>
                        <li>Отмечайте задачи вовремя для точной статистики</li>
                        <li>При проблемах сообщите владельцу</li>
                    </ul>
                `,
                
                helpFaqContent: `
                    <h4>❓ Частые вопросы</h4>
                    
                    <div class="faq-item">
                        <strong>Как добавить принтер?</strong>
                        <p>Откройте вкладку «Принтеры» → нажмите «Добавить принтер» → заполните форму.</p>
                    </div>
                    
                    <div class="faq-item">
                        <strong>Как импортировать заказы?</strong>
                        <p>1. В настройках укажите ID вашей Google таблицы<br>
                        2. Укажите название листа и колонки<br>
                        3. На вкладке «Задачи» нажмите «Импорт»</p>
                    </div>
                    
                    <div class="faq-item">
                        <strong>Как пригласить сотрудника?</strong>
                        <p>В настройках нажмите «Сгенерировать новый код» и отправьте его сотруднику. Он вводит код при первом запуске бота.</p>
                    </div>
                    
                    <div class="faq-item">
                        <strong>Что такое ночная смена?</strong>
                        <p>Печать которая запускается вечером и работает ночью. На ночь планируется только одна печать на принтер.</p>
                    </div>
                    
                    <div class="faq-item">
                        <strong>Как работает автораспределение?</strong>
                        <p>Система учитывает время печати каждого изделия, время переналадки и распределяет заказы по принтерам оптимально.</p>
                    </div>
                    
                    <div class="faq-item">
                        <strong>Где взять ID Google таблицы?</strong>
                        <p>Из URL таблицы: docs.google.com/spreadsheets/d/<strong>ВОТ_ЭТОТ_ID</strong>/edit</p>
                    </div>
                `,
                
                // Toasts
                toastSaved: "Сохранено",
                toastDeleted: "Удалено",
                toastStarted: "Задача начата",
                toastCompleted: "Задача завершена",
                toastImported: "Импортировано заказов: {count}",
                toastGenerated: "Создано задач: {count}",
                toastCleared: "Все задачи удалены",
                toastCodeGenerated: "Новый код сгенерирован",
                toastCodeCopied: "Код скопирован",
                toastError: "Ошибка",
                toastLanguageChanged: "Язык изменён",
            },
            
            // ═══════════════════════════════════════════════════════════════
            // УКРАЇНСЬКА
            // ═══════════════════════════════════════════════════════════════
            uk: {
                // Header
                appTitle: "3D Ферма",
                
                // Roles
                roleOwner: "Власник",
                roleWorker: "Співробітник",
                
                // Navigation
                navPrinters: "Принтери",
                navTasks: "Завдання",
                navProducts: "Вироби",
                navSettings: "Налаштування",
                
                // Stats
                statTotal: "Всього",
                statIdle: "Вільно",
                statPrinting: "Друкують",
                statOther: "Інше",
                statPending: "Очікують",
                statInProgress: "В роботі",
                statDone: "Готово",
                
                // Buttons
                btnAddPrinter: "Додати принтер",
                btnAddProduct: "Додати виріб",
                btnImport: "Імпорт",
                btnGenerate: "Генерація",
                btnSave: "Зберегти",
                btnCancel: "Скасувати",
                btnDelete: "Видалити",
                btnEdit: "Редагувати",
                btnStart: "Почати",
                btnComplete: "Завершити",
                btnClose: "Закрити",
                btnOk: "Чудово!",
                btnCopy: "Копіювати",
                btnGenerateCode: "Згенерувати новий код",
                btnClearTasks: "Очистити всі завдання",
                btnHelp: "Довідка",
                
                // Filters
                filterAll: "Всі",
                filterPending: "Очікують",
                filterInProgress: "В роботі",
                filterDone: "Готово",
                filterDay: "День",
                filterNight: "Ніч",
                
                // Printers
                printerName: "Назва принтера",
                printerModel: "Модель",
                printerImage: "URL зображення",
                printerStatus: "Статус",
                statusIdle: "Вільний",
                statusPrinting: "Друкує",
                statusPaused: "Пауза",
                statusFinished: "Завершив",
                statusError: "Помилка",
                statusRepair: "Ремонт",
                currentTask: "Поточне завдання",
                noPrinters: "Немає принтерів",
                noPrintersDesc: "Додайте перший принтер для початку роботи",
                addPrinterTitle: "Додати принтер",
                editPrinterTitle: "Редагувати принтер",
                
                // Products
                productName: "Назва виробу",
                productDesc: "Опис",
                variants: "Варіанти друку",
                addVariant: "Додати варіант",
                variantName: "Назва",
                variantQty: "К-сть",
                variantTime: "Час (хв)",
                noProducts: "Немає виробів",
                noProductsDesc: "Додайте вироби з варіантами друку",
                addProductTitle: "Додати виріб",
                editProductTitle: "Редагувати виріб",
                
                // Tasks
                taskQty: "Кількість",
                taskPrinter: "Принтер",
                taskSlotDay: "День",
                taskSlotNight: "Ніч",
                taskStatusPending: "Очікує",
                taskStatusInProgress: "В роботі",
                taskStatusDone: "Готово",
                noTasks: "Немає завдань",
                noTasksDesc: "Імпортуйте замовлення та згенеруйте завдання",
                
                // Import
                importTitle: "Імпорт замовлень",
                importLoading: "Завантаження даних з Google Sheets...",
                importFound: "Знайдено замовлень:",
                importError: "Помилка завантаження",
                generateTasks: "Згенерувати завдання",
                
                // Summary
                summaryTitle: "Результат генерації",
                summaryCreated: "Створено завдань",
                summaryPrinters: "Принтерів зайнято",
                summaryOrdered: "Замовлено",
                summaryPlanned: "Заплановано",
                summarySurplus: "Надлишок",
                warningNoPrinters: "Немає доступних принтерів",
                warningNotEnough: "Недостатньо принтерів",
                warningUnfulfilled: "Не виконано",
                warningProductNotFound: "Виріб не знайдено",
                
                // Settings
                settingsSchedule: "Розклад роботи",
                settingsWorkStart: "Початок роботи",
                settingsWorkEnd: "Кінець роботи",
                settingsDeadline: "Дедлайн (початок нічної зміни)",
                settingsChangeover: "Час переналадки (хв)",
                settingsUseNight: "Використовувати нічну зміну",
                settingsMinimize: "Мінімізувати к-сть принтерів",
                settingsGoogleSheets: "Google Sheets",
                settingsSheetId: "ID таблиці",
                settingsSheetIdHint: "З URL: docs.google.com/spreadsheets/d/ID/...",
                settingsSheetName: "Назва аркуша",
                settingsNameColumn: "Колонка назви",
                settingsQtyColumn: "Колонка кількості",
                settingsTeam: "Команда",
                settingsTeamCode: "Код запрошення",
                settingsTeamCodeHint: "Надішліть цей код співробітнику для приєднання",
                settingsNoCode: "Код не згенеровано",
                settingsTeamMembers: "Учасники команди",
                settingsNoMembers: "Немає учасників",
                settingsLanguage: "Мова інтерфейсу",
                settingsDanger: "Небезпечна зона",
                settingsSaved: "Налаштування збережено",
                
                // Confirm
                confirmTitle: "Підтвердження",
                confirmDeletePrinter: "Видалити принтер \"{name}\"?",
                confirmDeleteProduct: "Видалити виріб \"{name}\"?",
                confirmDeleteTask: "Видалити завдання?",
                confirmClearTasks: "Видалити ВСІ завдання? Цю дію не можна скасувати.",
                confirmRemoveMember: "Видалити учасника \"{name}\" з команди?",
                
                // Help
                helpTitle: "Довідка",
                helpGuide: "Керівництво",
                helpFaq: "FAQ",
                
                helpGuideOwner: `
                    <h4>👑 Керівництво власника</h4>
                    
                    <h5>🖨️ Принтери</h5>
                    <p>Додавайте 3D-принтери з назвою та моделлю. Відстежуйте їх статус в реальному часі.</p>
                    <ul>
                        <li><strong>Вільний</strong> — принтер готовий до роботи</li>
                        <li><strong>Друкує</strong> — йде друк</li>
                        <li><strong>Завершив</strong> — друк завершено, треба забрати</li>
                        <li><strong>Помилка</strong> — виникла проблема</li>
                    </ul>
                    
                    <h5>📦 Вироби</h5>
                    <p>Створіть каталог виробів. Для кожного виробу налаштуйте варіанти друку:</p>
                    <ul>
                        <li><strong>Кількість</strong> — скільки штук за один друк</li>
                        <li><strong>Час</strong> — тривалість друку в хвилинах</li>
                    </ul>
                    
                    <h5>📋 Завдання</h5>
                    <ol>
                        <li>Налаштуйте Google Sheets в налаштуваннях</li>
                        <li>Натисніть «Імпорт» для завантаження замовлень</li>
                        <li>Натисніть «Генерація» для створення завдань</li>
                        <li>Система автоматично розподілить роботу</li>
                    </ol>
                    
                    <h5>👥 Команда</h5>
                    <p>Згенеруйте код команди в налаштуваннях та надішліть його співробітникам.</p>
                `,
                
                helpGuideWorker: `
                    <h4>👷 Керівництво співробітника</h4>
                    
                    <h5>📋 Робота з завданнями</h5>
                    <ol>
                        <li>Відкрийте вкладку «Завдання»</li>
                        <li>Знайдіть завдання зі статусом «Очікує»</li>
                        <li>Натисніть «Почати» коли запускаєте друк</li>
                        <li>Натисніть «Завершити» коли друк готовий</li>
                    </ol>
                    
                    <h5>💡 Поради</h5>
                    <ul>
                        <li>Відмічайте завдання вчасно для точної статистики</li>
                        <li>При проблемах повідомте власника</li>
                    </ul>
                `,
                
                helpFaqContent: `
                    <h4>❓ Часті запитання</h4>
                    
                    <div class="faq-item">
                        <strong>Як додати принтер?</strong>
                        <p>Відкрийте вкладку «Принтери» → натисніть «Додати принтер» → заповніть форму.</p>
                    </div>
                    
                    <div class="faq-item">
                        <strong>Як імпортувати замовлення?</strong>
                        <p>1. В налаштуваннях вкажіть ID вашої Google таблиці<br>
                        2. Вкажіть назву аркуша та колонки<br>
                        3. На вкладці «Завдання» натисніть «Імпорт»</p>
                    </div>
                    
                    <div class="faq-item">
                        <strong>Як запросити співробітника?</strong>
                        <p>В налаштуваннях натисніть «Згенерувати новий код» та надішліть його співробітнику.</p>
                    </div>
                `,
                
                // Toasts
                toastSaved: "Збережено",
                toastDeleted: "Видалено",
                toastStarted: "Завдання розпочато",
                toastCompleted: "Завдання завершено",
                toastImported: "Імпортовано замовлень: {count}",
                toastGenerated: "Створено завдань: {count}",
                toastCleared: "Всі завдання видалено",
                toastCodeGenerated: "Новий код згенеровано",
                toastCodeCopied: "Код скопійовано",
                toastError: "Помилка",
                toastLanguageChanged: "Мову змінено",
            },
            
            // ═══════════════════════════════════════════════════════════════
            // ENGLISH
            // ═══════════════════════════════════════════════════════════════
            en: {
                // Header
                appTitle: "3D Farm",
                
                // Roles
                roleOwner: "Owner",
                roleWorker: "Worker",
                
                // Navigation
                navPrinters: "Printers",
                navTasks: "Tasks",
                navProducts: "Products",
                navSettings: "Settings",
                
                // Stats
                statTotal: "Total",
                statIdle: "Idle",
                statPrinting: "Printing",
                statOther: "Other",
                statPending: "Pending",
                statInProgress: "Active",
                statDone: "Done",
                
                // Buttons
                btnAddPrinter: "Add Printer",
                btnAddProduct: "Add Product",
                btnImport: "Import",
                btnGenerate: "Generate",
                btnSave: "Save",
                btnCancel: "Cancel",
                btnDelete: "Delete",
                btnEdit: "Edit",
                btnStart: "Start",
                btnComplete: "Complete",
                btnClose: "Close",
                btnOk: "Great!",
                btnCopy: "Copy",
                btnGenerateCode: "Generate New Code",
                btnClearTasks: "Clear All Tasks",
                btnHelp: "Help",
                
                // Filters
                filterAll: "All",
                filterPending: "Pending",
                filterInProgress: "Active",
                filterDone: "Done",
                filterDay: "Day",
                filterNight: "Night",
                
                // Printers
                printerName: "Printer Name",
                printerModel: "Model",
                printerImage: "Image URL",
                printerStatus: "Status",
                statusIdle: "Idle",
                statusPrinting: "Printing",
                statusPaused: "Paused",
                statusFinished: "Finished",
                statusError: "Error",
                statusRepair: "Repair",
                currentTask: "Current Task",
                noPrinters: "No Printers",
                noPrintersDesc: "Add your first printer to get started",
                addPrinterTitle: "Add Printer",
                editPrinterTitle: "Edit Printer",
                
                // Products
                productName: "Product Name",
                productDesc: "Description",
                variants: "Print Variants",
                addVariant: "Add Variant",
                variantName: "Name",
                variantQty: "Qty",
                variantTime: "Time (min)",
                noProducts: "No Products",
                noProductsDesc: "Add products with print variants",
                addProductTitle: "Add Product",
                editProductTitle: "Edit Product",
                
                // Tasks
                taskQty: "Quantity",
                taskPrinter: "Printer",
                taskSlotDay: "Day",
                taskSlotNight: "Night",
                taskStatusPending: "Pending",
                taskStatusInProgress: "In Progress",
                taskStatusDone: "Done",
                noTasks: "No Tasks",
                noTasksDesc: "Import orders and generate tasks",
                
                // Import
                importTitle: "Import Orders",
                importLoading: "Loading data from Google Sheets...",
                importFound: "Orders found:",
                importError: "Loading error",
                generateTasks: "Generate Tasks",
                
                // Summary
                summaryTitle: "Generation Result",
                summaryCreated: "Tasks created",
                summaryPrinters: "Printers used",
                summaryOrdered: "Ordered",
                summaryPlanned: "Planned",
                summarySurplus: "Surplus",
                warningNoPrinters: "No printers available",
                warningNotEnough: "Not enough printers",
                warningUnfulfilled: "Unfulfilled",
                warningProductNotFound: "Product not found",
                
                // Settings
                settingsSchedule: "Work Schedule",
                settingsWorkStart: "Work Start",
                settingsWorkEnd: "Work End",
                settingsDeadline: "Deadline (night shift start)",
                settingsChangeover: "Changeover time (min)",
                settingsUseNight: "Use night shift",
                settingsMinimize: "Minimize printer count",
                settingsGoogleSheets: "Google Sheets",
                settingsSheetId: "Sheet ID",
                settingsSheetIdHint: "From URL: docs.google.com/spreadsheets/d/ID/...",
                settingsSheetName: "Sheet name",
                settingsNameColumn: "Name column",
                settingsQtyColumn: "Quantity column",
                settingsTeam: "Team",
                settingsTeamCode: "Invite Code",
                settingsTeamCodeHint: "Send this code to workers to join",
                settingsNoCode: "No code generated",
                settingsTeamMembers: "Team Members",
                settingsNoMembers: "No members",
                settingsLanguage: "Interface Language",
                settingsDanger: "Danger Zone",
                settingsSaved: "Settings saved",
                
                // Confirm
                confirmTitle: "Confirm",
                confirmDeletePrinter: "Delete printer \"{name}\"?",
                confirmDeleteProduct: "Delete product \"{name}\"?",
                confirmDeleteTask: "Delete task?",
                confirmClearTasks: "Delete ALL tasks? This cannot be undone.",
                confirmRemoveMember: "Remove \"{name}\" from team?",
                
                // Help
                helpTitle: "Help",
                helpGuide: "Guide",
                helpFaq: "FAQ",
                
                helpGuideOwner: `
                    <h4>👑 Owner's Guide</h4>
                    
                    <h5>🖨️ Printers</h5>
                    <p>Add 3D printers with name and model. Track their status in real-time.</p>
                    <ul>
                        <li><strong>Idle</strong> — printer is ready</li>
                        <li><strong>Printing</strong> — print in progress</li>
                        <li><strong>Finished</strong> — print complete, needs pickup</li>
                        <li><strong>Error</strong> — problem occurred</li>
                    </ul>
                    
                    <h5>📦 Products</h5>
                    <p>Create a product catalog. Set up print variants for each product:</p>
                    <ul>
                        <li><strong>Quantity</strong> — items per print</li>
                        <li><strong>Time</strong> — print duration in minutes</li>
                    </ul>
                    
                    <h5>📋 Tasks</h5>
                    <ol>
                        <li>Configure Google Sheets in settings</li>
                        <li>Click "Import" to load orders</li>
                        <li>Click "Generate" to create tasks</li>
                        <li>System auto-distributes work</li>
                    </ol>
                    
                    <h5>👥 Team</h5>
                    <p>Generate team code in settings and share with workers.</p>
                `,
                
                helpGuideWorker: `
                    <h4>👷 Worker's Guide</h4>
                    
                    <h5>📋 Working with Tasks</h5>
                    <ol>
                        <li>Open "Tasks" tab</li>
                        <li>Find task with "Pending" status</li>
                        <li>Click "Start" when beginning print</li>
                        <li>Click "Complete" when print is done</li>
                    </ol>
                    
                    <h5>💡 Tips</h5>
                    <ul>
                        <li>Mark tasks on time for accurate stats</li>
                        <li>Report problems to owner</li>
                    </ul>
                `,
                
                helpFaqContent: `
                    <h4>❓ FAQ</h4>
                    
                    <div class="faq-item">
                        <strong>How to add a printer?</strong>
                        <p>Open "Printers" tab → click "Add Printer" → fill the form.</p>
                    </div>
                    
                    <div class="faq-item">
                        <strong>How to import orders?</strong>
                        <p>1. Set Google Sheet ID in settings<br>
                        2. Specify sheet name and columns<br>
                        3. Click "Import" in "Tasks" tab</p>
                    </div>
                    
                    <div class="faq-item">
                        <strong>How to invite a worker?</strong>
                        <p>Click "Generate New Code" in settings and send it to the worker.</p>
                    </div>
                `,
                
                // Toasts
                toastSaved: "Saved",
                toastDeleted: "Deleted",
                toastStarted: "Task started",
                toastCompleted: "Task completed",
                toastImported: "Imported orders: {count}",
                toastGenerated: "Tasks created: {count}",
                toastCleared: "All tasks deleted",
                toastCodeGenerated: "New code generated",
                toastCodeCopied: "Code copied",
                toastError: "Error",
                toastLanguageChanged: "Language changed",
            },
            
            // ═══════════════════════════════════════════════════════════════
            // ҚАЗАҚША
            // ═══════════════════════════════════════════════════════════════
            kk: {
                appTitle: "3D Ферма",
                roleOwner: "Иесі",
                roleWorker: "Қызметкер",
                navPrinters: "Принтерлер",
                navTasks: "Тапсырмалар",
                navProducts: "Бұйымдар",
                navSettings: "Баптаулар",
                statTotal: "Барлығы",
                statIdle: "Бос",
                statPrinting: "Басып шығарады",
                statOther: "Басқа",
                statPending: "Күтуде",
                statInProgress: "Орындалуда",
                statDone: "Дайын",
                btnAddPrinter: "Принтер қосу",
                btnAddProduct: "Бұйым қосу",
                btnImport: "Импорт",
                btnGenerate: "Генерация",
                btnSave: "Сақтау",
                btnCancel: "Болдырмау",
                btnDelete: "Жою",
                btnEdit: "Өңдеу",
                btnStart: "Бастау",
                btnComplete: "Аяқтау",
                btnClose: "Жабу",
                btnOk: "Тамаша!",
                btnCopy: "Көшіру",
                btnGenerateCode: "Жаңа код жасау",
                btnClearTasks: "Барлық тапсырмаларды тазалау",
                btnHelp: "Анықтама",
                filterAll: "Барлығы",
                filterPending: "Күтуде",
                filterInProgress: "Орындалуда",
                filterDone: "Дайын",
                filterDay: "Күн",
                filterNight: "Түн",
                printerName: "Принтер атауы",
                printerModel: "Модель",
                printerImage: "Сурет URL",
                printerStatus: "Күйі",
                statusIdle: "Бос",
                statusPrinting: "Басып шығарады",
                statusPaused: "Үзіліс",
                statusFinished: "Аяқталды",
                statusError: "Қате",
                statusRepair: "Жөндеу",
                currentTask: "Ағымдағы тапсырма",
                noPrinters: "Принтерлер жоқ",
                noPrintersDesc: "Жұмысты бастау үшін бірінші принтерді қосыңыз",
                addPrinterTitle: "Принтер қосу",
                editPrinterTitle: "Принтерді өңдеу",
                productName: "Бұйым атауы",
                productDesc: "Сипаттама",
                variants: "Басып шығару нұсқалары",
                addVariant: "Нұсқа қосу",
                variantName: "Атауы",
                variantQty: "Саны",
                variantTime: "Уақыт (мин)",
                noProducts: "Бұйымдар жоқ",
                noProductsDesc: "Басып шығару нұсқаларымен бұйымдар қосыңыз",
                noTasks: "Тапсырмалар жоқ",
                noTasksDesc: "Тапсырыстарды импорттап, тапсырмалар жасаңыз",
                importTitle: "Тапсырыстарды импорттау",
                importLoading: "Google Sheets деректерін жүктеу...",
                importFound: "Тапсырыстар табылды:",
                importError: "Жүктеу қатесі",
                generateTasks: "Тапсырмалар жасау",
                summaryTitle: "Генерация нәтижесі",
                summaryCreated: "Тапсырмалар жасалды",
                summaryPrinters: "Принтерлер қолданылды",
                summaryOrdered: "Тапсырыс берілді",
                summaryPlanned: "Жоспарланды",
                summarySurplus: "Артық",
                settingsSchedule: "Жұмыс кестесі",
                settingsWorkStart: "Жұмыс басы",
                settingsWorkEnd: "Жұмыс соңы",
                settingsDeadline: "Дедлайн (түнгі ауысым басы)",
                settingsChangeover: "Ауыстыру уақыты (мин)",
                settingsUseNight: "Түнгі ауысымды қолдану",
                settingsMinimize: "Принтер санын азайту",
                settingsGoogleSheets: "Google Sheets",
                settingsSheetId: "Кесте ID",
                settingsSheetName: "Парақ атауы",
                settingsNameColumn: "Атау бағаны",
                settingsQtyColumn: "Сан бағаны",
                settingsTeam: "Команда",
                settingsTeamCode: "Шақыру коды",
                settingsNoCode: "Код жасалмаған",
                settingsTeamMembers: "Команда мүшелері",
                settingsNoMembers: "Мүшелер жоқ",
                settingsLanguage: "Интерфейс тілі",
                settingsDanger: "Қауіпті аймақ",
                settingsSaved: "Баптаулар сақталды",
                confirmTitle: "Растау",
                confirmDeletePrinter: "\"{name}\" принтерін жою керек пе?",
                confirmDeleteProduct: "\"{name}\" бұйымын жою керек пе?",
                confirmDeleteTask: "Тапсырманы жою керек пе?",
                confirmClearTasks: "БАРЛЫҚ тапсырмаларды жою керек пе?",
                helpTitle: "Анықтама",
                helpGuide: "Нұсқаулық",
                helpFaq: "FAQ",
                toastSaved: "Сақталды",
                toastDeleted: "Жойылды",
                toastStarted: "Тапсырма басталды",
                toastCompleted: "Тапсырма аяқталды",
                toastImported: "Тапсырыстар импортталды: {count}",
                toastGenerated: "Тапсырмалар жасалды: {count}",
                toastCleared: "Барлық тапсырмалар жойылды",
                toastCodeGenerated: "Жаңа код жасалды",
                toastCodeCopied: "Код көшірілді",
                toastError: "Қате",
                toastLanguageChanged: "Тіл өзгертілді",
            },
            
            // ═══════════════════════════════════════════════════════════════
            // O'ZBEKCHA
            // ═══════════════════════════════════════════════════════════════
            uz: {
                appTitle: "3D Ferma",
                roleOwner: "Egasi",
                roleWorker: "Xodim",
                navPrinters: "Printerlar",
                navTasks: "Vazifalar",
                navProducts: "Mahsulotlar",
                navSettings: "Sozlamalar",
                statTotal: "Jami",
                statIdle: "Bo'sh",
                statPrinting: "Chop etilmoqda",
                statOther: "Boshqa",
                statPending: "Kutilmoqda",
                statInProgress: "Bajarilmoqda",
                statDone: "Tayyor",
                btnAddPrinter: "Printer qo'shish",
                btnAddProduct: "Mahsulot qo'shish",
                btnImport: "Import",
                btnGenerate: "Generatsiya",
                btnSave: "Saqlash",
                btnCancel: "Bekor qilish",
                btnDelete: "O'chirish",
                btnEdit: "Tahrirlash",
                btnStart: "Boshlash",
                btnComplete: "Tugatish",
                btnClose: "Yopish",
                btnOk: "Ajoyib!",
                btnCopy: "Nusxalash",
                btnGenerateCode: "Yangi kod yaratish",
                btnClearTasks: "Barcha vazifalarni tozalash",
                btnHelp: "Yordam",
                filterAll: "Hammasi",
                filterPending: "Kutilmoqda",
                filterInProgress: "Bajarilmoqda",
                filterDone: "Tayyor",
                filterDay: "Kun",
                filterNight: "Tun",
                printerName: "Printer nomi",
                printerModel: "Model",
                printerStatus: "Holat",
                statusIdle: "Bo'sh",
                statusPrinting: "Chop etilmoqda",
                statusFinished: "Tugadi",
                statusError: "Xato",
                noPrinters: "Printerlar yo'q",
                noPrintersDesc: "Ishni boshlash uchun birinchi printerni qo'shing",
                productName: "Mahsulot nomi",
                productDesc: "Tavsif",
                variants: "Chop etish variantlari",
                addVariant: "Variant qo'shish",
                noProducts: "Mahsulotlar yo'q",
                noTasks: "Vazifalar yo'q",
                importTitle: "Buyurtmalarni import qilish",
                importLoading: "Google Sheets'dan ma'lumotlar yuklanmoqda...",
                importFound: "Buyurtmalar topildi:",
                generateTasks: "Vazifalar yaratish",
                summaryTitle: "Generatsiya natijasi",
                settingsSchedule: "Ish jadvali",
                settingsWorkStart: "Ish boshlanishi",
                settingsWorkEnd: "Ish tugashi",
                settingsTeam: "Jamoa",
                settingsTeamCode: "Taklif kodi",
                settingsLanguage: "Interfeys tili",
                settingsSaved: "Sozlamalar saqlandi",
                confirmTitle: "Tasdiqlash",
                helpTitle: "Yordam",
                helpGuide: "Qo'llanma",
                helpFaq: "FAQ",
                toastSaved: "Saqlandi",
                toastDeleted: "O'chirildi",
                toastError: "Xato",
                toastLanguageChanged: "Til o'zgartirildi",
            },
            
            // ═══════════════════════════════════════════════════════════════
            // БЕЛАРУСКАЯ
            // ═══════════════════════════════════════════════════════════════
            be: {
                appTitle: "3D Ферма",
                roleOwner: "Уладальнік",
                roleWorker: "Супрацоўнік",
                navPrinters: "Прынтары",
                navTasks: "Заданні",
                navProducts: "Вырабы",
                navSettings: "Налады",
                statTotal: "Усяго",
                statIdle: "Вольна",
                statPrinting: "Друкуюць",
                statOther: "Іншае",
                statPending: "Чакаюць",
                statInProgress: "У працы",
                statDone: "Гатова",
                btnAddPrinter: "Дадаць прынтар",
                btnAddProduct: "Дадаць выраб",
                btnImport: "Імпарт",
                btnGenerate: "Генерацыя",
                btnSave: "Захаваць",
                btnCancel: "Адмена",
                btnDelete: "Выдаліць",
                btnStart: "Пачаць",
                btnComplete: "Завяршыць",
                btnClose: "Зачыніць",
                btnOk: "Выдатна!",
                btnCopy: "Капіяваць",
                filterAll: "Усе",
                filterDay: "Дзень",
                filterNight: "Ноч",
                printerName: "Назва прынтара",
                printerModel: "Мадэль",
                statusIdle: "Вольны",
                statusPrinting: "Друкуе",
                statusFinished: "Завяршыў",
                statusError: "Памылка",
                noPrinters: "Няма прынтараў",
                productName: "Назва вырабу",
                variants: "Варыянты друку",
                noProducts: "Няма вырабаў",
                noTasks: "Няма заданняў",
                importTitle: "Імпарт замоў",
                settingsSchedule: "Расклад працы",
                settingsTeam: "Каманда",
                settingsLanguage: "Мова інтэрфейсу",
                settingsSaved: "Налады захаваны",
                                helpTitle: "Даведка",
                helpGuide: "Кіраўніцтва",
                helpFaq: "FAQ",

                helpGuideOwner: `
                    <h4>Кіраўніцтва ўладальніка</h4>

                    <h5>Прынтары</h5>
                    <p>Дадавайце 3D-прынтары з назвай і мадэллю. Адсочвайце іх стан у рэальным часе.</p>
                    <ul>
                        <li><strong>Вольны</strong> — прынтар гатовы да працы</li>
                        <li><strong>Друкуе</strong> — ідзе друк</li>
                        <li><strong>Завяршыў</strong> — друк скончаны, трэба забраць</li>
                        <li><strong>Памылка</strong> — узнікла праблема</li>
                    </ul>

                    <h5>Вырабы</h5>
                    <p>Стварыце каталог вырабаў. Для кожнага вырабу наладзьце варыянты друку:</p>
                    <ul>
                        <li><strong>Колькасць</strong> — колькі штук за адзін друк</li>
                        <li><strong>Час</strong> — працягласць друку ў хвілінах</li>
                    </ul>

                    <h5>Заданні</h5>
                    <ol>
                        <li>Наладзьце Google Sheets у наладах</li>
                        <li>Націсніце «Імпарт» для загрузкі замоў</li>
                        <li>Націсніце «Генерацыя» для стварэння заданняў</li>
                        <li>Сістэма аўтаматычна размеркуе працу</li>
                    </ol>

                    <h5>Каманда</h5>
                    <p>Згенеруйце код каманды ў наладах і адпраўце яго супрацоўнікам. Яны змогуць адзначаць выкананне заданняў.</p>
                `,

                helpGuideWorker: `
                    <h4>Кіраўніцтва супрацоўніка</h4>

                    <h5>Праца з заданнямі</h5>
                    <ol>
                        <li>Адкрыйце ўкладку «Заданні»</li>
                        <li>Знайдзіце заданне са статусам «Чакае»</li>
                        <li>Націсніце «Пачаць», калі запускаеце друк</li>
                        <li>Націсніце «Завяршыць», калі друк гатовы</li>
                    </ol>

                    <h5>Парады</h5>
                    <ul>
                        <li>Адзначайце заданні своечасова для дакладнай статыстыкі</li>
                        <li>Пры праблемах паведамце ўладальніку</li>
                    </ul>
                `,

                helpFaqContent: `
                    <h4>Частыя пытанні</h4>

                    <div class="faq-item">
                        <strong>Як дадаць прынтар?</strong>
                        <p>Адкрыйце «Прынтары» → націсніце «Дадаць прынтар» → запоўніце форму.</p>
                    </div>

                    <div class="faq-item">
                        <strong>Як імпартаваць замовы?</strong>
                        <p>
                            1) У наладах укажыце ID Google-табліцы<br>
                            2) Укажыце назву ліста і калонкі<br>
                            3) На ўкладцы «Заданні» націсніце «Імпарт»
                        </p>
                    </div>

                    <div class="faq-item">
                        <strong>Як запрасіць супрацоўніка?</strong>
                        <p>У наладах націсніце «Згенеруй новы код» і адпраўце яго супрацоўніку. Супрацоўнік уводзіць код у боте пры першым запуску.</p>
                    </div>

                    <div class="faq-item">
                        <strong>Што такое начная змена?</strong>
                        <p>Друк, які запускаецца ўвечары і працуе ноччу. На ноч плануецца толькі адзін друк на прынтар.</p>
                    </div>
                `,

                toastSaved: "Захавана",
                toastDeleted: "Выдалена",
                toastStarted: "Заданне пачата",
                toastCompleted: "Заданне завершана",
                toastImported: "Імпартавана замоў: {count}",
                toastGenerated: "Створана заданняў: {count}",
                toastCleared: "Усе заданні выдалены",
                toastCodeGenerated: "Новы код згенераваны",
                toastCodeCopied: "Код скапіяваны",
                toastError: "Памылка",
                toastLanguageChanged: "Мова зменена",
            },

            // ═══════════════════════════════════════════════════════════════
            // AZƏRBAYCAN
            // ═══════════════════════════════════════════════════════════════
            az: {
                appTitle: "3D Ferma",

                roleOwner: "Sahib",
                roleWorker: "İşçi",

                navPrinters: "Printerlər",
                navTasks: "Tapşırıqlar",
                navProducts: "Məhsullar",
                navSettings: "Ayarlar",

                statTotal: "Cəmi",
                statIdle: "Boş",
                statPrinting: "Çap edir",
                statOther: "Digər",
                statPending: "Gözləyir",
                statInProgress: "İşdə",
                statDone: "Hazır",

                btnAddPrinter: "Printer əlavə et",
                btnAddProduct: "Məhsul əlavə et",
                btnImport: "İdxal",
                btnGenerate: "Plan qur",
                btnSave: "Yadda saxla",
                btnCancel: "Ləğv et",
                btnDelete: "Sil",
                btnEdit: "Düzəlt",
                btnStart: "Başla",
                btnComplete: "Bitir",
                btnClose: "Bağla",
                btnOk: "Oldu",
                btnCopy: "Kopyala",
                btnGenerateCode: "Yeni kod yarat",
                btnClearTasks: "Bütün tapşırıqları sil",
                btnHelp: "Kömək",

                filterAll: "Hamısı",
                filterPending: "Gözləyir",
                filterInProgress: "İşdə",
                filterDone: "Hazır",
                filterDay: "Gündüz",
                filterNight: "Gecə",

                printerName: "Printer adı",
                printerModel: "Model",
                printerImage: "Şəkil URL",
                printerStatus: "Status",
                statusIdle: "Boş",
                statusPrinting: "Çap edir",
                statusPaused: "Fasilə",
                statusFinished: "Bitdi",
                statusError: "Xəta",
                statusRepair: "Təmir",
                currentTask: "Cari tapşırıq",

                noPrinters: "Printer yoxdur",
                noPrintersDesc: "Başlamaq üçün ilk printeri əlavə edin",
                addPrinterTitle: "Printer əlavə et",
                editPrinterTitle: "Printeri düzəlt",

                productName: "Məhsul adı",
                productDesc: "Təsvir",
                variants: "Çap variantları",
                addVariant: "Variant əlavə et",
                variantName: "Ad",
                variantQty: "Say",
                variantTime: "Vaxt (dəq)",
                noProducts: "Məhsul yoxdur",
                noProductsDesc: "Çap variantları ilə məhsul əlavə edin",

                taskQty: "Miqdar",
                taskPrinter: "Printer",
                taskSlotDay: "Gündüz",
                taskSlotNight: "Gecə",
                taskStatusPending: "Gözləyir",
                taskStatusInProgress: "İşdə",
                taskStatusDone: "Hazır",
                noTasks: "Tapşırıq yoxdur",
                noTasksDesc: "Sifarişləri idxal edin və tapşırıqlar yaradın",

                importTitle: "Sifarişlərin idxalı",
                importLoading: "Google Sheets-dən məlumatlar yüklənir...",
                importFound: "Sifariş tapıldı:",
                importError: "Yükləmə xətası",
                generateTasks: "Tapşırıqlar yarat",

                summaryTitle: "Nəticə",
                summaryCreated: "Tapşırıq yaradıldı",
                summaryPrinters: "Printer istifadə olundu",
                summaryOrdered: "Sifariş",
                summaryPlanned: "Plan",
                summarySurplus: "Artıq",

                settingsSchedule: "İş qrafiki",
                settingsWorkStart: "Başlama",
                settingsWorkEnd: "Bitmə",
                settingsDeadline: "Deadline (gecə başlanğıcı)",
                settingsChangeover: "Dəyişmə vaxtı (dəq)",
                settingsUseNight: "Gecə rejimi",
                settingsMinimize: "Printer sayını azalt",
                settingsGoogleSheets: "Google Sheets",
                settingsSheetId: "Cədvəl ID",
                settingsSheetName: "Vərəq adı",
                settingsNameColumn: "Ad sütunu",
                settingsQtyColumn: "Say sütunu",
                settingsTeam: "Komanda",
                settingsTeamCode: "Dəvət kodu",
                settingsNoCode: "Kod yoxdur",
                settingsTeamMembers: "Komanda üzvləri",
                settingsNoMembers: "Üzv yoxdur",
                settingsLanguage: "Dil",
                settingsDanger: "Təhlükəli zona",
                settingsSaved: "Ayarlar yadda saxlandı",

                confirmTitle: "Təsdiq",
                confirmDeletePrinter: "\"{name}\" printerini silmək?",
                confirmDeleteProduct: "\"{name}\" məhsulunu silmək?",
                confirmDeleteTask: "Tapşırığı silmək?",
                confirmClearTasks: "BÜTÜN tapşırıqları silmək? Geri qaytarmaq olmaz.",
                confirmRemoveMember: "\"{name}\" üzvünü komandadan çıxarmaq?",

                helpTitle: "Kömək",
                helpGuide: "Bələdçi",
                helpFaq: "FAQ",

                toastSaved: "Yadda saxlandı",
                toastDeleted: "Silindi",
                toastStarted: "Başladı",
                toastCompleted: "Bitdi",
                toastImported: "İdxal olundu: {count}",
                toastGenerated: "Yaradıldı: {count}",
                toastCleared: "Hamısı silindi",
                toastCodeGenerated: "Yeni kod yaradıldı",
                toastCodeCopied: "Kod kopyalandı",
                toastError: "Xəta",
                toastLanguageChanged: "Dil dəyişdi",
            },

            // ═══════════════════════════════════════════════════════════════
            // ქართული
            // ═══════════════════════════════════════════════════════════════
            ka: {
                appTitle: "3D ფერმა",

                roleOwner: "მფლობელი",
                roleWorker: "თანამშრომელი",

                navPrinters: "პრინტერები",
                navTasks: "დავალებები",
                navProducts: "ნაწარმი",
                navSettings: "პარამეტრები",

                statTotal: "სულ",
                statIdle: "თავისუფალი",
                statPrinting: "ბეჭდავს",
                statOther: "სხვა",
                statPending: "მოლოდინში",
                statInProgress: "მიმდინარეობს",
                statDone: "შესრულდა",

                btnAddPrinter: "პრინტერის დამატება",
                btnAddProduct: "ნაწარმის დამატება",
                btnImport: "იმპორტი",
                btnGenerate: "გეგმის შექმნა",
                btnSave: "შენახვა",
                btnCancel: "გაუქმება",
                btnDelete: "წაშლა",
                btnEdit: "რედაქტირება",
                btnStart: "დაწყება",
                btnComplete: "დასრულება",
                btnClose: "დახურვა",
                btnOk: "კარგია",
                btnCopy: "კოპირება",
                btnGenerateCode: "ახალი კოდის გენერაცია",
                btnClearTasks: "ყველა დავალების წაშლა",
                btnHelp: "დახმარება",

                filterAll: "ყველა",
                filterPending: "მოლოდინში",
                filterInProgress: "მიმდინარეობს",
                filterDone: "შესრულდა",
                filterDay: "დღე",
                filterNight: "ღამე",

                printerName: "პრინტერის სახელი",
                printerModel: "მოდელი",
                printerImage: "სურათის URL",
                printerStatus: "სტატუსი",
                statusIdle: "თავისუფალი",
                statusPrinting: "ბეჭდავს",
                statusPaused: "პაუზა",
                statusFinished: "დასრულდა",
                statusError: "შეცდომა",
                statusRepair: "რემონტი",
                currentTask: "მიმდინარე დავალება",

                noPrinters: "პრინტერები არ არის",
                noPrintersDesc: "დასაწყებად დაამატეთ პირველი პრინტერი",
                addPrinterTitle: "პრინტერის დამატება",
                editPrinterTitle: "პრინტერის რედაქტირება",

                productName: "ნაწარმის სახელი",
                productDesc: "აღწერა",
                variants: "ბეჭდვის ვარიანტები",
                addVariant: "ვარიანტის დამატება",
                variantName: "სახელი",
                variantQty: "რაოდენობა",
                variantTime: "დრო (წუთი)",
                noProducts: "ნაწარმი არ არის",
                noProductsDesc: "დაამატეთ ნაწარმი ბეჭდვის ვარიანტებით",

                noTasks: "დავალებები არ არის",
                noTasksDesc: "იმპორტი გააკეთეთ და შექმენით დავალებები",

                importTitle: "შეკვეთების იმპორტი",
                importLoading: "Google Sheets-დან მონაცემების ჩატვირთვა...",
                importFound: "ნაპოვნია შეკვეთები:",
                importError: "ჩატვირთვის შეცდომა",
                generateTasks: "დავალებების შექმნა",

                settingsSchedule: "სამუშაო განრიგი",
                settingsWorkStart: "დასაწყისი",
                settingsWorkEnd: "დასასრული",
                settingsDeadline: "დედლაინი (ღამის დაწყება)",
                settingsChangeover: "გადართვის დრო (წუთი)",
                settingsUseNight: "ღამის რეჟიმი",
                settingsMinimize: "პრინტერების შემცირება",
                settingsGoogleSheets: "Google Sheets",
                settingsSheetId: "ცხრილის ID",
                settingsSheetName: "ფურცლის სახელი",
                settingsNameColumn: "სახელის სვეტი",
                settingsQtyColumn: "რაოდენობის სვეტი",
                settingsTeam: "გუნდი",
                settingsTeamCode: "მოწვევის კოდი",
                settingsNoCode: "კოდი არ არის",
                settingsLanguage: "ენა",
                settingsSaved: "შენახულია",

                helpTitle: "დახმარება",
                helpGuide: "გზამკვლევი",
                helpFaq: "FAQ",

                toastSaved: "შენახულია",
                toastDeleted: "წაშლილია",
                toastError: "შეცდომა",
                toastLanguageChanged: "ენა შეიცვალა",
            },

            // ═══════════════════════════════════════════════════════════════
            // KYRGYZ (Кыргызча) — (дапоўнена, калі захочаш дадаць у селектар пазней)
            // ═══════════════════════════════════════════════════════════════
            ky: {
                appTitle: "3D Ферма",
                roleOwner: "Ээси",
                roleWorker: "Кызматкер",
                navPrinters: "Принтерлер",
                navTasks: "Тапшырмалар",
                navProducts: "Буюмдар",
                navSettings: "Орнотуулар",
                btnSave: "Сактоо",
                btnCancel: "Жокко чыгаруу",
                btnDelete: "Өчүрүү",
                btnStart: "Баштоо",
                btnComplete: "Бүттү",
                helpTitle: "Жардам",
                toastError: "Ката",
                toastLanguageChanged: "Тил өзгөрдү",
            },

            // ═══════════════════════════════════════════════════════════════
            // ARMENIAN (Հայերեն) — (дапоўнена)
            // ═══════════════════════════════════════════════════════════════
            hy: {
                appTitle: "3D Ֆերմա",
                roleOwner: "Սեփականատեր",
                roleWorker: "Աշխատակից",
                navPrinters: "Տպիչներ",
                navTasks: "Առաջադրանքներ",
                navProducts: "Ապրանքներ",
                navSettings: "Կարգավորումներ",
                btnSave: "Պահպանել",
                btnCancel: "Չեղարկել",
                btnDelete: "Ջնջել",
                btnStart: "Սկսել",
                btnComplete: "Ավարտել",
                helpTitle: "Օգնություն",
                toastError: "Սխալ",
                toastLanguageChanged: "Լեզուն փոխվեց",
            },

            // ═══════════════════════════════════════════════════════════════
            // TAJIK (Тоҷикӣ) — (дапоўнена)
            // ═══════════════════════════════════════════════════════════════
            tg: {
                appTitle: "3D Ферма",
                roleOwner: "Соҳиб",
                roleWorker: "Корманд",
                navPrinters: "Принтерҳо",
                navTasks: "Вазифаҳо",
                navProducts: "Маҳсулот",
                navSettings: "Танзимот",
                btnSave: "Захира кардан",
                btnCancel: "Бекор кардан",
                btnDelete: "Нест кардан",
                btnStart: "Оғоз",
                btnComplete: "Анҷом",
                helpTitle: "Кӯмак",
                toastError: "Хато",
                toastLanguageChanged: "Забон иваз шуд",
            }
        };

        // ─────────────────────────────────────────────────────────────────────
        // ДАЛЬШЕ ИДЁТ ЛОГИКА ПРИЛОЖЕНИЯ (НЕ ЛОМАЕМ СТРУКТУРУ)
        // ─────────────────────────────────────────────────────────────────────

        let currentUser = null;
        let currentLang = "ru";
        let importedOrders = [];
        let confirmAction = null; // { type, id, payload }

        function t(key, params = {}) {
            const dict = TRANSLATIONS[currentLang] || TRANSLATIONS["ru"];
            let s = dict[key] ?? (TRANSLATIONS["ru"][key] ?? key);
            for (const [k, v] of Object.entries(params)) {
                s = s.replaceAll(`{${k}}`, String(v));
            }
            return s;
        }

        function setText(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }

        function setHtml(id, value) {
            const el = document.getElementById(id);
            if (el) el.innerHTML = value;
        }

        function setPlaceholder(id, value) {
            const el = document.getElementById(id);
            if (el) el.setAttribute("placeholder", value);
        }

        async function saveLanguageToBackend(lang) {
            // Сохраняем в БД (без localStorage)
            // Если у тебя нет /api/language — добавь в bot.py. (я добавлял ранее)
            const tg = window.Telegram?.WebApp;
            const initData = tg?.initData || "";
            try {
                await fetch("/api/language", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Telegram-InitData": initData
                    },
                    body: JSON.stringify({ language: lang })
                });
            } catch (e) {
                // молча, чтобы не ломать UI, язык всё равно переключится локально в памяти
            }
        }

        function applyTranslations() {
            // Header / Nav
            setText("appTitleText", t("appTitle"));
            setText("navPrintersText", t("navPrinters"));
            setText("navTasksText", t("navTasks"));
            setText("navProductsText", t("navProducts"));
            setText("navSettingsText", t("navSettings"));

            // Printers page
            setText("printersTitle", t("navPrinters"));
            setText("addPrinterText", t("btnAddPrinter"));
            setText("emptyPrintersTitle", t("noPrinters"));
            setText("emptyPrintersDesc", t("noPrintersDesc"));

            // Tasks page
            setText("tasksTitle", t("navTasks"));
            setText("importText", t("btnImport"));
            setText("generateText", t("btnGenerate"));
            setText("emptyTasksTitle", t("noTasks"));
            setText("emptyTasksDesc", t("noTasksDesc"));

            // Products page
            setText("productsTitle", t("navProducts"));
            setText("addProductText", t("btnAddProduct"));
            setText("emptyProductsTitle", t("noProducts"));
            setText("emptyProductsDesc", t("noProductsDesc"));

            // Settings page
            setText("settingsTitle", t("navSettings"));
            setText("settingsScheduleTitle", t("settingsSchedule"));
            setText("settingsGoogleTitle", t("settingsGoogleSheets"));
            setText("settingsTeamTitle", t("settingsTeam"));
            setText("settingsLanguageTitle", t("settingsLanguage"));
            setText("settingsDangerTitle", t("settingsDanger"));
            setText("saveSettingsText", t("btnSave"));
            setText("clearAllTasksText", t("btnClearTasks"));

            // Filters
            document.querySelectorAll(".filter-btn").forEach(btn => {
                const f = btn.getAttribute("data-filter");
                if (f === "all") btn.textContent = t("filterAll");
                if (f === "pending") btn.textContent = t("filterPending");
                if (f === "in_progress") btn.textContent = t("filterInProgress");
                if (f === "done") btn.textContent = t("filterDone");
                if (f === "day") btn.textContent = t("filterDay");
                if (f === "night") btn.textContent = t("filterNight");
            });

            // Modals
            setText("addPrinterTitle", t("addPrinterTitle"));
            setText("printerNameLabel", t("printerName") + " *");
            setText("printerModelLabel", t("printerModel"));
            setText("printerImageLabel", t("printerImage"));
            setText("printerStatusLabel", t("printerStatus"));
            setText("cancelPrinterBtn", t("btnCancel"));
            setText("savePrinterBtn", t("btnSave"));

            setText("addProductTitle", t("addProductTitle"));
            setText("productNameLabel", t("productName") + " *");
            setText("productDescLabel", t("productDesc"));
            setText("variantsLabel", t("variants"));
            setText("addVariantText", t("addVariant"));
            setText("cancelProductBtn", t("btnCancel"));
            setText("saveProductBtn", t("btnSave"));

            setText("importTitle", t("importTitle"));
            setText("importLoadingText", t("importLoading"));
            setText("importCountText", t("importFound"));
            setText("closeImportBtn", t("btnClose"));
            setText("generateTasksText", t("generateTasks"));

            setText("summaryTitle", t("summaryTitle"));
            setText("closeSummaryBtn", t("btnOk"));

            setText("confirmTitle", t("confirmTitle"));
            setText("confirmCancelBtn", t("btnCancel"));
            setText("confirmDeleteBtn", t("btnDelete"));

                        setText("helpTitle", t("helpTitle"));

            // Help tabs labels (keep SVG, replace only text)
            const helpTabGuideEl = document.getElementById("helpTabGuide");
            const helpTabFaqEl = document.getElementById("helpTabFaq");
            if (helpTabGuideEl) {
                // keep first element node (svg wrapper), replace trailing text
                const icon = helpTabGuideEl.querySelector(".icon");
                helpTabGuideEl.innerHTML = "";
                if (icon) helpTabGuideEl.appendChild(icon);
                const textNode = document.createElement("span");
                textNode.style.marginLeft = "8px";
                textNode.textContent = t("helpGuide");
                helpTabGuideEl.appendChild(textNode);
            }
            if (helpTabFaqEl) {
                const icon = helpTabFaqEl.querySelector(".icon");
                helpTabFaqEl.innerHTML = "";
                if (icon) helpTabFaqEl.appendChild(icon);
                const textNode = document.createElement("span");
                textNode.style.marginLeft = "8px";
                textNode.textContent = t("helpFaq");
                helpTabFaqEl.appendChild(textNode);
            }

            // Placeholders
            setPlaceholder("printerName", t("printerName"));
            setPlaceholder("printerModel", t("printerModel"));
            setPlaceholder("printerImage", t("printerImage"));

            setPlaceholder("productName", t("productName"));
            setPlaceholder("productDescription", t("productDesc"));

            // Printer status select options (owner only)
            const statusSelect = document.getElementById("printerStatus");
            if (statusSelect) {
                const optMap = {
                    idle: t("statusIdle"),
                    printing: t("statusPrinting"),
                    paused: t("statusPaused"),
                    finished: t("statusFinished"),
                    error: t("statusError"),
                    repair: t("statusRepair"),
                };
                Array.from(statusSelect.options).forEach((o) => {
                    if (optMap[o.value]) o.textContent = optMap[o.value];
                });
            }

            // Import modal
            setText("importTitle", t("importTitle"));
            setText("importLoadingText", t("importLoading"));
            setText("importCountText", t("importFound"));
            setText("generateTasksText", t("generateTasks"));

            // Summary modal
            setText("summaryTitle", t("summaryTitle"));

            // Language modal title
            setText("languageTitle", t("settingsLanguage"));

            // Confirm modal title
            setText("confirmTitle", t("confirmTitle"));
        }

        // ─────────────────────────────────────────────────────────────────────
        // UI helpers
        // ─────────────────────────────────────────────────────────────────────
        function escapeHtml(text) {
            if (text === null || text === undefined) return "";
            const div = document.createElement("div");
            div.textContent = String(text);
            return div.innerHTML;
        }

        function show(elId) {
            const el = document.getElementById(elId);
            if (el) el.classList.remove("hidden");
        }

        function hide(elId) {
            const el = document.getElementById(elId);
            if (el) el.classList.add("hidden");
        }

        function openModal(id) {
            const el = document.getElementById(id);
            if (el) el.classList.add("active");
        }

        function closeModal(id) {
            const el = document.getElementById(id);
            if (el) el.classList.remove("active");
        }

        function setLoading(isLoading, textKey = null) {
            const overlay = document.getElementById("loadingOverlay");
            const textEl = document.getElementById("loadingText");
            if (textEl && textKey) textEl.textContent = t(textKey);
            if (overlay) overlay.classList.toggle("active", !!isLoading);
        }

        function toast(type, messageKeyOrText, params = {}) {
            const container = document.getElementById("toastContainer");
            if (!container) return;

            const msg = TRANSLATIONS[currentLang]?.[messageKeyOrText]
                ? t(messageKeyOrText, params)
                : String(messageKeyOrText);

            const item = document.createElement("div");
            item.className = `toast ${type}`;
            item.innerHTML = `<div class="toast-message">${escapeHtml(msg)}</div>`;
            container.appendChild(item);

            window.setTimeout(() => {
                item.classList.add("hiding");
                window.setTimeout(() => item.remove(), 250);
            }, 3200);
        }

        function getStatusLabel(status) {
            switch (status) {
                case "idle": return t("statusIdle");
                case "printing": return t("statusPrinting");
                case "paused": return t("statusPaused");
                case "finished": return t("statusFinished");
                case "error": return t("statusError");
                case "repair": return t("statusRepair");
                default: return status;
            }
        }

        function getTaskStatusLabel(status) {
            switch (status) {
                case "pending": return t("taskStatusPending");
                case "in_progress": return t("taskStatusInProgress");
                case "done": return t("taskStatusDone");
                default: return status;
            }
        }

        function getSlotLabel(slot) {
            return slot === "night" ? t("taskSlotNight") : t("taskSlotDay");
        }

        function formatTime(isoString) {
            if (!isoString) return "";
            const d = new Date(isoString);
            return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        }

        // ─────────────────────────────────────────────────────────────────────
        // App state
        // ─────────────────────────────────────────────────────────────────────
        let currentTab = "printers";
        let currentFilter = "all";

        let cachedPrinters = [];
        let cachedTasks = [];
        let cachedProducts = [];
        let cachedSettings = null;
        let cachedTeamMembers = [];

        let pendingConfirm = null; // {type, id, extra}

        // ─────────────────────────────────────────────────────────────────────
        // Role-based UI
        // ─────────────────────────────────────────────────────────────────────
        function applyRoleVisibility() {
            const isOwner = currentUser?.role === "owner";

            const navProducts = document.querySelector('.nav-item[data-tab="products"]');
            const navSettings = document.querySelector('.nav-item[data-tab="settings"]');

            if (navProducts) navProducts.classList.toggle("hidden", !isOwner);
            if (navSettings) navSettings.classList.toggle("hidden", !isOwner);

            const pageProducts = document.getElementById("pageProducts");
            const pageSettings = document.getElementById("pageSettings");

            if (pageProducts) pageProducts.classList.toggle("hidden", !isOwner);
            if (pageSettings) pageSettings.classList.toggle("hidden", !isOwner);

            // Owner-only action blocks
            const printerActions = document.getElementById("printerActions");
            const productActions = document.getElementById("productActions");
            const settingsContent = document.getElementById("settingsContent");
            const settingsRestricted = document.getElementById("settingsRestricted");

            if (printerActions) printerActions.classList.toggle("hidden", !isOwner);
            if (productActions) productActions.classList.toggle("hidden", !isOwner);

            if (settingsContent && settingsRestricted) {
                settingsContent.classList.toggle("hidden", !isOwner);
                settingsRestricted.classList.toggle("hidden", isOwner);
            }
        }

        // ─────────────────────────────────────────────────────────────────────
        // Tabs / Navigation
        // ─────────────────────────────────────────────────────────────────────
        function switchTab(tab) {
            const isOwner = currentUser?.role === "owner";
            if (!isOwner && (tab === "products" || tab === "settings")) {
                toast("warning", "toastError", {});
                return;
            }

            currentTab = tab;

            document.querySelectorAll(".nav-item").forEach((it) => {
                it.classList.toggle("active", it.getAttribute("data-tab") === tab);
            });

            document.querySelectorAll(".page").forEach((p) => {
                p.classList.toggle("hidden", p.getAttribute("data-page") !== tab);
            });

            // Load tab data
            if (tab === "printers") loadPrinters();
            if (tab === "tasks") loadTasks();
            if (tab === "products") loadProducts();
            if (tab === "settings") loadSettings();
        }

        function bindNavigation() {
            document.querySelectorAll(".nav-item").forEach((it) => {
                it.addEventListener("click", () => {
                    const tab = it.getAttribute("data-tab");
                    if (tab) switchTab(tab);
                });
            });
        }

        function bindTaskFilters() {
            const bar = document.getElementById("taskFilters");
            if (!bar) return;

            bar.querySelectorAll(".filter-btn").forEach((btn) => {
                btn.addEventListener("click", () => {
                    bar.querySelectorAll(".filter-btn").forEach((x) => x.classList.remove("active"));
                    btn.classList.add("active");
                    currentFilter = btn.getAttribute("data-filter") || "all";
                    renderTasks();
                });
            });
        }

        // ─────────────────────────────────────────────────────────────────────
        // Language selector (no localStorage)
        // ─────────────────────────────────────────────────────────────────────
        function openLanguageModal() {
            // Mark current selection
            document.querySelectorAll(".language-option").forEach((btn) => {
                const lang = btn.getAttribute("data-lang");
                const check = btn.querySelector(".language-check");
                if (check) check.classList.toggle("hidden", lang !== currentLang);
            });
            openModal("languageModal");
        }

        function bindLanguageSelector() {
            const openBtn = document.getElementById("openLanguageBtn");
            if (openBtn) openBtn.addEventListener("click", openLanguageModal);

            document.querySelectorAll(".language-option").forEach((btn) => {
                btn.addEventListener("click", async () => {
                    const lang = btn.getAttribute("data-lang");
                    if (!lang) return;

                    currentLang = lang;
                    await saveLanguageToBackend(lang);

                    // Update UI texts
                    applyTranslations();

                    // Re-render lists with translated labels
                    renderPrinters();
                    renderTasks();
                    renderProducts();
                    renderSettings();

                    // Update checkmarks
                    document.querySelectorAll(".language-option").forEach((x) => {
                        const l = x.getAttribute("data-lang");
                        const check = x.querySelector(".language-check");
                        if (check) check.classList.toggle("hidden", l !== currentLang);
                    });

                    toast("success", "toastLanguageChanged");
                    closeModal("languageModal");
                });
            });
        }

        // ─────────────────────────────────────────────────────────────────────
        // Help modal
        // ─────────────────────────────────────────────────────────────────────
        function openHelpModal() {
            const isOwner = currentUser?.role === "owner";
            const content = document.getElementById("helpContent");

            const guideBtn = document.getElementById("helpTabGuide");
            const faqBtn = document.getElementById("helpTabFaq");

            function setActive(tab) {
                if (guideBtn) guideBtn.classList.toggle("active", tab === "guide");
                if (faqBtn) faqBtn.classList.toggle("active", tab === "faq");

                if (!content) return;

                if (tab === "faq") {
                    content.innerHTML = t("helpFaqContent");
                    return;
                }

                // guide
                content.innerHTML = isOwner ? t("helpGuideOwner") : t("helpGuideWorker");
            }

            if (guideBtn) guideBtn.onclick = () => setActive("guide");
            if (faqBtn) faqBtn.onclick = () => setActive("faq");

            setActive("guide");
            openModal("helpModal");
        }

        function bindHelp() {
            const openHelpBtn = document.getElementById("openHelpBtn");
            if (openHelpBtn) openHelpBtn.addEventListener("click", openHelpModal);

            // Also allow help from settings
            const openHelpFromSettingsBtn = document.getElementById("openHelpFromSettingsBtn");
            if (openHelpFromSettingsBtn) openHelpFromSettingsBtn.addEventListener("click", openHelpModal);
        }

        // ─────────────────────────────────────────────────────────────────────
        // Printers
        // ─────────────────────────────────────────────────────────────────────
        async function loadPrinters() {
            try {
                setLoading(true);
                cachedPrinters = await PrintFarmApi.getAllPrinters(true);

                // tasks needed for "current task" label resolving
                cachedTasks = await PrintFarmApi.getAllTasks(true);

                renderPrinters();
            } catch (e) {
                toast("error", e?.message || t("toastError"));
            } finally {
                setLoading(false);
            }
        }

        function resolveTaskName(taskId) {
            const tsk = (cachedTasks || []).find((t) => t.id === taskId);
            if (!tsk) return `#${taskId}`;
            return `${tsk.product_name || `#${taskId}`} ×${tsk.quantity || 1}`;
        }

        function renderPrinters() {
            const grid = document.getElementById("printersGrid");
            const empty = document.getElementById("printersEmpty");
            if (!grid || !empty) return;

            if (!cachedPrinters || cachedPrinters.length === 0) {
                grid.innerHTML = "";
                empty.classList.remove("hidden");
                return;
            }
            empty.classList.add("hidden");

            // stats
            const total = cachedPrinters.length;
            const idle = cachedPrinters.filter(p => p.status === "idle").length;
            const printing = cachedPrinters.filter(p => p.status === "printing").length;
            const other = total - idle - printing;

            setText("statTotalPrinters", total);
            setText("statIdlePrinters", idle);
            setText("statPrintingPrinters", printing);
            setText("statOtherPrinters", other);

            const isOwner = currentUser?.role === "owner";

            grid.innerHTML = cachedPrinters.map((p) => {
                const taskLine = p.current_task_id
                    ? `<div class="printer-task-info">
                           <div class="printer-task-label">${escapeHtml(t("currentTask"))}</div>
                           <div class="printer-task-name">${escapeHtml(resolveTaskName(p.current_task_id))}</div>
                       </div>`
                    : "";

                const actions = isOwner
                    ? `<div class="printer-actions">
                           <button class="printer-action-btn edit" onclick="openEditPrinterModal(${p.id})">${escapeHtml(t("btnEdit"))}</button>
                           <button class="printer-action-btn delete" onclick="confirmDelete('printer', ${p.id}, '${escapeHtml(p.name)}')">${escapeHtml(t("btnDelete"))}</button>
                       </div>`
                    : "";

                return `
                    <div class="card" data-id="${p.id}">
                        <div class="card-title">
                            <span>${escapeHtml(p.name)}</span>
                            <span class="color-indicator ${escapeHtml(p.status || "idle")}"></span>
                        </div>
                        <div class="model-text">${escapeHtml(p.model || "")}</div>
                        <div class="status-row">
                            <span>${escapeHtml(t("printerStatus"))}:</span>
                            <span class="status-text ${escapeHtml(p.status || "idle")}">${escapeHtml(getStatusLabel(p.status))}</span>
                        </div>
                        ${taskLine}
                        ${actions}
                    </div>
                `;
            }).join("");
        }

        function openAddPrinterModal() {
            document.getElementById("editPrinterId").value = "";
            document.getElementById("printerName").value = "";
            document.getElementById("printerModel").value = "";
            document.getElementById("printerImage").value = "";
            hide("printerStatusGroup");

            setText("addPrinterTitle", t("addPrinterTitle"));
            openModal("addPrinterModal");
        }

        function openEditPrinterModal(id) {
            const p = cachedPrinters.find((x) => x.id === id);
            if (!p) return;

            document.getElementById("editPrinterId").value = String(id);
            document.getElementById("printerName").value = p.name || "";
            document.getElementById("printerModel").value = p.model || "";
            document.getElementById("printerImage").value = p.image_url || "";
            const st = document.getElementById("printerStatus");
            if (st) st.value = p.status || "idle";
            show("printerStatusGroup");

            setText("addPrinterTitle", t("editPrinterTitle"));
            openModal("addPrinterModal");
        }

        async function savePrinter() {
            try {
                const id = document.getElementById("editPrinterId").value.trim();
                const name = document.getElementById("printerName").value.trim();
                const model = document.getElementById("printerModel").value.trim();
                const image_url = document.getElementById("printerImage").value.trim();
                const status = (document.getElementById("printerStatus")?.value || "idle").trim();

                if (!name) {
                    toast("warning", t("printerName") + " *");
                    return;
                }

                setLoading(true);

                if (!id) {
                    await PrintFarmApi.addPrinter({ name, model, image_url });
                } else {
                    await PrintFarmApi.updatePrinter(parseInt(id, 10), { name, model, image_url, status });
                }

                closeModal("addPrinterModal");
                await loadPrinters();
                toast("success", "toastSaved");
            } catch (e) {
                toast("error", e?.message || t("toastError"));
            } finally {
                setLoading(false);
            }
        }

        // ─────────────────────────────────────────────────────────────────────
        // Products (owner only)
        // ─────────────────────────────────────────────────────────────────────
        async function loadProducts() {
            if (currentUser?.role !== "owner") return;
            try {
                setLoading(true);
                cachedProducts = await PrintFarmApi.getAllProducts(true);
                renderProducts();
            } catch (e) {
                toast("error", e?.message || t("toastError"));
            } finally {
                setLoading(false);
            }
        }

        function renderProducts() {
            const grid = document.getElementById("productsGrid");
            const empty = document.getElementById("productsEmpty");
            if (!grid || !empty) return;

            if (!cachedProducts || cachedProducts.length === 0) {
                grid.innerHTML = "";
                empty.classList.remove("hidden");
                return;
            }
            empty.classList.add("hidden");

            grid.innerHTML = cachedProducts.map((p) => {
                let variants = p.variants;
                if (typeof variants === "string") {
                    try { variants = JSON.parse(variants || "[]"); } catch { variants = []; }
                }
                if (!Array.isArray(variants)) variants = [];

                const vHtml = variants.slice(0, 3).map((v) => {
                    const vName = v?.name || "";
                    const vQty = v?.quantity ?? 1;
                    const vTime = v?.print_time_minutes ?? 60;
                    return `
                        <div class="variant-item">
                            <span class="variant-name">${escapeHtml(vName)}</span>
                            <span class="variant-details">
                                <span>x${escapeHtml(vQty)}</span>
                                <span>${escapeHtml(vTime)} ${escapeHtml(t("variantTime").includes("мин") ? "мин" : "min")}</span>
                            </span>
                        </div>
                    `;
                }).join("");

                return `
                    <div class="product-card" data-id="${p.id}">
                        <div class="product-name">${escapeHtml(p.name)}</div>
                        <div class="product-description">${escapeHtml(p.description || "")}</div>
                        <div class="variant-list">${vHtml || `<div class="model-text">${escapeHtml(t("variants"))}: 0</div>`}</div>
                        <div class="product-actions">
                            <button class="product-action-btn edit" onclick="openEditProductModal(${p.id})">${escapeHtml(t("btnEdit"))}</button>
                            <button class="product-action-btn delete" onclick="confirmDelete('product', ${p.id}, '${escapeHtml(p.name)}')">${escapeHtml(t("btnDelete"))}</button>
                        </div>
                    </div>
                `;
            }).join("");
        }

        function openAddProductModal() {
            document.getElementById("editProductId").value = "";
            document.getElementById("productName").value = "";
            document.getElementById("productDescription").value = "";
            document.getElementById("variantsList").innerHTML = "";

            // start with 1 variant row
            addVariantRow();

            setText("addProductTitle", t("addProductTitle"));
            openModal("addProductModal");
        }

        function openEditProductModal(id) {
            const p = cachedProducts.find((x) => x.id === id);
            if (!p) return;

            document.getElementById("editProductId").value = String(id);
            document.getElementById("productName").value = p.name || "";
            document.getElementById("productDescription").value = p.description || "";

            let variants = p.variants;
            if (typeof variants === "string") {
                try { variants = JSON.parse(variants || "[]"); } catch { variants = []; }
            }
            if (!Array.isArray(variants)) variants = [];

            const list = document.getElementById("variantsList");
            list.innerHTML = "";
            variants.forEach((v) => addVariantRow(v));
            if (variants.length === 0) addVariantRow();

            setText("addProductTitle", t("editProductTitle"));
            openModal("addProductModal");
        }

        function addVariantRow(v = null) {
            const list = document.getElementById("variantsList");
            if (!list) return;

            const row = document.createElement("div");
            row.className = "variant-editor-item";

            const name = document.createElement("input");
            name.type = "text";
            name.placeholder = t("variantName");
            name.value = v?.name || "";

            const qty = document.createElement("input");
            qty.type = "number";
            qty.min = "1";
            qty.placeholder = t("variantQty");
            qty.value = String(v?.quantity ?? 1);

            const time = document.createElement("input");
            time.type = "number";
            time.min = "1";
            time.placeholder = t("variantTime");
            time.value = String(v?.print_time_minutes ?? 60);

            const remove = document.createElement("button");
            remove.className = "variant-remove-btn";
            remove.type = "button";
            remove.innerHTML = `
                <span class="icon icon-sm">
                    <svg viewBox="0 0 24 24">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </span>
            `;
            remove.addEventListener("click", () => row.remove());

            row.appendChild(name);
            row.appendChild(qty);
            row.appendChild(time);
            row.appendChild(remove);

            list.appendChild(row);
        }

        function collectVariantsFromModal() {
            const list = document.getElementById("variantsList");
            if (!list) return [];

            const rows = Array.from(list.querySelectorAll(".variant-editor-item"));
            const variants = [];

            rows.forEach((row) => {
                const inputs = row.querySelectorAll("input");
                const vName = (inputs[0]?.value || "").trim();
                const vQty = parseInt(inputs[1]?.value || "1", 10);
                const vTime = parseInt(inputs[2]?.value || "60", 10);

                if (!vName) return;
                variants.push({
                    name: vName,
                    quantity: Number.isFinite(vQty) && vQty > 0 ? vQty : 1,
                    print_time_minutes: Number.isFinite(vTime) && vTime > 0 ? vTime : 60
                });
            });

            return variants;
        }

        async function saveProduct() {
            try {
                const id = document.getElementById("editProductId").value.trim();
                const name = document.getElementById("productName").value.trim();
                const description = document.getElementById("productDescription").value.trim();
                const variants = collectVariantsFromModal();

                if (!name) {
                    toast("warning", t("productName") + " *");
                    return;
                }

                setLoading(true);

                if (!id) {
                    await PrintFarmApi.addProduct({ name, description, variants });
                } else {
                    await PrintFarmApi.updateProduct(parseInt(id, 10), { name, description, variants });
                }

                closeModal("addProductModal");
                await loadProducts();
                toast("success", "toastSaved");
            } catch (e) {
                toast("error", e?.message || t("toastError"));
            } finally {
                setLoading(false);
            }
        }

        // ─────────────────────────────────────────────────────────────────────
        // Tasks
        // ─────────────────────────────────────────────────────────────────────
        async function loadTasks() {
            try {
                setLoading(true);
                cachedTasks = await PrintFarmApi.getAllTasks(true);
                renderTasks();
                updateTaskStats();
            } catch (e) {
                toast("error", e?.message || t("toastError"));
            } finally {
                setLoading(false);
            }
        }

        function updateTaskStats() {
            const total = cachedTasks.length;
            const pending = cachedTasks.filter(t => t.status === "pending").length;
            const inProgress = cachedTasks.filter(t => t.status === "in_progress").length;
            const done = cachedTasks.filter(t => t.status === "done").length;

            setText("statTotalTasks", total);
            setText("statPendingTasks", pending);
            setText("statInProgressTasks", inProgress);
            setText("statDoneTasks", done);

            // badge
            const badge = document.getElementById("tasksBadge");
            if (badge) {
                const active = pending + inProgress;
                badge.textContent = String(active);
                badge.classList.toggle("hidden", active <= 0);
            }
        }

        function renderTasks() {
            const listEl = document.getElementById("tasksList");
            const empty = document.getElementById("tasksEmpty");
            if (!listEl || !empty) return;

            if (!cachedTasks || cachedTasks.length === 0) {
                listEl.innerHTML = "";
                empty.classList.remove("hidden");
                return;
            }
            empty.classList.add("hidden");

            const statusOrder = { pending: 0, in_progress: 1, done: 2, skipped: 3, canceled: 4 };
            let items = [...cachedTasks].sort((a, b) => (statusOrder[a.status] ?? 99) - (statusOrder[b.status] ?? 99));

            // filter
            if (currentFilter === "day" || currentFilter === "night") {
                items = items.filter((x) => x.slot === currentFilter);
            } else if (currentFilter !== "all") {
                items = items.filter((x) => x.status === currentFilter);
            }

            const isOwner = currentUser?.role === "owner";

            listEl.innerHTML = items.map((tItem) => {
                const slot = tItem.slot || "day";
                const status = tItem.status || "pending";

                const timeLine = tItem.planned_start_time
                    ? `<div class="task-time">
                           <span class="icon icon-sm">
                               <svg viewBox="0 0 24 24">
                                   <circle cx="12" cy="12" r="10"></circle>
                                   <polyline points="12 6 12 12 16 14"></polyline>
                               </svg>
                           </span>
                           ${escapeHtml(formatTime(tItem.planned_start_time))} - ${escapeHtml(formatTime(tItem.planned_end_time))}
                       </div>`
                    : "";

                const btnStart = status === "pending"
                    ? `<button class="task-btn start-btn" onclick="startTask(${tItem.id})">${escapeHtml(t("btnStart"))}</button>`
                    : "";

                const btnComplete = status === "in_progress"
                    ? `<button class="task-btn complete-btn" onclick="completeTask(${tItem.id})">${escapeHtml(t("btnComplete"))}</button>`
                    : "";

                const btnDelete = (isOwner && status !== "done")
                    ? `<button class="task-btn delete-btn" onclick="confirmDelete('task', ${tItem.id}, '${escapeHtml(tItem.product_name || "")}')">${escapeHtml(t("btnDelete"))}</button>`
                    : "";

                return `
                    <div class="task-item ${escapeHtml(status)}" data-id="${tItem.id}">
                        <div class="task-header">
                            <span class="task-slot ${escapeHtml(slot)}">${escapeHtml(getSlotLabel(slot))}</span>
                            <span class="task-name">${escapeHtml(tItem.product_name || "")}</span>
                            <span class="task-status">${escapeHtml(getTaskStatusLabel(status))}</span>
                        </div>
                        <div class="task-details">
                            <div class="task-detail">
                                <span class="task-label">${escapeHtml(t("taskQty"))}</span>
                                <span class="task-value">${escapeHtml(tItem.quantity ?? 1)}</span>
                            </div>
                            <div class="task-detail">
                                <span class="task-label">${escapeHtml(t("taskPrinter"))}</span>
                                <span class="task-value">${tItem.printer_id ? "#" + escapeHtml(tItem.printer_id) : "-"}</span>
                            </div>
                        </div>
                        ${timeLine}
                        <div class="task-actions">
                            ${btnStart}
                            ${btnComplete}
                            ${btnDelete}
                        </div>
                    </div>
                `;
            }).join("");
        }

        async function startTask(id) {
            try {
                setLoading(true);
                await PrintFarmApi.startTask(id);
                toast("success", "toastStarted");
                await loadTasks();
                await loadPrinters();
            } catch (e) {
                toast("error", e?.message || t("toastError"));
            } finally {
                setLoading(false);
            }
        }

        async function completeTask(id) {
            try {
                setLoading(true);
                await PrintFarmApi.completeTask(id);
                toast("success", "toastCompleted");
                await loadTasks();
                await loadPrinters();
            } catch (e) {
                toast("error", e?.message || t("toastError"));
            } finally {
                setLoading(false);
            }
        }

        // ─────────────────────────────────────────────────────────────────────
        // Import / Algorithm
        // ─────────────────────────────────────────────────────────────────────
        async function importFromSheets() {
            openModal("importModal");

            hide("importResults");
            hide("importError");
            show("importLoading");

            const btn = document.getElementById("generateFromImportBtn");
            if (btn) btn.disabled = true;

            try {
                const result = await PrintFarmApi.importFromGoogleSheets();
                importedOrders = result?.orders || [];

                const preview = document.getElementById("ordersPreview");
                const countEl = document.getElementById("importCount");

                if (countEl) countEl.textContent = String(importedOrders.length);

                if (preview) {
                    preview.innerHTML = importedOrders.slice(0, 50).map((o) => {
                        return `<div class="order-row" style="display:flex;justify-content:space-between;padding:10px;background:#333;border-radius:8px;margin-bottom:8px;">
                                    <span>${escapeHtml(o.name)}</span>
                                    <span style="color:#4caf50;font-weight:700;">x${escapeHtml(o.quantity)}</span>
                                </div>`;
                    }).join("");
                }

                hide("importLoading");
                show("importResults");

                if (btn) btn.disabled = importedOrders.length === 0;

                toast("success", "toastImported", { count: importedOrders.length });
            } catch (e) {
                hide("importLoading");
                hide("importResults");
                show("importError");

                const err = document.getElementById("importErrorText");
                if (err) err.textContent = e?.message || t("importError");
            }
        }

        async function confirmImport() {
            closeModal("importModal");
            if (!importedOrders.length) return;

            try {
                setLoading(true);
                const result = await PrintFarmApi.generateTasksWithAlgorithm(importedOrders);

                // Show summary modal
                renderSummary(result?.summary);
                openModal("summaryModal");

                toast("success", "toastGenerated", { count: result?.summary?.tasks_created ?? 0 });

                // Refresh tasks
                await loadTasks();
            } catch (e) {
                toast("error", e?.message || t("toastError"));
            } finally {
                setLoading(false);
            }
        }

        function renderSummary(summary) {
            const grid = document.getElementById("summaryGrid");
            const warningsEl = document.getElementById("summaryWarnings");
            if (!grid || !warningsEl) return;

            const s = summary || {};
            grid.innerHTML = `
                <div class="summary-item"><span>${escapeHtml(t("summaryCreated"))}</span><strong>${escapeHtml(s.tasks_created ?? 0)}</strong></div>
                <div class="summary-item"><span>${escapeHtml(t("summaryPrinters"))}</span><strong>${escapeHtml(s.printers_used ?? 0)}</strong></div>
                <div class="summary-item"><span>${escapeHtml(t("summaryOrdered"))}</span><strong>${escapeHtml(s.total_ordered ?? 0)}</strong></div>
                <div class="summary-item"><span>${escapeHtml(t("summaryPlanned"))}</span><strong>${escapeHtml(s.total_planned ?? 0)}</strong></div>
                <div class="summary-item"><span>${escapeHtml(t("summarySurplus"))}</span><strong>${escapeHtml(s.surplus ?? 0)}</strong></div>
            `;

            const warnings = Array.isArray(s.warnings) ? s.warnings : [];
            if (!warnings.length) {
                warningsEl.classList.add("hidden");
                warningsEl.innerHTML = "";
                return;
            }

            warningsEl.classList.remove("hidden");
            warningsEl.innerHTML = warnings.map((w) => `<div class="warning-row">${escapeHtml(w)}</div>`).join("");
        }

        // ─────────────────────────────────────────────────────────────────────
        // Settings (owner only)
        // ─────────────────────────────────────────────────────────────────────
        async function loadSettings() {
            if (currentUser?.role !== "owner") return;

            try {
                setLoading(true);
                cachedSettings = await PrintFarmApi.getSettings(true);
                cachedTeamMembers = await PrintFarmApi.getTeamMembers(true);
                renderSettings();
            } catch (e) {
                toast("error", e?.message || t("toastError"));
            } finally {
                setLoading(false);
            }
        }

        function renderSettings() {
            if (currentUser?.role !== "owner") return;

            // inputs
            const s = cachedSettings || {};
            const setVal = (id, v) => {
                const el = document.getElementById(id);
                if (el) el.value = v ?? "";
            };
            const setChk = (id, v) => {
                const el = document.getElementById(id);
                if (el) el.checked = !!v;
            };

            setVal("settingWorkStart", s.work_start_hour ?? 9);
            setVal("settingWorkEnd", s.work_end_hour ?? 18);
            setVal("settingDeadline", s.deadline_hour ?? 20);
            setVal("settingChangeover", s.changeover_minutes ?? 15);
            setChk("settingUseNight", s.use_night ?? true);
            setChk("settingMinimizePrinters", s.minimize_printers ?? false);

            setVal("settingSheetId", s.sheet_id ?? "");
            setVal("settingSheetName", s.sheet_name ?? "Sheet1");
            setVal("settingNameColumn", s.name_column ?? "A");
            setVal("settingQtyColumn", s.qty_column ?? "B");

            // team code
            const codeValue = document.getElementById("teamCodeValue");
            if (codeValue) {
                const code = currentUser?.team_code || "";
                codeValue.textContent = code || t("settingsNoCode");
                codeValue.classList.toggle("empty", !code);
            }

            // members
            const list = document.getElementById("teamMembersList");
            const empty = document.getElementById("teamEmpty");
            if (list && empty) {
                if (!cachedTeamMembers || cachedTeamMembers.length === 0) {
                    list.innerHTML = "";
                    empty.classList.remove("hidden");
                } else {
                    empty.classList.add("hidden");
                    list.innerHTML = cachedTeamMembers.map((m) => {
                        const name = m.first_name || "User";
                        const uname = m.username ? "@" + m.username : "";
                        return `
                            <div class="team-member">
                                <div class="team-member-avatar">${escapeHtml(name[0]?.toUpperCase() || "U")}</div>
                                <div class="team-member-info">
                                    <div class="team-member-name">${escapeHtml(name)}</div>
                                    <div class="team-member-username">${escapeHtml(uname)}</div>
                                </div>
                                <button class="team-member-remove" onclick="confirmRemoveMember(${m.id}, '${escapeHtml(name)}')">
                                    <span class="icon icon-sm">
                                        <svg viewBox="0 0 24 24">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </span>
                                </button>
                            </div>
                        `;
                    }).join("");
                }
            }
        }

        async function saveSettings() {
            try {
                setLoading(true);

                const payload = {
                    work_start_hour: parseInt(document.getElementById("settingWorkStart")?.value || "9", 10),
                    work_end_hour: parseInt(document.getElementById("settingWorkEnd")?.value || "18", 10),
                    deadline_hour: parseInt(document.getElementById("settingDeadline")?.value || "20", 10),
                    changeover_minutes: parseInt(document.getElementById("settingChangeover")?.value || "15", 10),
                    use_night: !!document.getElementById("settingUseNight")?.checked,
                    minimize_printers: !!document.getElementById("settingMinimizePrinters")?.checked,
                    sheet_id: (document.getElementById("settingSheetId")?.value || "").trim(),
                    sheet_name: (document.getElementById("settingSheetName")?.value || "Sheet1").trim(),
                    name_column: (document.getElementById("settingNameColumn")?.value || "A").trim(),
                    qty_column: (document.getElementById("settingQtyColumn")?.value || "B").trim()
                };

                cachedSettings = await PrintFarmApi.saveSettings(payload);
                toast("success", "toastSaved");

                // refresh to keep everything consistent
                await loadSettings();
            } catch (e) {
                toast("error", e?.message || t("toastError"));
            } finally {
                setLoading(false);
            }
        }

        async function generateNewTeamCode() {
            try {
                setLoading(true);
                const res = await PrintFarmApi.generateTeamCode();
                // update currentUser
                currentUser.team_code = res.team_code;
                renderSettings();
                toast("success", "toastCodeGenerated");
            } catch (e) {
                toast("error", e?.message || t("toastError"));
            } finally {
                setLoading(false);
            }
        }

        function copyTeamCode() {
            const code = currentUser?.team_code || "";
            if (!code) return;
            navigator.clipboard.writeText(code).then(() => {
                toast("success", "toastCodeCopied");
            }).catch(() => {
                toast("error", "toastError");
            });
        }

        function confirmRemoveMember(memberId, name) {
            pendingConfirm = { type: "remove_member", id: memberId, extra: { name } };
            const txt = t("confirmRemoveMember", { name });
            const p = document.getElementById("confirmText");
            if (p) p.textContent = txt;
            openModal("confirmModal");
        }

        async function removeTeamMember() {
            if (!pendingConfirm || pendingConfirm.type !== "remove_member") return;
            try {
                setLoading(true);
                await PrintFarmApi.removeTeamMember(pendingConfirm.id);
                toast("success", "toastDeleted");
                closeModal("confirmModal");
                pendingConfirm = null;
                await loadSettings();
            } catch (e) {
                toast("error", e?.message || t("toastError"));
            } finally {
                setLoading(false);
            }
        }

        async function clearAllTasks() {
            pendingConfirm = { type: "clear_tasks" };
            const p = document.getElementById("confirmText");
            if (p) p.textContent = t("confirmClearTasks");
            openModal("confirmModal");
        }

        async function doClearAllTasks() {
            try {
                setLoading(true);
                await PrintFarmApi.clearAllTasks();
                importedOrders = [];
                toast("success", "toastCleared");
                closeModal("confirmModal");
                pendingConfirm = null;
                await loadTasks();
            } catch (e) {
                toast("error", e?.message || t("toastError"));
            } finally {
                setLoading(false);
            }
        }

        // ─────────────────────────────────────────────────────────────────────
        // Confirm / delete handling
        // ─────────────────────────────────────────────────────────────────────
        function confirmDelete(type, id, name) {
            pendingConfirm = { type, id, extra: { name } };

            const p = document.getElementById("confirmText");
            if (!p) return;

            if (type === "printer") p.textContent = t("confirmDeletePrinter", { name });
            else if (type === "product") p.textContent = t("confirmDeleteProduct", { name });
            else if (type === "task") p.textContent = t("confirmDeleteTask");
            else p.textContent = t("confirmTitle");

            openModal("confirmModal");
        }

        async function executeConfirm() {
            if (!pendingConfirm) return;

            if (pendingConfirm.type === "remove_member") {
                await removeTeamMember();
                return;
            }
            if (pendingConfirm.type === "clear_tasks") {
                await doClearAllTasks();
                return;
            }

            const type = pendingConfirm.type;
            const id = pendingConfirm.id;

            try {
                setLoading(true);
                if (type === "printer") {
                    await PrintFarmApi.removePrinter(id);
                    toast("success", "toastDeleted");
                    closeModal("confirmModal");
                    pendingConfirm = null;
                    await loadPrinters();
                    return;
                }
                if (type === "product") {
                    await PrintFarmApi.removeProduct(id);
                    toast("success", "toastDeleted");
                    closeModal("confirmModal");
                    pendingConfirm = null;
                    await loadProducts();
                    return;
                }
                if (type === "task") {
                    await PrintFarmApi.deleteTask(id);
                    toast("success", "toastDeleted");
                    closeModal("confirmModal");
                    pendingConfirm = null;
                    await loadTasks();
                    return;
                }
            } catch (e) {
                toast("error", e?.message || t("toastError"));
            } finally {
                setLoading(false);
            }
        }

        // ─────────────────────────────────────────────────────────────────────
        // Bind buttons
        // ─────────────────────────────────────────────────────────────────────
        function bindButtons() {
            // Printers
            const addPrinterBtn = document.getElementById("addPrinterBtn");
            if (addPrinterBtn) addPrinterBtn.addEventListener("click", openAddPrinterModal);

            // Products
            const addProductBtn = document.getElementById("addProductBtn");
            if (addProductBtn) addProductBtn.addEventListener("click", openAddProductModal);

            // Tasks
            const importBtn = document.getElementById("importBtn");
            const generateBtn = document.getElementById("generateBtn");
            if (importBtn) importBtn.addEventListener("click", importFromSheets);
            if (generateBtn) generateBtn.addEventListener("click", () => {
                // If already imported, open import modal (preview) OR generate directly
                if (!importedOrders.length) {
                    importFromSheets();
                } else {
                    confirmImport();
                }
            });

            // Settings buttons
            const saveSettingsBtn = document.getElementById("saveSettingsBtn");
            if (saveSettingsBtn) saveSettingsBtn.addEventListener("click", saveSettings);

            const genCodeBtn = document.getElementById("generateTeamCodeBtn");
            if (genCodeBtn) genCodeBtn.addEventListener("click", generateNewTeamCode);

            const copyCodeBtn = document.getElementById("copyTeamCodeBtn");
            if (copyCodeBtn) copyCodeBtn.addEventListener("click", copyTeamCode);

            const clearTasksBtn = document.getElementById("clearAllTasksBtn");
            if (clearTasksBtn) clearTasksBtn.addEventListener("click", clearAllTasks);

            // Help
            const helpBtn = document.getElementById("helpBtn");
            if (helpBtn) helpBtn.addEventListener("click", openHelpModal);

            // Confirm modal buttons
            const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
            if (confirmDeleteBtn) confirmDeleteBtn.addEventListener("click", executeConfirm);
        }


        // ─────────────────────────────────────────────────────────────────────
        // Fallback local API (for standalone testing when /data.js is missing)
        // ─────────────────────────────────────────────────────────────────────
        (function installLocalPrintFarmApi() {
            if (window.PrintFarmApi) return;

            const PREFIX = "pf_local_v1_";

            const safeJsonParse = (raw, fallback) => {
                try {
                    return raw == null ? fallback : JSON.parse(raw);
                } catch (e) {
                    return fallback;
                }
            };

            const readStore = (key, fallback) => safeJsonParse(localStorage.getItem(PREFIX + key), fallback);
            const writeStore = (key, value) => localStorage.setItem(PREFIX + key, JSON.stringify(value));

            const nextId = (key) => {
                const cur = Number(readStore(key, 0) || 0);
                const n = cur + 1;
                writeStore(key, n);
                return n;
            };

            const nowIso = () => new Date().toISOString();

            const randomCode = () => Math.random().toString(36).slice(2, 10).toUpperCase();

            const ensureUser = () => {
                let u = readStore("user", null);
                if (u) return u;

                const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
                u = {
                    id: tgUser?.id || 1,
                    first_name: tgUser?.first_name || "Local",
                    username: tgUser?.username || "",
                    role: "owner",
                    language: "ru",
                    team_code: randomCode()
                };
                writeStore("user", u);
                return u;
            };

            const getPrinters = () => readStore("printers", []);
            const setPrinters = (arr) => writeStore("printers", Array.isArray(arr) ? arr : []);

            const getProducts = () => readStore("products", []);
            const setProducts = (arr) => writeStore("products", Array.isArray(arr) ? arr : []);

            const getTasks = () => readStore("tasks", []);
            const setTasks = (arr) => writeStore("tasks", Array.isArray(arr) ? arr : []);

            const getSettingsLocal = () => readStore("settings", null);
            const setSettingsLocal = (s) => writeStore("settings", s);

            const getTeamMembersLocal = () => readStore("team_members", []);
            const setTeamMembersLocal = (arr) => writeStore("team_members", Array.isArray(arr) ? arr : []);

            const normalizePrinterLinks = () => {
                const printers = getPrinters();
                const tasks = getTasks();

                const byPrinter = new Map();
                tasks.forEach((t) => {
                    if (!t.printer_id) return;
                    if (!byPrinter.has(t.printer_id)) byPrinter.set(t.printer_id, []);
                    byPrinter.get(t.printer_id).push(t);
                });

                printers.forEach((p) => {
                    const list = byPrinter.get(p.id) || [];
                    const active = list.find((x) => x.status === "in_progress") || null;
                    p.current_task_id = active ? active.id : null;
                    p.status = active ? "printing" : (p.status === "maintenance" ? "maintenance" : "idle");
                });

                setPrinters(printers);
            };

            // ---- API Methods ----
            const api = {
                async initApp() {
                    // mimic backend init
                    const u = ensureUser();
                    normalizePrinterLinks();
                    return u;
                },

                async getAllPrinters() {
                    normalizePrinterLinks();
                    return getPrinters();
                },

                async addPrinter(payload) {
                    const printers = getPrinters();
                    const id = nextId("printer_id_seq");
                    const printer = {
                        id,
                        name: (payload?.name || "Printer " + id).trim(),
                        model: (payload?.model || "").trim(),
                        image_url: (payload?.image_url || "").trim(),
                        status: "idle",
                        current_task_id: null
                    };
                    printers.push(printer);
                    setPrinters(printers);
                    return printer;
                },

                async updatePrinter(id, payload) {
                    const printers = getPrinters();
                    const p = printers.find((x) => x.id === id);
                    if (!p) throw new Error("Printer not found");

                    if (payload?.name != null) p.name = String(payload.name).trim();
                    if (payload?.model != null) p.model = String(payload.model).trim();
                    if (payload?.image_url != null) p.image_url = String(payload.image_url).trim();
                    if (payload?.status != null) p.status = String(payload.status);

                    setPrinters(printers);
                    return p;
                },

                async removePrinter(id) {
                    // remove printer + detach tasks
                    const printers = getPrinters().filter((x) => x.id !== id);
                    const tasks = getTasks().map((t) => {
                        if (t.printer_id === id) {
                            return { ...t, printer_id: null, status: t.status === "in_progress" ? "pending" : t.status };
                        }
                        return t;
                    });
                    setPrinters(printers);
                    setTasks(tasks);
                    return { ok: true };
                },

                async getAllProducts() {
                    return getProducts();
                },

                async addProduct(payload) {
                    const products = getProducts();
                    const id = nextId("product_id_seq");
                    const product = {
                        id,
                        name: (payload?.name || "Product " + id).trim(),
                        description: (payload?.description || "").trim(),
                        variants: Array.isArray(payload?.variants) ? payload.variants : []
                    };
                    products.push(product);
                    setProducts(products);
                    return product;
                },

                async updateProduct(id, payload) {
                    const products = getProducts();
                    const p = products.find((x) => x.id === id);
                    if (!p) throw new Error("Product not found");

                    if (payload?.name != null) p.name = String(payload.name).trim();
                    if (payload?.description != null) p.description = String(payload.description).trim();
                    if (payload?.variants != null) p.variants = Array.isArray(payload.variants) ? payload.variants : [];

                    setProducts(products);
                    return p;
                },

                async removeProduct(id) {
                    const products = getProducts().filter((x) => x.id !== id);
                    setProducts(products);
                    return { ok: true };
                },

                async getAllTasks() {
                    return getTasks();
                },

                async startTask(id) {
                    const tasks = getTasks();
                    const printers = getPrinters();

                    const t = tasks.find((x) => x.id === id);
                    if (!t) throw new Error("Task not found");

                    if (t.status !== "pending") return t;

                    // assign first available printer if missing
                    if (!t.printer_id) {
                        const idle = printers.find((p) => p.status === "idle") || printers[0] || null;
                        if (idle) t.printer_id = idle.id;
                    }

                    t.status = "in_progress";
                    t.started_at = nowIso();

                    if (t.printer_id) {
                        const p = printers.find((x) => x.id === t.printer_id);
                        if (p) {
                            p.status = "printing";
                            p.current_task_id = t.id;
                        }
                        setPrinters(printers);
                    }

                    setTasks(tasks);
                    return t;
                },

                async completeTask(id) {
                    const tasks = getTasks();
                    const printers = getPrinters();

                    const t = tasks.find((x) => x.id === id);
                    if (!t) throw new Error("Task not found");

                    t.status = "done";
                    t.completed_at = nowIso();

                    if (t.printer_id) {
                        const p = printers.find((x) => x.id === t.printer_id);
                        if (p && p.current_task_id === t.id) {
                            p.current_task_id = null;
                            p.status = "idle";
                        }
                        setPrinters(printers);
                    }

                    setTasks(tasks);
                    return t;
                },

                async deleteTask(id) {
                    const tasks = getTasks();
                    const printers = getPrinters();

                    const target = tasks.find((x) => x.id === id) || null;

                    const nextTasks = tasks.filter((x) => x.id !== id);
                    setTasks(nextTasks);

                    if (target?.printer_id) {
                        const p = printers.find((x) => x.id === target.printer_id);
                        if (p && p.current_task_id === id) {
                            p.current_task_id = null;
                            p.status = "idle";
                        }
                        setPrinters(printers);
                    }

                    return { ok: true };
                },

                async clearAllTasks() {
                    setTasks([]);
                    const printers = getPrinters();
                    printers.forEach((p) => {
                        if (p.status !== "maintenance") p.status = "idle";
                        p.current_task_id = null;
                    });
                    setPrinters(printers);
                    return { ok: true };
                },

                async importFromGoogleSheets() {
                    const products = getProducts();
                    const fallbackNames = products.length ? products.map((p) => p.name) : ["Sample Order A", "Sample Order B", "Sample Order C"];

                    const orders = fallbackNames.slice(0, 10).map((name, i) => ({
                        name,
                        quantity: (i % 3) + 1
                    }));

                    return { orders };
                },

                async generateTasksWithAlgorithm(orders) {
                    const tasks = getTasks();
                    const printers = getPrinters();

                    const startId = readStore("task_id_seq", 0);

                    const created = [];
                    let printerIndex = 0;

                    const ordered = Array.isArray(orders) ? orders : [];
                    ordered.forEach((o) => {
                        const id = nextId("task_id_seq");
                        const printer = printers.length ? printers[printerIndex % printers.length] : null;
                        printerIndex++;

                        const task = {
                            id,
                            product_name: String(o?.name || "Order " + id),
                            quantity: Number(o?.quantity || 1),
                            printer_id: printer ? printer.id : null,
                            slot: "day",
                            status: "pending",
                            planned_start_time: null,
                            planned_end_time: null,
                            created_at: nowIso()
                        };
                        created.push(task);
                        tasks.push(task);
                    });

                    setTasks(tasks);
                    normalizePrinterLinks();

                    const summary = {
                        tasks_created: created.length,
                        printers_used: printers.length ? Math.min(printers.length, created.length) : 0,
                        total_ordered: ordered.reduce((a, b) => a + Number(b?.quantity || 0), 0),
                        total_planned: ordered.reduce((a, b) => a + Number(b?.quantity || 0), 0),
                        surplus: 0,
                        warnings: printers.length ? [] : ["Нет доступных принтеров — задачи созданы без назначения принтера."]
                    };

                    return { summary };
                },

                async getSettings() {
                    const s = getSettingsLocal();
                    if (s) return s;

                    const defaults = {
                        work_start_hour: 9,
                        work_end_hour: 18,
                        deadline_hour: 20,
                        changeover_minutes: 15,
                        use_night: false,
                        minimize_printers: true,
                        sheet_id: "",
                        sheet_name: "Sheet1",
                        name_column: "A",
                        qty_column: "B"
                    };
                    setSettingsLocal(defaults);
                    return defaults;
                },

                async saveSettings(payload) {
                    const next = { ...(await api.getSettings()), ...(payload || {}) };
                    setSettingsLocal(next);
                    return next;
                },

                async generateTeamCode() {
                    const u = ensureUser();
                    u.team_code = randomCode();
                    writeStore("user", u);
                    return { team_code: u.team_code };
                },

                async getTeamMembers() {
                    return getTeamMembersLocal();
                },

                async removeTeamMember(memberId) {
                    const list = getTeamMembersLocal().filter((m) => m.id !== memberId);
                    setTeamMembersLocal(list);
                    return { ok: true };
                }
            };

            window.PrintFarmApi = api;
        })();

        // ─────────────────────────────────────────────────────────────────────
        // Init
        // ─────────────────────────────────────────────────────────────────────
        async function init() {
            try {
                setLoading(true);

                // Init Telegram + /api/me
                currentUser = await PrintFarmApi.initApp();

                // language from backend
                currentLang = currentUser?.language || "ru";

                // user badge
                const userName = document.getElementById("userName");
                const userRole = document.getElementById("userRole");
                if (userName) userName.textContent = currentUser?.first_name || "User";
                if (userRole) {
                    userRole.textContent = currentUser?.role === "worker" ? t("roleWorker") : t("roleOwner");
                    userRole.className = `user-role ${currentUser?.role || "owner"}`;
                }

                applyRoleVisibility();
                applyTranslations();

                bindNavigation();
                bindTaskFilters();
                bindButtons();
                bindLanguageSelector();
                bindHelp();

                // initial tab load
                switchTab("printers");
            } catch (e) {
                toast("error", e?.message || t("toastError"));
            } finally {
                setLoading(false);
            }
        }

        
        // ─────────────────────────────────────────────────────────────────────
        // Compatibility wrappers for older HTML onclick handlers
        // (HTML uses importOrders / generateTasks / generateTeamCode / hideSummary)
        // ─────────────────────────────────────────────────────────────────────
        function importOrders() {
            return importFromSheets();
        }

        async function generateTasks() {
            // If orders weren't imported yet — start import flow first
            if (!Array.isArray(importedOrders) || importedOrders.length === 0) {
                toast("warning", t("noTasksDesc"));
                await importFromSheets();
                return;
            }

            // Run generation with already imported orders
            await confirmImport();
        }

        function generateTeamCode() {
            return generateNewTeamCode();
        }

        function hideSummary() {
            // Hide in-page summary panel if it exists
            const panel = document.getElementById("algorithmSummary");
            if (panel) panel.classList.add("hidden");

            // Also close summary modal if it is open
            closeModal("summaryModal");
        }

// ─────────────────────────────────────────────────────────────────────
        // Expose some functions for inline onclick in existing HTML
        // ─────────────────────────────────────────────────────────────────────
        window.openAddPrinterModal = openAddPrinterModal;
        window.openEditPrinterModal = openEditPrinterModal;
        window.savePrinter = savePrinter;

        window.openAddProductModal = openAddProductModal;
        window.openEditProductModal = openEditProductModal;
        window.addVariantRow = addVariantRow;
        window.saveProduct = saveProduct;

        window.importFromSheets = importFromSheets;
        window.confirmImport = confirmImport;
        window.importOrders = importOrders;
        window.generateTasks = generateTasks;



        window.startTask = startTask;
        window.completeTask = completeTask;

        window.confirmDelete = confirmDelete;
        window.executeConfirm = executeConfirm;

        window.saveSettings = saveSettings;
        window.generateNewTeamCode = generateNewTeamCode;
        window.generateTeamCode = generateTeamCode;
        window.copyTeamCode = copyTeamCode;
        window.clearAllTasks = clearAllTasks;
        window.hideSummary = hideSummary;

        window.openHelpModal = openHelpModal;
        window.openLanguageModal = openLanguageModal;

        // close modal by backdrop click
        document.querySelectorAll(".modal-overlay").forEach((overlay) => {
            overlay.addEventListener("click", (e) => {
                if (e.target === overlay) overlay.classList.remove("active");
            });
        });

        // Start
                document.addEventListener("DOMContentLoaded", init);

        // ─────────────────────────────────────────────────────────────────────
        // Additional UX: keyboard / ESC / modal close + safe guards
        // ─────────────────────────────────────────────────────────────────────
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                // close top-most opened modal
                const opened = Array.from(document.querySelectorAll(".modal-overlay.active"));
                if (opened.length) {
                    opened[opened.length - 1].classList.remove("active");
                }
            }
        });

        // Prevent form submission reload on Enter inside inputs
        document.addEventListener("submit", (e) => e.preventDefault());

        // ─────────────────────────────────────────────────────────────────────
        // Telegram Theme sync (optional)
        // ─────────────────────────────────────────────────────────────────────
        (function syncTelegramTheme() {
            const tg = window.Telegram?.WebApp;
            if (!tg || !tg.themeParams) return;

            // If you want to map Telegram theme to your palette, do it here
            // Currently app uses its own dark palette; keep hook for future
            tg.onEvent?.("themeChanged", () => {
                // you can call applyThemeFromTelegram() if needed
            });
        })();

        // ─────────────────────────────────────────────────────────────────────
        // Robustness: global error handler
        // ─────────────────────────────────────────────────────────────────────
        window.addEventListener("unhandledrejection", (event) => {
            const msg = event?.reason?.message || event?.reason || "Unhandled error";
            toast("error", msg);
        });

        window.addEventListener("error", (event) => {
            const msg = event?.error?.message || event?.message || "Error";
            // Avoid duplicate toasts for common network noise
            toast("error", msg);
        });

        // ─────────────────────────────────────────────────────────────────────
        // Compatibility helpers for older inline HTML ids (if any)
        // ─────────────────────────────────────────────────────────────────────
        // Some earlier versions used these IDs; make them aliases if present:
        (function aliasOldIds() {
            // If your HTML already has these IDs, ignore.
            // If not, this function does nothing.
            const map = [
                ["btnOpenHelp", "helpBtn"],
                ["btnOpenLang", "openLanguageBtn"],
                ["btnSaveSettings", "saveSettingsBtn"],
                ["btnClearTasks", "clearAllTasksBtn"],
            ];
            map.forEach(([oldId, newId]) => {
                const oldEl = document.getElementById(oldId);
                const newEl = document.getElementById(newId);
                if (oldEl && !newEl) oldEl.id = newId;
            });
        })();

        // ─────────────────────────────────────────────────────────────────────
        // NOTE:
        // This script block ends here.
        // The HTML must close with:
        // </script></body></html>
        // ─────────────────────────────────────────────────────────────────────
    </script>
</body>
</html>
